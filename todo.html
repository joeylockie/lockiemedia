<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Todo List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script>
        // Apply theme on initial load
        function applyInitialTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyInitialTheme();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-item-clickable-area:hover {
            cursor: pointer;
        }
        .task-item:hover .delete-btn { opacity: 1; }
        .delete-btn { opacity: 0; transition: opacity 0.3s ease; }
        .completed-text { text-decoration: line-through; }
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 1.5rem; border-radius: 0.375rem; /* 6px */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            z-index: 200; display: none;
        }
        .sticky-sidebar {
            position: sticky; top: 2.5rem; /* 40px */ align-self: flex-start;
            max-height: calc(100vh - 5rem); /* 80px */
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .priority-badge, .label-badge {
            display: inline-block; padding: 0.15rem 0.5rem; font-size: 0.75rem; /* 12px */
            font-weight: 600; border-radius: 0.375rem; /* 6px */
            text-transform: capitalize;
        }
        .label-badge {
            background-color: #e0e7ff; /* Tailwind indigo-100 */
            color: #4338ca; /* Tailwind indigo-700 */
        }
        .dark .label-badge {
            background-color: #4f46e5; /* Tailwind indigo-600 */
            color: #e0e7ff; /* Tailwind indigo-200 */
        }
        .filter-btn, .sort-btn { min-height: 42px; }
        .view-details-heading {
            font-weight: 600;
            font-size: 0.95rem; /* Adjusted for slightly larger heading */
            color: #374151; /* Tailwind gray-700 */
        }
        .dark .view-details-heading {
            color: #d1d5db; /* Tailwind gray-300 */
        }
        .sidebar-minimized .sidebar-button-icon-only {
            justify-content: center;
        }
        .sidebar-minimized .sidebar-button-icon-only i {
            margin-right: 0 !important;
        }
        .sidebar-minimized .sidebar-text-content {
            display: none;
        }
        #iconTooltip {
            position: absolute;
            background-color: #1f2937; /* Tailwind gray-800 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* 6px */
            font-size: 0.875rem; /* 14px */
            z-index: 250;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .dark #iconTooltip {
            background-color: #374151; /* Tailwind gray-700 */
        }
        .sort-btn-active {
            background-color: #0ea5e9 !important; /* Tailwind sky-500 */
            color: white !important;
        }
        .dark .sort-btn-active {
             background-color: #0284c7 !important; /* Tailwind sky-600 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen flex flex-col items-center justify-start pt-8 sm:pt-10 p-2 sm:p-4 selection:bg-sky-400 selection:text-white dark:selection:bg-sky-600 dark:selection:text-white">

    <div id="messageBox" class="message-box"></div>
    <div id="iconTooltip"></div>

    <div id="addTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[150]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogAdd">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Add New Task</h3>
                <button id="closeAddModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="modalTodoFormAdd">
                <div>
                    <label for="modalTaskInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Task Description (e.g., 'Buy groceries for next Friday', 'Meeting on monday', 'Project due next month')</label>
                    <input type="text" id="modalTaskInputAdd" placeholder="Enter task description..." class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="modalDueDateInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Due Date (optional)</label>
                        <input type="date" id="modalDueDateInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="modalTimeInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time (optional)</label>
                        <input type="time" id="modalTimeInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="modalPriorityInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Priority</label>
                    <select id="modalPriorityInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="modalLabelInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Label (e.g., Work, Personal)</label>
                    <input type="text" id="modalLabelInputAdd" list="existingLabels" placeholder="Type or select a label" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    <datalist id="existingLabels"></datalist>
                </div>
                <div class="mt-4">
                    <label for="modalNotesInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Notes</label>
                    <textarea id="modalNotesInputAdd" placeholder="Add any relevant notes..." rows="3" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancelAddModalBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewEditTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[150]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogViewEdit">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Edit Task Details</h3>
                <button id="closeViewEditModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="modalTodoFormViewEdit">
                <input type="hidden" id="modalViewEditTaskId">
                <div>
                    <label for="modalTaskInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Task Description</label>
                    <input type="text" id="modalTaskInputViewEdit" placeholder="e.g., Buy groceries" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="modalDueDateInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Due Date</label>
                        <input type="date" id="modalDueDateInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="modalTimeInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time</label>
                        <input type="time" id="modalTimeInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="modalPriorityInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Priority</label>
                    <select id="modalPriorityInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="modalLabelInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Label</label>
                    <input type="text" id="modalLabelInputViewEdit" list="existingLabelsEdit" placeholder="Type or select a label" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    <datalist id="existingLabelsEdit"></datalist>
                </div>
                <div class="mt-4">
                    <label for="modalNotesInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Notes</label>
                    <textarea id="modalNotesInputViewEdit" placeholder="Add any relevant notes..." rows="3" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancelViewEditModalBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewTaskDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[160]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogViewDetails">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Task Information</h3>
                <button id="closeViewDetailsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm text-slate-700 dark:text-slate-300">
                <div>
                    <strong class="view-details-heading block mb-0.5">Description:</strong>
                    <p id="viewTaskText" class="break-all"></p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                    <div>
                        <strong class="view-details-heading block mb-0.5">Due Date:</strong>
                        <p id="viewTaskDueDate"></p>
                    </div>
                    <div>
                        <strong class="view-details-heading block mb-0.5">Time:</strong>
                        <p id="viewTaskTime"></p>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                    <div>
                        <strong class="view-details-heading block mb-0.5">Priority:</strong>
                        <p id="viewTaskPriority" class="capitalize"></p>
                    </div>
                    <div>
                        <strong class="view-details-heading block mb-0.5">Status:</strong>
                        <p id="viewTaskStatus" class="capitalize"></p>
                    </div>
                </div>
                <div>
                    <strong class="view-details-heading block mb-0.5">Label:</strong>
                    <p id="viewTaskLabel" class="capitalize"></p>
                </div>
                <div>
                    <strong class="view-details-heading block mb-0.5">Notes:</strong>
                    <p id="viewTaskNotes" class="mt-1 break-all whitespace-pre-wrap"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="editFromViewModalBtn" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Edit Task</button>
                <button type="button" id="closeViewDetailsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>

    <div id="manageLabelsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[170]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-md shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogManageLabels">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Manage Labels</h3>
                <button id="closeManageLabelsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addNewLabelForm" class="flex gap-2 mb-4">
                <input type="text" id="newLabelInput" placeholder="New label name" class="flex-grow p-2.5 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold p-2.5 rounded-lg shadow-md">Add</button>
            </form>
            <h4 class="text-lg font-medium text-slate-700 dark:text-slate-200 mb-2">Existing Labels:</h4>
            <ul id="existingLabelsList" class="max-h-60 overflow-y-auto space-y-1 pr-1">
                </ul>
             <div class="mt-6 flex justify-end">
                <button type="button" id="closeManageLabelsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>


    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-4xl sm:text-5xl font-bold text-center text-white mb-8 sm:mb-10">My Todo List</h1>

        <div class="flex flex-col md:flex-row gap-6 lg:gap-8">
            <aside id="taskSidebar" class="bg-slate-100 dark:bg-slate-800 rounded-xl shadow-xl flex-shrink-0 md:sticky md:top-10 md:self-start sticky-sidebar w-full md:w-72 lg:w-80 p-3 sm:p-4 md:p-5">
                <div class="space-y-4 md:space-y-6">
                    <div class="flex justify-between items-center mb-2 md:mb-3">
                        <h2 class="sidebar-text-content text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200">Add Task</h2>
                        <button id="sidebarToggleBtn" title="Toggle Sidebar" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                            <i id="sidebarToggleIcon" class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div>
                        <button
                            id="openAddModalButton"
                            type="button"
                            title="Add New Task"
                            class="bg-sky-500 hover:bg-sky-600 text-white font-semibold p-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 w-full flex items-center sidebar-button-icon-only justify-center"
                        >
                            <i class="fas fa-plus mr-0"></i> <span class="sidebar-text-content ml-2">Add New Task</span>
                        </button>
                    </div>

                    <div>
                        <h2 class="sidebar-text-content text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3">Filter Tasks</h2>
                        <div class="flex flex-col gap-2">
                            <button id="filterAll" title="All Tasks" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="all">
                                <i class="fas fa-list-ul w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">All Tasks</span>
                            </button>
                            <button id="filterActive" title="Active Tasks" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="active">
                                <i class="fas fa-bolt w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Active</span>
                            </button>
                            <button id="filterCompleted" title="Completed Tasks" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="completed">
                                <i class="fas fa-check-circle w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Completed</span>
                            </button>
                            <hr class="my-2 border-slate-200 dark:border-slate-700">
                             <h2 class="sidebar-text-content text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mt-2 mb-1">Filter Dates</h2>
                            <button id="filterDueToday" title="Due Today" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="dueToday">
                                <i class="fas fa-calendar-day w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Due Today</span>
                            </button>
                            <button id="filterDueThisWeek" title="Due This Week" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="dueThisWeek">
                                <i class="fas fa-calendar-week w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Due This Week</span>
                            </button>
                            <button id="filterDueThisMonth" title="Due This Month" class="filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="dueThisMonth">
                                <i class="far fa-calendar-alt w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Due This Month</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <h2 class="sidebar-text-content text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3">Manage</h2>
                        <button
                            id="clearCompletedBtn"
                            title="Clear Completed Tasks"
                            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-3 md:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed w-full flex items-center sidebar-button-icon-only justify-center mb-2"
                            disabled
                        >
                            <i class="fas fa-eraser mr-0"></i> <span class="sidebar-text-content ml-2">Clear Completed</span>
                        </button>
                        <button
                            id="manageLabelsBtn"
                            title="Manage Labels"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2.5 px-3 md:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 w-full flex items-center sidebar-button-icon-only justify-center"
                        >
                            <i class="fas fa-tags mr-0"></i> <span class="sidebar-text-content ml-2">Labels</span>
                        </button>
                    </div>
                </div>
            </aside>

            <main class="w-full flex-grow bg-white dark:bg-slate-900 p-4 md:p-6 lg:p-8 rounded-xl shadow-2xl min-h-[300px] mt-4 md:mt-0">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6">
                    <h2 class="text-xl sm:text-2xl md:text-3xl font-semibold text-slate-800 dark:text-slate-100">Your Tasks</h2>
                    <div class="flex gap-2 mt-3 sm:mt-0 flex-wrap">
                        <button id="sortByDueDateBtn" title="Sort by Due Date" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-sort-amount-down mr-1.5"></i> Due Date
                        </button>
                        <button id="sortByPriorityBtn" title="Sort by Priority" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-exclamation-circle mr-1.5"></i> Priority
                        </button>
                        <button id="sortByLabelBtn" title="Sort by Label" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-tags mr-1.5"></i> Label
                        </button>
                    </div>
                </div>
                <ul id="taskList" class="space-y-3 sm:space-y-3.5">
                    </ul>
                <p id="emptyState" class="text-center text-slate-500 dark:text-slate-400 mt-8 py-5 hidden">No tasks yet. Add some!</p>
                <p id="noMatchingTasks" class="text-center text-slate-500 dark:text-slate-400 mt-8 py-5 hidden">No tasks match the current filter.</p>
            </main>
        </div>
    </div>

    <footer class="text-center text-slate-400 dark:text-slate-500 mt-10 sm:mt-12 mb-6 text-sm">
        <p>Todo List App &copy; <span id="currentYear"></span></p>
    </footer>

    <script>
        // --- DOM Elements ---
        const taskSidebar = document.getElementById('taskSidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
        const sidebarTextElements = taskSidebar.querySelectorAll('.sidebar-text-content');
        const sidebarIconOnlyButtons = taskSidebar.querySelectorAll('.sidebar-button-icon-only');
        const iconTooltip = document.getElementById('iconTooltip');
        const sortByDueDateBtn = document.getElementById('sortByDueDateBtn');
        const sortByPriorityBtn = document.getElementById('sortByPriorityBtn');
        const sortByLabelBtn = document.getElementById('sortByLabelBtn');


        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const noMatchingTasks = document.getElementById('noMatchingTasks');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        const messageBox = document.getElementById('messageBox');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Add Task Modal elements
        const addTaskModal = document.getElementById('addTaskModal');
        const modalDialogAdd = document.getElementById('modalDialogAdd');
        const openAddModalButton = document.getElementById('openAddModalButton');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const modalTodoFormAdd = document.getElementById('modalTodoFormAdd');
        const modalTaskInputAdd = document.getElementById('modalTaskInputAdd');
        const modalDueDateInputAdd = document.getElementById('modalDueDateInputAdd');
        const modalTimeInputAdd = document.getElementById('modalTimeInputAdd');
        const modalPriorityInputAdd = document.getElementById('modalPriorityInputAdd');
        const modalLabelInputAdd = document.getElementById('modalLabelInputAdd');
        const existingLabelsDatalist = document.getElementById('existingLabels');
        const modalNotesInputAdd = document.getElementById('modalNotesInputAdd');

        // View/Edit Task Modal elements
        const viewEditTaskModal = document.getElementById('viewEditTaskModal');
        const modalDialogViewEdit = document.getElementById('modalDialogViewEdit');
        const closeViewEditModalBtn = document.getElementById('closeViewEditModalBtn');
        const cancelViewEditModalBtn = document.getElementById('cancelViewEditModalBtn');
        const modalTodoFormViewEdit = document.getElementById('modalTodoFormViewEdit');
        const modalViewEditTaskId = document.getElementById('modalViewEditTaskId');
        const modalTaskInputViewEdit = document.getElementById('modalTaskInputViewEdit');
        const modalDueDateInputViewEdit = document.getElementById('modalDueDateInputViewEdit');
        const modalTimeInputViewEdit = document.getElementById('modalTimeInputViewEdit');
        const modalPriorityInputViewEdit = document.getElementById('modalPriorityInputViewEdit');
        const modalLabelInputViewEdit = document.getElementById('modalLabelInputViewEdit');
        const existingLabelsEditDatalist = document.getElementById('existingLabelsEdit');
        const modalNotesInputViewEdit = document.getElementById('modalNotesInputViewEdit');


        // View Task Details Modal elements
        const viewTaskDetailsModal = document.getElementById('viewTaskDetailsModal');
        const modalDialogViewDetails = document.getElementById('modalDialogViewDetails');
        const closeViewDetailsModalBtn = document.getElementById('closeViewDetailsModalBtn');
        const closeViewDetailsSecondaryBtn = document.getElementById('closeViewDetailsSecondaryBtn');
        const editFromViewModalBtn = document.getElementById('editFromViewModalBtn');
        const viewTaskText = document.getElementById('viewTaskText');
        const viewTaskDueDate = document.getElementById('viewTaskDueDate');
        const viewTaskTime = document.getElementById('viewTaskTime');
        const viewTaskPriority = document.getElementById('viewTaskPriority');
        const viewTaskStatus = document.getElementById('viewTaskStatus');
        const viewTaskLabel = document.getElementById('viewTaskLabel');
        const viewTaskNotes = document.getElementById('viewTaskNotes');

        // Manage Labels Modal elements
        const manageLabelsModal = document.getElementById('manageLabelsModal');
        const modalDialogManageLabels = document.getElementById('modalDialogManageLabels');
        const closeManageLabelsModalBtn = document.getElementById('closeManageLabelsModalBtn');
        const closeManageLabelsSecondaryBtn = document.getElementById('closeManageLabelsSecondaryBtn');
        const addNewLabelForm = document.getElementById('addNewLabelForm');
        const newLabelInput = document.getElementById('newLabelInput');
        const existingLabelsList = document.getElementById('existingLabelsList');
        const manageLabelsBtn = document.getElementById('manageLabelsBtn');


        // --- Application State ---
        let tasks = JSON.parse(localStorage.getItem('todos_v3')) || [];
        let currentFilter = 'all';
        let currentSort = 'default'; // 'default', 'dueDate', 'priority', 'label'
        let editingTaskId = null; // Stores the ID of the task being edited
        let currentViewTaskId = null; // Stores the ID of the task being viewed in details modal
        let tooltipTimeout = null; // For sidebar icon tooltips
        let uniqueLabels = []; // Stores all unique labels for datalists and management

        // --- Theme Management ---
        // Listener for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });
        
        // --- Sidebar Toggle Functionality ---
        function setSidebarMinimized(minimize) {
            hideTooltip(); // Hide any active tooltip
            if (minimize) {
                // Minimize: Adjust classes for smaller sidebar
                taskSidebar.classList.remove('md:w-72', 'lg:w-80', 'w-full', 'p-5', 'sm:p-6', 'md:p-5', 'sm:p-4');
                taskSidebar.classList.add('w-16', 'p-3', 'sidebar-minimized'); // md:w-20 for slightly wider minimized on medium screens
                
                sidebarToggleIcon.classList.remove('fa-chevron-left');
                sidebarToggleIcon.classList.add('fa-chevron-right');
                
                sidebarTextElements.forEach(el => el.classList.add('hidden'));
                sidebarIconOnlyButtons.forEach(btn => {
                    btn.classList.add('justify-center');
                    const icon = btn.querySelector('i');
                    if(icon) icon.classList.remove('md:mr-2', 'md:mr-2.5', 'ml-2'); // Remove margins meant for expanded view
                });
                localStorage.setItem('sidebarState', 'minimized');
            } else { // Expand
                // Expand: Restore classes for full sidebar
                taskSidebar.classList.remove('w-16', 'p-3', 'sidebar-minimized'); // md:w-20
                taskSidebar.classList.add('w-full', 'md:w-72', 'lg:w-80', 'p-3', 'sm:p-4', 'md:p-5');

                sidebarToggleIcon.classList.remove('fa-chevron-right');
                sidebarToggleIcon.classList.add('fa-chevron-left');
                
                sidebarTextElements.forEach(el => el.classList.remove('hidden'));
                 sidebarIconOnlyButtons.forEach(btn => {
                    btn.classList.remove('justify-center'); // Text is visible, so not just icon
                    const icon = btn.querySelector('i');
                    const textSpan = btn.querySelector('.sidebar-text-content');
                    if(icon && textSpan && !textSpan.classList.contains('hidden')) { // Ensure text is visible before adding margin
                        // Add specific margins based on button type, if needed for alignment
                        if (btn.id === 'openAddModalButton' || btn.id === 'clearCompletedBtn' || btn.id === 'manageLabelsBtn') { // Added manageLabelsBtn
                             icon.classList.add('md:mr-2'); // Standard margin for action buttons
                        } else { // Filter buttons
                             icon.classList.add('md:mr-2.5'); // Slightly more margin for filter buttons
                        }
                        textSpan.classList.add('ml-2'); // Ensure text has left margin from icon
                    }
                });
                localStorage.setItem('sidebarState', 'expanded');
            }
        }

        // --- Tooltip Functions ---
        function showTooltip(element, text) {
            if (!taskSidebar.classList.contains('sidebar-minimized')) return; // Only show tooltips when minimized

            iconTooltip.textContent = text;
            const rect = element.getBoundingClientRect();
            // Position tooltip to the right of the icon, vertically centered
            iconTooltip.style.left = `${rect.right + 10}px`; // 10px offset from the icon
            iconTooltip.style.top = `${rect.top + (rect.height / 2) - (iconTooltip.offsetHeight / 2)}px`;
            iconTooltip.style.display = 'block';
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            iconTooltip.style.display = 'none';
        }

        // Add tooltip listeners to all icon-only buttons in the sidebar
        sidebarIconOnlyButtons.forEach(button => {
            button.addEventListener('mouseenter', (event) => {
                if (!taskSidebar.classList.contains('sidebar-minimized')) return;
                clearTimeout(tooltipTimeout); // Clear any existing timeout
                tooltipTimeout = setTimeout(() => { // Show tooltip after a delay
                    const tooltipText = button.title || button.querySelector('.sidebar-text-content')?.textContent.trim();
                    if (tooltipText) {
                        showTooltip(event.currentTarget, tooltipText);
                    }
                }, 500); // 500ms delay before showing tooltip
            });
            button.addEventListener('mouseleave', () => {
                hideTooltip();
            });
        });


        // --- Modal Functions (Add Task) ---
        function openAddModal() {
            // Prevent opening if already open or if an input field is focused (to avoid conflicts with '+' key shortcut)
            if (!addTaskModal.classList.contains('hidden') || 
                document.activeElement.tagName === 'INPUT' || 
                document.activeElement.tagName === 'SELECT' || 
                document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            addTaskModal.classList.remove('hidden');
            setTimeout(() => { // For transition effect
                modalDialogAdd.classList.remove('scale-95', 'opacity-0');
                modalDialogAdd.classList.add('scale-100', 'opacity-100');
            }, 10);
            modalTaskInputAdd.focus();
            modalTodoFormAdd.reset(); // Clear previous input
            modalPriorityInputAdd.value = 'medium'; // Default priority
            populateDatalist(existingLabelsDatalist); // Populate label suggestions
            // Set min date for due date input to today
            const today = new Date();
            const year = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
            const dd = String(today.getDate()).padStart(2, '0');
            modalDueDateInputAdd.min = `${year}-${mm}-${dd}`;
        }

        function closeAddModal() {
            modalDialogAdd.classList.add('scale-95', 'opacity-0');
            modalDialogAdd.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                 addTaskModal.classList.add('hidden');
            }, 200); // Match transition duration
        }

        // --- Modal Functions (View/Edit Task) ---
        function openViewEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            editingTaskId = taskId; // Set the task ID being edited
            modalViewEditTaskId.value = task.id; // Hidden input to store ID
            modalTaskInputViewEdit.value = task.text;
            modalDueDateInputViewEdit.value = task.dueDate || ''; // Handle null dueDate
            modalTimeInputViewEdit.value = task.time || ''; // Handle null time
            modalPriorityInputViewEdit.value = task.priority;
            modalLabelInputViewEdit.value = task.label || ''; // Handle null label
            populateDatalist(existingLabelsEditDatalist); // Populate label suggestions
            modalNotesInputViewEdit.value = task.notes || ''; // Handle null notes
            // Set min date for due date input to today
            const today = new Date();
            const year = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            modalDueDateInputViewEdit.min = `${year}-${mm}-${dd}`;
            viewEditTaskModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogViewEdit.classList.remove('scale-95', 'opacity-0');
                modalDialogViewEdit.classList.add('scale-100', 'opacity-100');
            }, 10);
            modalTaskInputViewEdit.focus();
        }

        function closeViewEditModal() {
            modalDialogViewEdit.classList.add('scale-95', 'opacity-0');
            modalDialogViewEdit.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                 viewEditTaskModal.classList.add('hidden');
                 editingTaskId = null; // Clear editing state
            }, 200);
        }

        // --- Modal Functions (View Task Details - Read-Only) ---
        function openViewTaskDetailsModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentViewTaskId = taskId; // Set the task ID being viewed
            viewTaskText.textContent = task.text;
            viewTaskDueDate.textContent = task.dueDate ? formatDate(task.dueDate) : 'Not set';
            viewTaskTime.textContent = task.time ? formatTime(task.time) : 'Not set';
            viewTaskPriority.textContent = task.priority || 'Not set';
            viewTaskStatus.textContent = task.completed ? 'Completed' : 'Active';
            viewTaskLabel.textContent = task.label || 'None';
            viewTaskNotes.textContent = task.notes || 'No notes added.';
            viewTaskDetailsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogViewDetails.classList.remove('scale-95', 'opacity-0');
                modalDialogViewDetails.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeViewTaskDetailsModal() {
            modalDialogViewDetails.classList.add('scale-95', 'opacity-0');
            modalDialogViewDetails.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                 viewTaskDetailsModal.classList.add('hidden');
                 currentViewTaskId = null; // Clear viewing state
            }, 200);
        }

        // --- Modal Functions (Manage Labels) ---
        function openManageLabelsModal() {
            populateManageLabelsList();
            manageLabelsModal.classList.remove('hidden');
             setTimeout(() => {
                modalDialogManageLabels.classList.remove('scale-95', 'opacity-0');
                modalDialogManageLabels.classList.add('scale-100', 'opacity-100');
            }, 10);
            newLabelInput.focus();
        }

        function closeManageLabelsModal() {
            modalDialogManageLabels.classList.add('scale-95', 'opacity-0');
            modalDialogManageLabels.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                manageLabelsModal.classList.add('hidden');
            }, 200);
        }

        function populateManageLabelsList() {
            existingLabelsList.innerHTML = ''; // Clear current list
            uniqueLabels.forEach(label => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700 rounded-md';
                
                const span = document.createElement('span');
                span.textContent = label;
                span.className = 'text-slate-700 dark:text-slate-200 capitalize';
                li.appendChild(span);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                deleteBtn.className = 'p-1';
                deleteBtn.title = `Delete label "${label}"`;
                deleteBtn.addEventListener('click', () => handleDeleteLabel(label));
                li.appendChild(deleteBtn);

                existingLabelsList.appendChild(li);
            });
            if (uniqueLabels.length === 0) {
                existingLabelsList.innerHTML = '<li class="text-slate-500 dark:text-slate-400 text-center">No labels created yet.</li>';
            }
        }

        function handleAddNewLabel(event) {
            event.preventDefault();
            const labelName = newLabelInput.value.trim().toLowerCase();
            if (labelName === '') {
                showMessage('Label name cannot be empty.', 'error');
                return;
            }
            if (uniqueLabels.includes(labelName)) {
                showMessage(`Label "${labelName}" already exists.`, 'error');
                return;
            }
            uniqueLabels.push(labelName);
            uniqueLabels.sort();
            saveTasks(); // This calls updateUniqueLabels which sorts and updates datalists
            populateManageLabelsList();
            populateDatalist(existingLabelsDatalist);
            populateDatalist(existingLabelsEditDatalist);
            newLabelInput.value = '';
            showMessage(`Label "${labelName}" added.`, 'success');
        }

        function handleDeleteLabel(labelToDelete) {
            const normalizedLabelToDelete = labelToDelete.toLowerCase();
            // Update tasks that use this label
            tasks = tasks.map(task => {
                if (task.label && task.label.toLowerCase() === normalizedLabelToDelete) {
                    return { ...task, label: '' }; // Set label to empty string or 'None' or remove it
                }
                return task;
            });
            saveTasks(); // This will also update uniqueLabels and datalists
            populateManageLabelsList(); // Re-render the list in the manage labels modal
            renderTasks(); // Re-render the main task list
            showMessage(`Label "${labelToDelete}" deleted and removed from tasks.`, 'success');
        }


        // --- Date & Time Helper Functions ---
        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
        function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function getEndOfWeek(date) { const d = new Date(date); const startOfWeek = getStartOfWeek(d); return new Date(startOfWeek.setDate(startOfWeek.getDate() + 6)); }
        function getStartOfMonth(date) { return new Date(date.getFullYear(), date.getMonth(), 1); }
        function getEndOfMonth(date) { return new Date(date.getFullYear(), date.getMonth() + 1, 0); }
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; const correctedDate = new Date(date.getTime() + userTimezoneOffset); return correctedDate.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatTime(timeString) { 
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12; // Convert 0 to 12 for 12 AM, and 13-23 to 1-11 PM
            return `${formattedHours}:${minutes} ${ampm}`;
        }


        // --- Core Functions ---
        function showMessage(message, type = 'success') { 
            messageBox.textContent = message; 
            messageBox.className = 'message-box'; // Reset classes
            if (type === 'success') { 
                messageBox.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100'); 
            } else { 
                messageBox.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100'); 
            } 
            messageBox.style.display = 'block'; 
            messageBox.style.zIndex = '200'; // Ensure it's above modals if any are still fading out
            setTimeout(() => { messageBox.style.display = 'none'; }, 3000); 
        }
        function saveTasks() { 
            localStorage.setItem('todos_v3', JSON.stringify(tasks)); 
            updateUniqueLabels(); // Update labels whenever tasks are saved
        }
        function getPriorityClass(priority) { switch (priority) { case 'high': return 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100'; case 'medium': return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-600 dark:text-yellow-100'; case 'low': return 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100'; default: return 'bg-slate-100 text-slate-700 dark:bg-slate-600 dark:text-slate-200'; } }
        
        function updateUniqueLabels() {
            const labels = new Set();
            tasks.forEach(task => {
                if (task.label && task.label.trim() !== '') {
                    labels.add(task.label.trim().toLowerCase()); // Store labels in lowercase for consistency
                }
            });
            uniqueLabels = Array.from(labels).sort(); // Keep them sorted
            populateDatalist(existingLabelsDatalist); // Update datalist for Add modal
            populateDatalist(existingLabelsEditDatalist); // Update datalist for Edit modal
        }

        function populateDatalist(datalistElement) {
            if (!datalistElement) return; // Guard against null element if IDs mismatch
            datalistElement.innerHTML = ''; // Clear existing options
            uniqueLabels.forEach(label => {
                const option = document.createElement('option');
                option.value = label.charAt(0).toUpperCase() + label.slice(1); // Capitalize for display in datalist
                datalistElement.appendChild(option);
            });
        }


        function renderTasks() {
            taskList.innerHTML = '';
            let tasksToRender = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            // Apply filters first
            if (currentFilter === 'all') { tasksToRender = [...tasks]; } 
            else if (currentFilter === 'active') { tasksToRender = tasks.filter(task => !task.completed); }
            else if (currentFilter === 'completed') { tasksToRender = tasks.filter(task => task.completed); }
            else if (currentFilter === 'dueToday') { const todayStr = getTodayDateString(); tasksToRender = tasks.filter(task => task.dueDate === todayStr && !task.completed); }
            else if (currentFilter === 'dueThisWeek') {
                const startOfWeek = getStartOfWeek(today); startOfWeek.setHours(0,0,0,0);
                const endOfWeek = getEndOfWeek(today); endOfWeek.setHours(23,59,59,999);
                tasksToRender = tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const taskDueDate = new Date(task.dueDate); const userTimezoneOffset = taskDueDate.getTimezoneOffset() * 60000;
                    const correctedTaskDueDate = new Date(taskDueDate.getTime() + userTimezoneOffset); correctedTaskDueDate.setHours(0,0,0,0); // Correct for timezone and normalize
                    return correctedTaskDueDate >= startOfWeek && correctedTaskDueDate <= endOfWeek && !task.completed;
                });
            } else if (currentFilter === 'dueThisMonth') {
                const startOfMonth = getStartOfMonth(today); startOfMonth.setHours(0,0,0,0);
                const endOfMonth = getEndOfMonth(today); endOfMonth.setHours(23,59,59,999);
                tasksToRender = tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const taskDueDate = new Date(task.dueDate); const userTimezoneOffset = taskDueDate.getTimezoneOffset() * 60000;
                    const correctedTaskDueDate = new Date(taskDueDate.getTime() + userTimezoneOffset); correctedTaskDueDate.setHours(0,0,0,0); // Correct for timezone and normalize
                    return correctedTaskDueDate >= startOfMonth && correctedTaskDueDate <= endOfMonth && !task.completed;
                });
            }

            // Apply sorting
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            if (currentSort === 'dueDate') {
                tasksToRender.sort((a, b) => {
                    if (!a.dueDate && !b.dueDate) return 0; // Both no due date
                    if (!a.dueDate) return 1;  // a has no due date, sort it after b
                    if (!b.dueDate) return -1; // b has no due date, sort it after a
                    // Compare dates, then times if dates are the same
                    const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                    const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                    return dateA - dateB;
                });
            } else if (currentSort === 'priority') {
                tasksToRender.sort((a, b) => {
                    // Sort by priority, then by due date if priorities are the same
                    const priorityDiff = (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4);
                    if (priorityDiff !== 0) return priorityDiff;
                    // If priorities are same, sort by due date (earlier first)
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                    const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                    return dateA - dateB;
                });
            } else if (currentSort === 'label') {
                tasksToRender.sort((a,b) => {
                    const labelA = (a.label || '').toLowerCase();
                    const labelB = (b.label || '').toLowerCase();
                    if (labelA < labelB) return -1;
                    if (labelA > labelB) return 1;
                    // If labels are same, sort by due date (earlier first)
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                    const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                    return dateA - dateB;
                });
            }


            emptyState.classList.toggle('hidden', tasks.length !== 0);
            noMatchingTasks.classList.toggle('hidden', !(tasks.length > 0 && tasksToRender.length === 0));

            tasksToRender.forEach((task) => {
                const li = document.createElement('li');
                li.className = `task-item flex items-start justify-between bg-slate-100 dark:bg-slate-700 p-3 sm:p-3.5 rounded-lg shadow hover:shadow-md transition-shadow duration-300 ${task.completed ? 'opacity-60' : ''} overflow-hidden`;
                li.dataset.taskId = task.id;
                // Clickable area for viewing details (excluding checkbox and delete button)
                const mainContentClickableArea = document.createElement('div');
                mainContentClickableArea.className = 'task-item-clickable-area flex items-start flex-grow min-w-0 mr-2 rounded-l-lg'; // min-w-0 prevents text overflow issues
                mainContentClickableArea.addEventListener('click', (event) => {
                    // Only open details if the click was not on the checkbox or delete button
                    if (event.target.type === 'checkbox' || event.target.closest('.delete-btn')) {
                        return;
                    }
                    openViewTaskDetailsModal(task.id);
                });
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-sky-500 rounded border-slate-400 dark:border-slate-500 focus:ring-sky-400 dark:focus:ring-sky-500 mt-0.5 mr-2 sm:mr-3 cursor-pointer flex-shrink-0';
                checkbox.addEventListener('change', () => toggleComplete(task.id));
                const textDetailsDiv = document.createElement('div');
                textDetailsDiv.className = 'flex flex-col';
                const span = document.createElement('span');
                span.textContent = task.text;
                let textColorClass = task.completed ? 'text-slate-500 dark:text-slate-400' : 'text-slate-700 dark:text-slate-200';
                span.className = `text-sm sm:text-base break-all ${textColorClass} ${task.completed ? 'completed-text' : ''}`;
                textDetailsDiv.appendChild(span);
                
                // Container for badges and due date
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'flex items-center flex-wrap gap-x-2 gap-y-1 mt-1 sm:mt-1.5 text-xs';

                if (task.priority) { 
                    const priorityBadge = document.createElement('span'); 
                    priorityBadge.textContent = task.priority; 
                    priorityBadge.className = `priority-badge ${getPriorityClass(task.priority)}`; 
                    detailsContainer.appendChild(priorityBadge); 
                }
                if (task.label) {
                    const labelBadge = document.createElement('span');
                    labelBadge.textContent = task.label;
                    labelBadge.className = 'label-badge'; // Custom class for label-specific styling
                    detailsContainer.appendChild(labelBadge);
                }
                if (task.dueDate) { 
                    const dueDateSpan = document.createElement('span'); 
                    dueDateSpan.className = 'text-slate-500 dark:text-slate-400 flex items-center'; 
                    let dateDisplay = formatDate(task.dueDate);
                    if (task.time) {
                        dateDisplay += ` ${formatTime(task.time)}`;
                    }
                    dueDateSpan.innerHTML = `<i class="far fa-calendar-alt mr-1"></i> ${dateDisplay}`; 
                    detailsContainer.appendChild(dueDateSpan); 
                }
                if (detailsContainer.hasChildNodes()) {
                    textDetailsDiv.appendChild(detailsContainer);
                }

                mainContentClickableArea.appendChild(checkbox);
                mainContentClickableArea.appendChild(textDetailsDiv);
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500 transition-colors duration-300 px-1 sm:px-2 py-1 flex-shrink-0 self-start';
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteButton.setAttribute('aria-label', 'Delete task');
                deleteButton.addEventListener('click', () => deleteTask(task.id));
                li.appendChild(mainContentClickableArea); 
                li.appendChild(deleteButton);
                taskList.appendChild(li);
            });
            updateClearCompletedButton();
        }
        
        // Natural Language Date Parsing
        function parseDateFromText(text) {
            let parsedDate = null;
            let remainingText = text;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const daysOfWeek = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
            const shortDaysOfWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

            // Define patterns and their handlers
            // Order matters: more specific patterns should come first.
            const patterns = [
                { regex: /\b(today)\b/i, handler: () => getTodayDateString() },
                { 
                    regex: /\b(tomorrow)\b/i, 
                    handler: () => {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        return tomorrow.toISOString().split('T')[0];
                    } 
                },
                { 
                    regex: /\b(next week)\b/i, 
                    handler: () => {
                        const nextWeek = new Date(today);
                        // Go to Monday of next week
                        nextWeek.setDate(today.getDate() - today.getDay() + 1 + 7); // +1 for Monday, +7 for next week
                        return nextWeek.toISOString().split('T')[0];
                    }
                },
                {
                    regex: /\b(next month)\b/i,
                    handler: () => {
                        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                        return nextMonth.toISOString().split('T')[0];
                    }
                },
                {
                    regex: /\b(next year)\b/i,
                    handler: () => {
                        const nextYear = new Date(today.getFullYear() + 1, 0, 1); // Jan 1st of next year
                        return nextYear.toISOString().split('T')[0];
                    }
                },
                { 
                    // Matches "on Monday", "Monday", "next Monday" (treats "next Monday" as upcoming Monday)
                    regex: new RegExp(`\\b(on\\s+)?(next\\s+)?(${daysOfWeek.join('|')}|${shortDaysOfWeek.join('|')})\\b`, 'i'),
                    handler: (match) => {
                        const dayName = match[3].toLowerCase(); // Group 3 is the day name
                        let targetDayIndex = daysOfWeek.indexOf(dayName);
                        if (targetDayIndex === -1) {
                            targetDayIndex = shortDaysOfWeek.indexOf(dayName);
                        }
                        if (targetDayIndex === -1) return null; // Should not happen with regex

                        const currentDayIndex = today.getDay();
                        let daysToAdd = targetDayIndex - currentDayIndex;

                        // If the day is in the past this week, or it's today and "next" was specified, move to next week's instance
                        if (daysToAdd < 0 || (daysToAdd === 0 && (match[2] || new Date().getHours() > 0 /* if it's today but past working hours assume next week */))) { 
                            daysToAdd += 7;
                        }
                         // If it's today and 'next' wasn't specified, and it's not past typical working hours, use today
                        if (targetDayIndex === currentDayIndex && !match[2] && daysToAdd !== 7){ 
                            daysToAdd = 0;
                        }


                        const targetDate = new Date(today);
                        targetDate.setDate(today.getDate() + daysToAdd);
                        return targetDate.toISOString().split('T')[0];
                    }
                },
                // Matches YYYY-MM-DD or YYYY/MM/DD
                { regex: /(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/g, handler: (match) => match[0].replace(/\//g, '-') }, 
                // Matches MM/DD/YYYY or MM-DD-YYYY (assumes current century for YY)
                { regex: /(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/g, handler: (match) => { 
                    const parts = match[0].replace(/-/g, '/').split('/');
                    const year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }}
            ];

            for (const pattern of patterns) {
                const match = pattern.regex.exec(remainingText);
                if (match) {
                    const potentialDate = pattern.handler(match);
                    // Validate if the handler returned a valid date string format
                    if (potentialDate && !isNaN(new Date(potentialDate).getTime())) {
                        parsedDate = potentialDate;
                        const matchedString = match[0];
                        // Remove the matched date string and any surrounding "for", "on", "by", "due" prepositions
                        remainingText = remainingText.replace(new RegExp(`\\b(for|on|by|due)?\\s*${matchedString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`, 'i'), '').replace(/\s\s+/g, ' ').trim();
                        break; // Found a date, stop processing
                    }
                }
            }
            return { parsedDate, remainingText };
        }


        function handleAddTask(event) {
            event.preventDefault();
            const rawTaskText = modalTaskInputAdd.value.trim();
            const explicitDueDate = modalDueDateInputAdd.value; 
            const time = modalTimeInputAdd.value; 
            const priority = modalPriorityInputAdd.value;
            const label = modalLabelInputAdd.value.trim(); 
            const notes = modalNotesInputAdd.value.trim(); 

            if (rawTaskText === '') { 
                showMessage('Task description cannot be empty!', 'error'); 
                modalTaskInputAdd.focus(); 
                return; 
            }

            let finalDueDate = null;
            let finalTaskText = rawTaskText;

            // Try to parse date from description ONLY if no explicit due date is set
            if (!explicitDueDate) {
                const { parsedDate: dateFromDescription, remainingText: textAfterDateRemoval } = parseDateFromText(rawTaskText);
                if (dateFromDescription) {
                    finalDueDate = dateFromDescription;
                    finalTaskText = textAfterDateRemoval || rawTaskText; // Use remaining text or original if empty
                }
            } else {
                finalDueDate = explicitDueDate; // Use explicitly set due date
            }

            const newTask = { 
                id: Date.now(), 
                text: finalTaskText, 
                completed: false, 
                dueDate: finalDueDate, 
                time: time || null, 
                priority: priority,
                label: label || '', 
                notes: notes || '' 
            };
            tasks.unshift(newTask); // Add to the beginning of the array
            saveTasks(); 
            // Smartly update view: if a date filter is active and new task matches, keep filter.
            // If 'completed' filter is active, switch to 'all' to show the new (active) task.
            if (currentFilter.startsWith('due') && finalDueDate) { setFilter(currentFilter); }
            else if (currentFilter === 'completed') { setFilter('all'); }
            else { renderTasks(); } // Otherwise, just re-render with current filter
            closeAddModal(); 
            showMessage('Task added successfully!', 'success');
        }

        function handleEditTask(event) {
            event.preventDefault();
            const taskId = parseInt(modalViewEditTaskId.value); 
            const taskText = modalTaskInputViewEdit.value.trim();
            const dueDate = modalDueDateInputViewEdit.value; 
            const time = modalTimeInputViewEdit.value; 
            const priority = modalPriorityInputViewEdit.value;
            const label = modalLabelInputViewEdit.value.trim(); 
            const notes = modalNotesInputViewEdit.value.trim(); 

            if (taskText === '') { showMessage('Task description cannot be empty!', 'error'); modalTaskInputViewEdit.focus(); return; }

            tasks = tasks.map(task =>
                task.id === taskId
                    ? { ...task, text: taskText, dueDate: dueDate || null, time: time || null, priority: priority, label: label || '', notes: notes || '' } 
                    : task
            );
            saveTasks(); 
            renderTasks(); 
            closeViewEditModal();
            showMessage('Task updated successfully!', 'success');
        }


        function toggleComplete(taskId) { tasks = tasks.map(task => task.id === taskId ? { ...task, completed: !task.completed } : task); saveTasks(); renderTasks(); }
        
        function deleteTask(taskId) { 
            tasks = tasks.filter(task => task.id !== taskId); 
            saveTasks(); 
            renderTasks(); 
            showMessage('Task deleted.', 'error'); // Using 'error' style for deletion message
        }

        function setFilter(filter) { 
            currentFilter = filter; 
            currentSort = 'default'; // Reset sort when filter changes
            updateSortButtonStates();
            filterButtons.forEach(button => { const isActive = button.dataset.filter === filter; button.setAttribute('data-active', isActive.toString()); const baseInactive = ['bg-slate-200', 'text-slate-700', 'hover:bg-slate-300', 'dark:bg-slate-700', 'dark:text-slate-300', 'dark:hover:bg-slate-600']; const iconInactive = ['text-slate-500', 'dark:text-slate-400']; const active = ['bg-sky-500', 'text-white', 'font-semibold']; const iconActive = ['text-sky-100']; button.classList.remove(...baseInactive, ...active); button.querySelector('i')?.classList.remove(...iconInactive, ...iconActive); if (isActive) { button.classList.add(...active); button.querySelector('i')?.classList.add(...iconActive); } else { button.classList.add(...baseInactive); button.querySelector('i')?.classList.add(...iconInactive); } }); renderTasks(); 
        }
        function updateClearCompletedButton() { clearCompletedBtn.disabled = !tasks.some(task => task.completed); }
        function clearCompletedTasks() { const completedCount = tasks.filter(task => task.completed).length; if (completedCount === 0) { showMessage('No completed tasks to clear.', 'error'); return; } tasks = tasks.filter(task => !task.completed); saveTasks(); renderTasks(); showMessage(`${completedCount} completed task(s) cleared.`, 'success'); }

        function updateSortButtonStates() {
            sortByDueDateBtn.classList.toggle('sort-btn-active', currentSort === 'dueDate');
            sortByPriorityBtn.classList.toggle('sort-btn-active', currentSort === 'priority');
            sortByLabelBtn.classList.toggle('sort-btn-active', currentSort === 'label'); 
        }

        // --- Event Listeners ---
        openAddModalButton.addEventListener('click', openAddModal); 
        closeAddModalBtn.addEventListener('click', closeAddModal); 
        cancelAddModalBtn.addEventListener('click', closeAddModal); 
        modalTodoFormAdd.addEventListener('submit', handleAddTask); 
        addTaskModal.addEventListener('click', (event) => { if (event.target === addTaskModal) closeAddModal(); }); 

        // View/Edit Modal Listeners
        closeViewEditModalBtn.addEventListener('click', closeViewEditModal);
        cancelViewEditModalBtn.addEventListener('click', closeViewEditModal);
        modalTodoFormViewEdit.addEventListener('submit', handleEditTask);
        viewEditTaskModal.addEventListener('click', (event) => { if (event.target === viewEditTaskModal) closeViewEditModal(); });

        // View Task Details Modal Listeners
        closeViewDetailsModalBtn.addEventListener('click', closeViewTaskDetailsModal);
        closeViewDetailsSecondaryBtn.addEventListener('click', closeViewTaskDetailsModal);
        editFromViewModalBtn.addEventListener('click', () => {
            if (currentViewTaskId !== null) {
                closeViewTaskDetailsModal(); // Close details modal first
                openViewEditModal(currentViewTaskId); // Then open edit modal for the same task
            }
        });
        viewTaskDetailsModal.addEventListener('click', (event) => { if (event.target === viewTaskDetailsModal) closeViewTaskDetailsModal(); });

        // Manage Labels Modal Listeners
        if (manageLabelsBtn) manageLabelsBtn.addEventListener('click', openManageLabelsModal);
        if (closeManageLabelsModalBtn) closeManageLabelsModalBtn.addEventListener('click', closeManageLabelsModal);
        if (closeManageLabelsSecondaryBtn) closeManageLabelsSecondaryBtn.addEventListener('click', closeManageLabelsModal);
        if (addNewLabelForm) addNewLabelForm.addEventListener('submit', handleAddNewLabel);
        if (manageLabelsModal) manageLabelsModal.addEventListener('click', (event) => { if (event.target === manageLabelsModal) closeManageLabelsModal(); });


        filterButtons.forEach(button => button.addEventListener('click', () => setFilter(button.dataset.filter)));
        clearCompletedBtn.addEventListener('click', clearCompletedTasks);

        // Sidebar Toggle Listener
        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', () => {
                // Check based on a class that's definitely unique to minimized state
                const isCurrentlyMinimized = taskSidebar.classList.contains('sidebar-minimized');
                setSidebarMinimized(!isCurrentlyMinimized);
            });
        }
        
        // Sort Button Listeners
        sortByDueDateBtn.addEventListener('click', () => {
            currentSort = currentSort === 'dueDate' ? 'default' : 'dueDate';
            updateSortButtonStates();
            renderTasks();
        });

        sortByPriorityBtn.addEventListener('click', () => {
            currentSort = currentSort === 'priority' ? 'default' : 'priority';
            updateSortButtonStates();
            renderTasks();
        });
        
        sortByLabelBtn.addEventListener('click', () => { 
            currentSort = currentSort === 'label' ? 'default' : 'label';
            updateSortButtonStates();
            renderTasks();
        });


        document.addEventListener('keydown', (event) => {
            const isAddModalOpen = !addTaskModal.classList.contains('hidden');
            const isViewEditModalOpen = !viewEditTaskModal.classList.contains('hidden');
            const isViewDetailsModalOpen = !viewTaskDetailsModal.classList.contains('hidden');
            const isManageLabelsModalOpen = !manageLabelsModal.classList.contains('hidden');
            const isAnyModalOpen = isAddModalOpen || isViewEditModalOpen || isViewDetailsModalOpen || isManageLabelsModalOpen;
            const isInputFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || document.activeElement.tagName === 'TEXTAREA';

            // '+' key to open Add Task Modal (if no modal is open and no input is focused)
            if ((event.key === '+' || event.key === '=') && !isAnyModalOpen && !isInputFocused) {
                event.preventDefault(); // Prevent typing '+' in any other input field by mistake
                openAddModal(); 
            }
            // 'Escape' key to close any open modal
            if (event.key === 'Escape') {
                if (isAddModalOpen) closeAddModal(); 
                if (isViewEditModalOpen) closeViewEditModal();
                if (isViewDetailsModalOpen) closeViewTaskDetailsModal();
                if (isManageLabelsModalOpen) closeManageLabelsModal();
            }
        });

        // --- Initial Setup ---
        updateUniqueLabels(); // Initialize unique labels from loaded tasks
        // Set initial styles for filter buttons (all inactive)
        filterButtons.forEach(button => { button.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300', 'dark:bg-slate-700', 'dark:text-slate-300', 'dark:hover:bg-slate-600'); button.querySelector('i')?.classList.add('text-slate-500', 'dark:text-slate-400'); });
        
        // Restore sidebar state from localStorage
        const savedSidebarState = localStorage.getItem('sidebarState');
        if (savedSidebarState === 'minimized') {
            setSidebarMinimized(true);
        } else {
            setSidebarMinimized(false); // Default to expanded
        }
        
        setFilter('all'); // Set initial filter and render tasks
        window.onload = () => { 
            // Re-apply filter and sidebar state on load, in case of race conditions or complex init
            setFilter(currentFilter); 
             if (localStorage.getItem('sidebarState') === 'minimized') {
                setSidebarMinimized(true);
            } else {
                setSidebarMinimized(false);
            }
            updateSortButtonStates(); // Ensure sort buttons reflect currentSort
        };
    </script>
</body>
</html>
