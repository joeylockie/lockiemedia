<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Todo List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General body and font styling */
        body { font-family: 'Inter', sans-serif; }

        /* Styling for the clickable area of a task item */
        .task-item-clickable-area:hover {
            cursor: pointer;
        }

        /* Show task actions (edit, delete buttons) on hover */
        .task-item:hover .task-actions { opacity: 1; }

        /* Styling for task action buttons container */
        .task-actions {
            opacity: 0; /* Hidden by default, shown on hover */
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
        }

        /* Styling for individual task action buttons (edit, delete) */
        .task-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }

        /* Styling for completed task text (line-through) */
        .completed-text { text-decoration: line-through; }

        /* Styling for the message box (notifications) */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem; /* py-4 px-6 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            z-index: 200; /* Ensure it's above other content */
            display: none; /* Hidden by default */
        }

        /* Styling for the sticky sidebar */
        .sticky-sidebar {
            position: sticky;
            top: 2.5rem; /* top-10 */
            align-self: flex-start; /* Keep sidebar at the top when scrolling */
            max-height: calc(100vh - 5rem); /* Prevent sidebar from being too tall */
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; /* Smooth transition for minimization */
        }

        /* Styling for priority and label badges */
        .priority-badge, .label-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem; /* Adjusted for smaller look */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* semibold */
            border-radius: 0.375rem; /* rounded-md */
            text-transform: capitalize;
        }

        /* Specific styling for label badges */
        .label-badge {
            background-color: #e0e7ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
        }
        .dark .label-badge {
            background-color: #4f46e5; /* indigo-600 */
            color: #e0e7ff; /* indigo-100 */
        }

        /* Ensure consistent height for smart view and sort buttons */
        .smart-view-btn, .sort-btn { min-height: 42px; }

        /* Styling for headings within the view details modal */
        .view-details-heading {
            font-weight: 600; /* semibold */
            font-size: 0.95rem; /* Slightly larger than default text-sm */
            color: #374151; /* gray-700 */
        }
        .dark .view-details-heading { color: #d1d5db; /* gray-300 */ }

        /* Styles for when the sidebar is minimized */
        .sidebar-minimized .sidebar-button-icon-only { justify-content: center; }
        .sidebar-minimized .sidebar-button-icon-only i { margin-right: 0 !important; }
        .sidebar-minimized .sidebar-text-content,
        .sidebar-minimized #taskSearchInputContainer,
        .sidebar-minimized .sidebar-section-title,
        .sidebar-minimized #testFeatureButtonContainer { display: none; }

        /* Styling for the icon tooltip (shown when sidebar is minimized) */
        #iconTooltip {
            position: absolute;
            background-color: #1f2937; /* gray-800 */
            color: white;
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            z-index: 250; /* Above other elements */
            display: none; /* Hidden by default */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap; /* Prevent tooltip text from wrapping */
        }
        .dark #iconTooltip { background-color: #374151; /* gray-700 */ }

        /* Styling for active sort buttons */
        .sort-btn-active {
            background-color: #0ea5e9 !important; /* sky-500 */
            color: white !important;
        }
        .dark .sort-btn-active { background-color: #0284c7 !important; /* sky-600 */ }

        /* Styling for buttons within the settings modal and feature flag items */
        .settings-modal-button, .feature-flag-item button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            text-align: left;
            font-weight: 500; /* medium */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s ease-in-out;
        }
        .settings-modal-button i {
            margin-right: 0.75rem; /* mr-3 */
            width: 1.25rem; /* w-5 */
            text-align: center;
        }
        .settings-modal-button.disabled-feature-button {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
        }
        .dark .settings-modal-button.disabled-feature-button {
            background-color: #4b5563; /* gray-600 */
            color: #9ca3af; /* gray-400 */
        }

        /* Styling for feature flag items */
        .feature-flag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0.5rem; /* py-3 px-2 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .feature-flag-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .dark .feature-flag-item:hover {
            background-color: #374151; /* gray-700 */
        }
        .feature-flag-label {
            font-weight: 500; /* medium */
            color: #374151; /* gray-700 */
        }
        .dark .feature-flag-label {
            color: #d1d5db; /* gray-300 */
        }

        /* UI elements related to features (can be hidden by feature flag) */
        .reminder-feature-element,
        .task-timer-system-element,
        .advanced-recurrence-element,
        .file-attachments-element,
        .integrations-services-element,
        .user-accounts-element,
        .collaboration-sharing-element,
        .cross-device-sync-element,
        .tooltips-guide-element, /* Existing */
        .kanban-board-feature-element, /* New for Kanban */
        .subtasks-feature-element, /* New for Subtasks */
        .projects-feature-element, /* New for Projects */
        .advanced-search-filters-feature-element, /* New for Advanced Search */
        .keyboard-shortcuts-feature-element, /* New for Keyboard Shortcuts */
        .data-export-import-feature-element, /* New for Export/Import */
        .calendar-view-feature-element, /* New for Calendar View */
        .task-dependencies-feature-element /* New for Task Dependencies */
        { display: block; } /* Default, JS hides if feature off */

        /* Toggle Switch Styles */
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        .toggle-checkbox + .toggle-label {
            display: block;
            position: relative;
            width: 2.5rem; /* w-10 */
            height: 1.5rem; /* h-6 */
            background-color: #d1d5db; /* gray-300 */
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .dark .toggle-checkbox + .toggle-label {
            background-color: #4b5563; /* gray-600 */
        }
        .toggle-checkbox + .toggle-label::after { /* The sliding circle */
            content: '';
            position: absolute;
            top: 0.125rem; /* top-0.5 */
            left: 0.125rem; /* left-0.5 */
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            background-color: white;
            border-radius: 9999px; /* rounded-full */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            transition: transform 0.2s ease-in-out;
        }
        .dark .toggle-checkbox + .toggle-label::after {
            background-color: #e5e7eb; /* gray-200 */
            border-color: #374151; /* gray-700 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0ea5e9 !important; /* sky-500 */
        }
        .dark .toggle-checkbox:checked + .toggle-label {
            background-color: #0284c7 !important; /* sky-600 */
        }
        .toggle-checkbox:checked + .toggle-label::after {
            transform: translateX(1rem); /* Moves the circle to the right */
            background-color: white !important;
        }
        .dark .toggle-checkbox:checked + .toggle-label::after {
            background-color: white !important;
        }

        /* Placeholder for file input */
        .file-input-placeholder {
            border: 2px dashed #cbd5e1; /* border-slate-300 */
            padding: 1rem;
            text-align: center;
            border-radius: 0.375rem; /* rounded-md */
            color: #64748b; /* slate-500 */
        }
        .dark .file-input-placeholder {
            border-color: #475569; /* slate-600 */
            color: #94a3b8; /* slate-400 */
        }
        .input-example-text {
            font-size: 0.75rem; /* text-xs */
            color: #64748b; /* slate-500 */
            margin-left: 0.25rem; /* ml-1 */
        }
        .dark .input-example-text {
            color: #94a3b8; /* slate-400 */
        }

        /* Kanban Board Styles */
        .kanban-board-container {
            display: flex;
            gap: 1rem; /* Space between columns */
            overflow-x: auto; /* Allow horizontal scrolling for columns */
            padding-bottom: 1rem; /* Space for scrollbar */
        }
        .kanban-column {
            flex: 0 0 300px; /* Fixed width for columns, prevent shrinking */
            min-width: 300px;
            max-width: 300px;
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); /* shadow-md */
        }
        .dark .kanban-column {
            background-color: #374151; /* gray-700 */
        }
        .kanban-column-header {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: text;
        }
        .dark .kanban-column-header {
            color: #f3f4f6; /* gray-100 */
        }
        .kanban-column-header:focus {
            outline: 2px solid #0ea5e9; /* sky-500 */
            background-color: white;
        }
        .dark .kanban-column-header:focus {
            background-color: #4b5563; /* gray-600 */
        }
        .kanban-tasks {
            min-height: 100px; /* Minimum height for drag-and-drop area */
            /* Add more styling for task cards within the column later */
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Space between task cards */
        }
        .kanban-task-card {
            background-color: white;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); /* shadow-sm */
            cursor: grab;
        }
        .dark .kanban-task-card {
            background-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }
        .kanban-task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .kanban-view-toggle-btn {
            margin-left: 0.5rem; /* Add some space next to the label filter */
        }

        /* Subtask Styles (placeholder for task details modal) */
        .subtask-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
        }
        .subtask-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .subtask-item input[type="text"] {
            flex-grow: 1;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
        }
        .dark .subtask-item input[type="text"] {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #e5e7eb; /* gray-200 */
        }

    </style>
    <script>
        // Apply theme on initial load
        function applyInitialTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyInitialTheme();
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen flex flex-col items-center justify-start pt-8 sm:pt-10 p-2 sm:p-4 selection:bg-sky-400 selection:text-white dark:selection:bg-sky-600 dark:selection:text-white">

    <div id="messageBox" class="message-box"></div>
    <div id="iconTooltip"></div>

    <div id="addTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[150]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogAdd">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Add New Task</h3>
                <button id="closeAddModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="modalTodoFormAdd">
                <div>
                    <label for="modalTaskInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Task Description <span class="input-example-text">(e.g., "Buy milk tomorrow", "Call John next Monday")</span></label>
                    <input type="text" id="modalTaskInputAdd" placeholder="Enter task description..." class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="modalDueDateInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Due Date (optional)</label>
                        <input type="date" id="modalDueDateInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="modalTimeInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time (optional)</label>
                        <input type="time" id="modalTimeInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 task-timer-system-element">
                    <div>
                        <label for="modalEstHoursAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Est. Hours (optional)</label>
                        <input type="number" id="modalEstHoursAdd" min="0" placeholder="0" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                    </div>
                    <div>
                        <label for="modalEstMinutesAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Est. Minutes (optional)</label>
                        <input type="number" id="modalEstMinutesAdd" min="0" max="59" step="1" placeholder="0" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="modalPriorityInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Priority</label>
                    <select id="modalPriorityInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <div class="mt-4 advanced-recurrence-element">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Recurrence (Coming Soon)</label>
                    <div class="p-3 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-500 dark:text-slate-400 text-center">
                        Advanced scheduling options will appear here.
                    </div>
                </div>

                <div class="mt-4">
                    <label for="modalLabelInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Label (e.g., Work, Personal)</label>
                    <input type="text" id="modalLabelInputAdd" list="existingLabels" placeholder="Type or select a label" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    <datalist id="existingLabels"></datalist>
                </div>

                <div id="modalProjectSelectionAddContainer" class="mt-4 projects-feature-element hidden">
                    <label for="modalProjectInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Project (optional)</label>
                    <select id="modalProjectInputAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                        <option value="">No Project</option>
                        </select>
                </div>


                <div class="mt-4 flex items-center space-x-3 reminder-feature-element" id="modalRemindMeAddContainer">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Remind Me</span>
                    <div class="relative">
                        <input type="checkbox" id="modalRemindMeAdd" name="modalRemindMeAddToggle" class="toggle-checkbox"/>
                        <label for="modalRemindMeAdd" class="toggle-label"></label>
                    </div>
                </div>
                <div id="reminderOptionsAdd" class="hidden mt-3 space-y-3 border-t border-slate-200 dark:border-slate-700 pt-3 reminder-feature-element">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="modalReminderDateAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Reminder Date</label>
                            <input type="date" id="modalReminderDateAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                        </div>
                        <div>
                            <label for="modalReminderTimeAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Reminder Time</label>
                            <input type="time" id="modalReminderTimeAdd" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                        </div>
                    </div>
                    <div>
                        <label for="modalReminderEmailAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Address</label>
                        <input type="email" id="modalReminderEmailAdd" placeholder="Enter email for reminder" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    </div>
                </div>

                <div class="mt-4 file-attachments-element">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Attachments (Coming Soon)</label>
                    <div class="file-input-placeholder">
                        <i class="fas fa-paperclip mr-2"></i> Click or drag files to attach.
                    </div>
                </div>

                <div id="modalSubtasksAddContainer" class="mt-4 subtasks-feature-element hidden">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subtasks</label>
                        <button type="button" id="addModalSubtaskBtn" class="text-sm text-sky-500 hover:text-sky-600 font-medium">+ Add Subtask</button>
                    </div>
                    <div id="modalSubtaskListAdd" class="space-y-2 max-h-32 overflow-y-auto">
                        </div>
                </div>

                <div id="modalDependenciesAddContainer" class="mt-4 task-dependencies-feature-element hidden">
                     <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Dependencies (Select tasks this task depends on)</label>
                    <select multiple id="modalDependsOnSelectAdd" class="w-full p-2 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 h-24">
                        </select>
                </div>


                <div class="mt-4">
                    <label for="modalNotesInputAdd" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Notes</label>
                    <textarea id="modalNotesInputAdd" placeholder="Add any relevant notes..." rows="3" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancelAddModalBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewEditTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[150]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogViewEdit">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Edit Task Details</h3>
                <button id="closeViewEditModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="modalTodoFormViewEdit">
                <input type="hidden" id="modalViewEditTaskId">
                <div>
                    <label for="modalTaskInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Task Description <span class="input-example-text">(e.g., "Buy milk tomorrow", "Call John next Monday")</span></label>
                    <input type="text" id="modalTaskInputViewEdit" placeholder="e.g., Buy groceries" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="modalDueDateInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Due Date</label>
                        <input type="date" id="modalDueDateInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="modalTimeInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Time</label>
                        <input type="time" id="modalTimeInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 task-timer-system-element">
                    <div>
                        <label for="modalEstHoursViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Est. Hours (optional)</label>
                        <input type="number" id="modalEstHoursViewEdit" min="0" placeholder="0" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                    </div>
                    <div>
                        <label for="modalEstMinutesViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Est. Minutes (optional)</label>
                        <input type="number" id="modalEstMinutesViewEdit" min="0" max="59" step="1" placeholder="0" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="modalPriorityInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Priority</label>
                    <select id="modalPriorityInputViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <div class="mt-4 advanced-recurrence-element">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Recurrence (Coming Soon)</label>
                    <div class="p-3 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-500 dark:text-slate-400 text-center">
                        Advanced scheduling options will appear here.
                    </div>
                </div>

                <div class="mt-4">
                    <label for="modalLabelInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Label</label>
                    <input type="text" id="modalLabelInputViewEdit" list="existingLabelsEdit" placeholder="Type or select a label" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    <datalist id="existingLabelsEdit"></datalist>
                </div>

                <div id="modalProjectSelectionEditContainer" class="mt-4 projects-feature-element hidden">
                    <label for="modalProjectInputEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Project</label>
                    <select id="modalProjectInputEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                         <option value="">No Project</option>
                        </select>
                </div>

                <div class="mt-4 flex items-center space-x-3 reminder-feature-element" id="modalRemindMeViewEditContainer">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Remind Me</span>
                    <div class="relative">
                        <input type="checkbox" id="modalRemindMeViewEdit" name="modalRemindMeViewEditToggle" class="toggle-checkbox"/>
                        <label for="modalRemindMeViewEdit" class="toggle-label"></label>
                    </div>
                </div>
                <div id="reminderOptionsViewEdit" class="hidden mt-3 space-y-3 border-t border-slate-200 dark:border-slate-700 pt-3 reminder-feature-element">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="modalReminderDateViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Reminder Date</label>
                            <input type="date" id="modalReminderDateViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                        </div>
                        <div>
                            <label for="modalReminderTimeViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Reminder Time</label>
                            <input type="time" id="modalReminderTimeViewEdit" class="w-full p-3 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 dark:[color-scheme:dark]">
                        </div>
                    </div>
                    <div>
                        <label for="modalReminderEmailViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email Address</label>
                        <input type="email" id="modalReminderEmailViewEdit" placeholder="Enter email for reminder" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                    </div>
                </div>

                <div class="mt-4 file-attachments-element">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Attachments (Coming Soon)</label>
                    <div class="file-input-placeholder">
                        <i class="fas fa-paperclip mr-2"></i> Click or drag files to attach.
                        <div id="existingAttachmentsViewEdit" class="mt-2 text-xs"></div>
                    </div>
                </div>

                 <div id="modalSubtasksEditContainer" class="mt-4 subtasks-feature-element hidden">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Subtasks</label>
                        <button type="button" id="editModalSubtaskBtn" class="text-sm text-sky-500 hover:text-sky-600 font-medium">+ Add Subtask</button>
                    </div>
                    <div id="modalSubtaskListEdit" class="space-y-2 max-h-32 overflow-y-auto">
                        </div>
                </div>

                 <div id="modalDependenciesEditContainer" class="mt-4 task-dependencies-feature-element hidden">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Dependencies (Select tasks this task depends on)</label>
                   <select multiple id="modalDependsOnSelectEdit" class="w-full p-2 border-2 bg-white text-slate-900 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600 h-24">
                       </select>
               </div>


                <div class="mt-4">
                    <label for="modalNotesInputViewEdit" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Notes</label>
                    <textarea id="modalNotesInputViewEdit" placeholder="Add any relevant notes..." rows="3" class="w-full p-3 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-shadow duration-300 dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancelViewEditModalBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewTaskDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[160]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogViewDetails">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Task Information</h3>
                <button id="closeViewDetailsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm text-slate-700 dark:text-slate-300">
                <div>
                    <strong class="view-details-heading block mb-0.5">Description:</strong>
                    <p id="viewTaskText" class="break-all"></p>
                </div>

                <div id="viewSubtasksSection" class="subtasks-feature-element hidden pt-3 mt-3 border-t border-slate-200 dark:border-slate-700">
                    <strong class="view-details-heading block mb-1">Subtasks:</strong>
                    <div id="viewSubtasksList" class="space-y-1">
                        </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                    <div>
                        <strong class="view-details-heading block mb-0.5">Due Date:</strong>
                        <p id="viewTaskDueDate"></p>
                    </div>
                    <div>
                        <strong class="view-details-heading block mb-0.5">Time:</strong>
                        <p id="viewTaskTime"></p>
                    </div>
                </div>
                <div class="task-timer-system-element">
                    <strong class="view-details-heading block mb-0.5">Estimated Duration:</strong>
                    <p id="viewTaskEstDuration"></p>
                </div>

                <div id="taskTimerSection" class="mt-3 border-t border-slate-200 dark:border-slate-700 pt-3 task-timer-system-element">
                    <strong class="view-details-heading block mb-1">Track Time:</strong>
                    <div class="flex items-center justify-between mb-2">
                        <span id="viewTaskTimerDisplay" class="text-xl font-mono text-slate-700 dark:text-slate-200">00:00:00</span>
                        <div id="timerButtonsContainer" class="flex gap-2">
                            <button id="viewTaskStartTimerBtn" type="button" class="timer-btn px-3 py-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">Start</button>
                            <button id="viewTaskPauseTimerBtn" type="button" class="timer-btn px-3 py-1.5 bg-amber-500 text-white rounded-md hover:bg-amber-600 text-sm hidden">Pause</button>
                            <button id="viewTaskStopTimerBtn" type="button" class="timer-btn px-3 py-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden">Stop</button>
                        </div>
                    </div>
                    <div>
                        <strong class="view-details-heading block mb-0.5">Recorded Duration:</strong>
                        <p id="viewTaskActualDuration">Not yet recorded.</p>
                    </div>
                </div>

                <div id="viewTaskAttachmentsSection" class="mt-3 border-t border-slate-200 dark:border-slate-700 pt-3 file-attachments-element">
                    <strong class="view-details-heading block mb-1">Attachments (Coming Soon):</strong>
                    <div id="viewTaskAttachmentsList" class="text-slate-500 dark:text-slate-400">
                        Attached files will be listed here.
                    </div>
                </div>


                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                    <div>
                        <strong class="view-details-heading block mb-0.5">Priority:</strong>
                        <p id="viewTaskPriority" class="capitalize"></p>
                    </div>
                    <div>
                        <strong class="view-details-heading block mb-0.5">Status:</strong>
                        <p id="viewTaskStatus" class="capitalize"></p>
                    </div>
                </div>
                <div class="projects-feature-element hidden"> <strong class="view-details-heading block mb-0.5">Project:</strong>
                    <p id="viewTaskProject" class="capitalize"></p>
                </div>
                <div>
                    <strong class="view-details-heading block mb-0.5">Label:</strong>
                    <p id="viewTaskLabel" class="capitalize"></p>
                </div>
                <div id="viewTaskDependenciesSection" class="task-dependencies-feature-element hidden pt-3 mt-3 border-t border-slate-200 dark:border-slate-700">
                    <div id="viewTaskDependsOn" class="mb-2">
                        <strong class="view-details-heading block mb-0.5">Depends On:</strong>
                        <ul id="viewTaskDependsOnList" class="list-disc list-inside"></ul>
                    </div>
                    <div id="viewTaskBlockedBy" class="mb-2">
                        <strong class="view-details-heading block mb-0.5">Blocking:</strong>
                         <ul id="viewTaskBlockedByList" class="list-disc list-inside"></ul>
                    </div>
                </div>
                <div>
                    <strong class="view-details-heading block mb-0.5">Notes:</strong>
                    <p id="viewTaskNotes" class="mt-1 break-all whitespace-pre-wrap"></p>
                </div>
                <div id="viewTaskReminderSection" class="border-t border-slate-200 dark:border-slate-700 pt-3 mt-3 space-y-2 reminder-feature-element">
                    <div>
                        <strong class="view-details-heading block mb-0.5">Reminder:</strong>
                        <p id="viewTaskReminderStatus"></p>
                    </div>
                    <div id="viewTaskReminderDetails" class="hidden space-y-2">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                            <div>
                                <strong class="view-details-heading block mb-0.5">Reminder Date:</strong>
                                <p id="viewTaskReminderDate"></p>
                            </div>
                            <div>
                                <strong class="view-details-heading block mb-0.5">Reminder Time:</strong>
                                <p id="viewTaskReminderTime"></p>
                            </div>
                        </div>
                        <div>
                            <strong class="view-details-heading block mb-0.5">Reminder Email:</strong>
                            <p id="viewTaskReminderEmail"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="editFromViewModalBtn" class="px-5 py-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors font-semibold">Edit Task</button>
                <button type="button" id="deleteFromViewModalBtn" class="px-5 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold">Delete Task</button> <button type="button" id="closeViewDetailsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>

    <div id="taskReviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[185]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogTaskReview">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Task Review</h3>
                <button id="closeTaskReviewModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="taskReviewContent" class="space-y-3 max-h-96 overflow-y-auto">
                </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeTaskReviewSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>

    <div id="tooltipsGuideModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[186]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogTooltipsGuide">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Tooltips & Shortcuts Guide</h3>
                <button id="closeTooltipsGuideModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="tooltipsGuideContent" class="space-y-3 text-sm text-slate-700 dark:text-slate-300 max-h-96 overflow-y-auto">
                <p>Welcome to the Tooltips & Shortcuts Guide! Here are some ways to use the app more efficiently:</p>
                <ul class="list-disc list-inside space-y-2 pl-2">
                    <li><strong>Add New Task Shortcut:</strong> Press <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">+</kbd> or <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">=</kbd> to quickly open the "Add New Task" dialog.</li>
                    <li><strong>Smart Due Dates:</strong> When typing a task description, you can use natural language for dates, such as:
                        <ul class="list-['-_'] list-inside pl-4 space-y-1">
                            <li>"<em>Task name</em> <strong>today</strong>"</li>
                            <li>"<em>Task name</em> <strong>tomorrow</strong>"</li>
                            <li>"<em>Task name</em> <strong>next Monday</strong>" (or any day of the week)</li>
                            <li>"<em>Task name</em> <strong>next week</strong>"</li>
                            <li>"<em>Task name</em> <strong>on 2025-12-25</strong>"</li>
                            <li>"<em>Task name</em> <strong>due 12/25</strong>" (assumes current year)</li>
                        </ul>
                        The app will try to parse these and set the due date automatically if you haven't set one explicitly.
                    </li>
                    <li><strong>Sidebar Tooltips:</strong> When the sidebar is minimized, hover over the icons to see a tooltip describing their function.</li>
                     <li><strong>Escape Key:</strong> Press <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500">Esc</kbd> to close any open modal dialog.</li>
                    <div class="keyboard-shortcuts-feature-element hidden">
                        <li><strong>More Shortcuts:</strong>
                            <ul class="list-['-_'] list-inside pl-4 space-y-1">
                                <li><kbd>C</kbd>: Mark selected/focused task as complete/incomplete.</li>
                                <li><kbd>E</kbd>: Edit selected/focused task.</li>
                                <li><kbd>P</kbd>: Cycle priority of selected/focused task.</li>
                                <li><kbd>S</kbd>: Open search.</li>
                            </ul>
                        </li>
                    </div>
                </ul>
                <p>More tips and tricks will be added here as new features roll out!</p>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeTooltipsGuideSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>


    <div id="manageLabelsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[170]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-md shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogManageLabels">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Manage Labels</h3>
                <button id="closeManageLabelsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addNewLabelForm" class="flex gap-2 mb-4">
                <input type="text" id="newLabelInput" placeholder="New label name" class="flex-grow p-2.5 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold p-2.5 rounded-lg shadow-md">Add</button>
            </form>
            <h4 class="text-lg font-medium text-slate-700 dark:text-slate-200 mb-2">Existing Labels:</h4>
            <ul id="existingLabelsList" class="max-h-60 overflow-y-auto space-y-1 pr-1"></ul>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeManageLabelsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>

    <div id="manageProjectsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[175] projects-feature-element">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-md shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogManageProjects">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Manage Projects</h3>
                <button id="closeManageProjectsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addNewProjectForm" class="flex gap-2 mb-4">
                <input type="text" id="newProjectInput" placeholder="New project name" class="flex-grow p-2.5 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold p-2.5 rounded-lg shadow-md">Add</button>
            </form>
            <h4 class="text-lg font-medium text-slate-700 dark:text-slate-200 mb-2">Existing Projects:</h4>
            <ul id="existingProjectsList" class="max-h-60 overflow-y-auto space-y-1 pr-1"></ul>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeManageProjectsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>


    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[180]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-md shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogSettings">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Settings</h3>
                <button id="closeSettingsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="space-y-3">
                <button id="settingsTooltipsGuideBtn" type="button" class="settings-modal-button bg-blue-50 hover:bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:hover:bg-blue-800/70 dark:text-blue-300 tooltips-guide-element">
                    <i class="fas fa-question-circle"></i> Tooltips Guide
                </button>
                 <button id="settingsTaskReviewBtn" type="button" class="settings-modal-button bg-cyan-50 hover:bg-cyan-100 text-cyan-700 dark:bg-cyan-900/50 dark:hover:bg-cyan-800/70 dark:text-cyan-300 task-timer-system-element">
                    <i class="fas fa-history"></i> Task Review
                </button>
                <button id="settingsClearCompletedBtn" type="button" class="settings-modal-button bg-red-50 hover:bg-red-100 text-red-700 dark:bg-red-900/50 dark:hover:bg-red-800/70 dark:text-red-300">
                    <i class="fas fa-eraser"></i> Clear Completed Tasks
                </button>
                <button id="settingsManageLabelsBtn" type="button" class="settings-modal-button bg-indigo-50 hover:bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:hover:bg-indigo-800/70 dark:text-indigo-300">
                    <i class="fas fa-tags"></i> Manage Labels
                </button>
                <button id="settingsManageProjectsBtn" type="button" class="settings-modal-button bg-emerald-50 hover:bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:hover:bg-emerald-800/70 dark:text-emerald-300 projects-feature-element hidden">
                    <i class="fas fa-project-diagram"></i> Manage Projects
                </button>
                <button id="settingsManageRemindersBtn" type="button" class="settings-modal-button bg-teal-50 hover:bg-teal-100 text-teal-700 dark:bg-teal-900/50 dark:hover:bg-teal-800/70 dark:text-teal-300 reminder-feature-element">
                    <i class="fas fa-bell"></i> Manage Reminders
                </button>

                <div class="data-export-import-feature-element hidden"> <button id="settingsExportDataBtn" type="button" class="settings-modal-button bg-lime-50 hover:bg-lime-100 text-lime-700 dark:bg-lime-900/50 dark:hover:bg-lime-800/70 dark:text-lime-300">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                    <button id="settingsImportDataBtn" type="button" class="settings-modal-button bg-green-50 hover:bg-green-100 text-green-700 dark:bg-green-900/50 dark:hover:bg-green-800/70 dark:text-green-300 mt-2">
                        <i class="fas fa-file-import"></i> Import Data
                    </button>
                    <input type="file" id="importFilePicker" class="hidden" accept=".json">
                </div>

                <button id="settingsIntegrationsBtn" type="button" class="settings-modal-button bg-orange-50 hover:bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:hover:bg-orange-800/70 dark:text-orange-300 integrations-services-element">
                    <i class="fas fa-cogs"></i> Integrations (Soon)
                </button>
                <button id="settingsUserAccountsBtn" type="button" class="settings-modal-button bg-lime-50 hover:bg-lime-100 text-lime-700 dark:bg-lime-900/50 dark:hover:bg-lime-800/70 dark:text-lime-300 user-accounts-element">
                    <i class="fas fa-users"></i> User Accounts (Soon)
                </button>
                <button id="settingsCollaborationBtn" type="button" class="settings-modal-button bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-700 dark:bg-fuchsia-900/50 dark:hover:bg-fuchsia-800/70 dark:text-fuchsia-300 collaboration-sharing-element">
                    <i class="fas fa-share-alt"></i> Collaboration (Soon)
                </button>
                <button id="settingsSyncBackupBtn" type="button" class="settings-modal-button bg-sky-50 hover:bg-sky-100 text-sky-700 dark:bg-sky-900/50 dark:hover:bg-sky-800/70 dark:text-sky-300 cross-device-sync-element">
                    <i class="fas fa-sync-alt"></i> Sync & Backup (Soon)
                </button>

                <button id="settingsFeatureFlagsBtn" type="button" class="settings-modal-button bg-purple-50 hover:bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:hover:bg-purple-800/70 dark:text-purple-300">
                    <i class="fas fa-flag"></i> Manage Feature Flags
                </button>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeSettingsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Close</button>
            </div>
        </div>
    </div>
    <div id="featureFlagsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full flex items-center justify-center hidden z-[190]">
        <div class="relative mx-auto p-5 sm:p-6 border w-full max-w-md shadow-xl rounded-xl bg-white dark:bg-slate-800 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="modalDialogFeatureFlags">
            <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Manage Feature Flags</h3>
                <button id="closeFeatureFlagsModalBtn" type="button" class="text-slate-400 hover:text-slate-600 dark:text-slate-300 dark:hover:text-slate-100 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Close modal">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="featureFlagsListContainer" class="space-y-2">
                </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeFeatureFlagsSecondaryBtn" class="px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500 transition-colors font-medium">Done</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-6xl mx-auto">
        <h1 class="text-4xl sm:text-5xl font-bold text-center text-white mb-8 sm:mb-10">My Todo List</h1>

        <div class="flex flex-col md:flex-row gap-6 lg:gap-8">
            <aside id="taskSidebar" class="bg-slate-100 dark:bg-slate-800 rounded-xl shadow-xl flex-shrink-0 md:sticky md:top-10 md:self-start sticky-sidebar w-full md:w-72 lg:w-80 p-3 sm:p-4 md:p-5">
                <div class="space-y-4 md:space-y-6">
                    <div class="flex justify-between items-center mb-2 md:mb-3">
                        <h2 class="sidebar-text-content text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200">Menu</h2>
                        <button id="sidebarToggleBtn" title="Toggle Sidebar" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">
                            <i id="sidebarToggleIcon" class="fas fa-chevron-left"></i>
                        </button>
                    </div>

                    <div>
                        <button
                            id="openAddModalButton"
                            type="button"
                            title="Add New Task (+)"
                            class="bg-sky-500 hover:bg-sky-600 text-white font-semibold p-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 w-full flex items-center sidebar-button-icon-only justify-center"
                        >
                            <i class="fas fa-plus mr-0"></i> <span class="sidebar-text-content ml-2">Add New Task</span>
                        </button>
                    </div>

                    <div id="taskSearchInputContainer">
                        <label for="taskSearchInput" class="sidebar-text-content sidebar-section-title text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3 block">Search Tasks</label>
                        <div class="relative">
                            <input type="text" id="taskSearchInput" placeholder="Search by title or use filters..." class="w-full p-2.5 pl-10 border-2 bg-white text-slate-900 placeholder-slate-400 border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none dark:bg-slate-700 dark:text-slate-200 dark:placeholder-slate-400 dark:border-slate-600">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 dark:text-slate-500"></i>
                        </div>
                        <p id="advancedSearchHelpText" class="text-xs text-slate-500 dark:text-slate-400 mt-1 hidden advanced-search-filters-feature-element">
                            Use: <code>priority:high</code>, <code>label:work</code>, <code>project:alpha</code>, <code>due:today</code>, <code>due:yyyy-mm-dd</code>
                        </p>
                    </div>

                    <div>
                        <h2 class="sidebar-text-content sidebar-section-title text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3">Smart Views</h2>
                        <div class="flex flex-col gap-2" id="smartViewButtonsContainer">
                            <button title="Inbox" class="smart-view-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="inbox">
                                <i class="fas fa-inbox w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Inbox</span>
                            </button>
                            <button title="Today" class="smart-view-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="today">
                                <i class="fas fa-calendar-day w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Today</span>
                            </button>
                            <button title="Upcoming" class="smart-view-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="upcoming">
                                <i class="fas fa-calendar-alt w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Upcoming</span>
                            </button>
                            <button title="Completed Tasks" class="smart-view-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center" data-filter="completed">
                                <i class="fas fa-check-circle w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">Completed</span>
                            </button>
                        </div>
                    </div>

                    <div id="projectsFilterContainer" class="projects-feature-element hidden">
                        <h2 class="sidebar-text-content sidebar-section-title text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3 mt-4">Projects</h2>
                        <div id="projectFilterButtonsContainer" class="flex flex-col gap-2">
                            </div>
                    </div>


                    <div>
                        <h2 class="sidebar-text-content sidebar-section-title text-lg md:text-xl font-semibold text-slate-700 dark:text-slate-200 mb-2 md:mb-3 mt-4">Settings</h2>
                        <button
                            id="openSettingsModalButton"
                            title="Open Settings"
                            class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2.5 px-3 md:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 w-full flex items-center sidebar-button-icon-only justify-center"
                        >
                            <i class="fas fa-cog mr-0"></i> <span class="sidebar-text-content ml-2">Settings</span>
                        </button>
                    </div>
                    <div id="testFeatureButtonContainer" class="hidden mt-2">
                        <button
                            id="testFeatureButton"
                            title="Test Feature Button"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2.5 px-3 md:px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 w-full flex items-center sidebar-button-icon-only justify-center"
                        >
                            <i class="fas fa-flask mr-0"></i> <span class="sidebar-text-content ml-2">Test Button</span>
                        </button>
                    </div>
                </div>
            </aside>

            <main class="w-full flex-grow bg-white dark:bg-slate-900 p-4 md:p-6 lg:p-8 rounded-xl shadow-2xl min-h-[300px] mt-4 md:mt-0">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6">
                    <h2 id="mainContentTitle" class="text-xl sm:text-2xl md:text-3xl font-semibold text-slate-800 dark:text-slate-100">Your Tasks</h2>
                    <div class="flex gap-2 mt-3 sm:mt-0 flex-wrap">
                        <button id="sortByDueDateBtn" title="Sort by Due Date" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-sort-amount-down mr-1.5"></i> Due Date
                        </button>
                        <button id="sortByPriorityBtn" title="Sort by Priority" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-exclamation-circle mr-1.5"></i> Priority
                        </button>
                        <button id="sortByLabelBtn" title="Sort by Label" class="sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i class="fas fa-tags mr-1.5"></i> Label
                        </button>
                        <button id="kanbanViewToggleBtn" title="Switch to Board View" class="kanban-board-feature-element hidden sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center kanban-view-toggle-btn">
                            <i id="kanbanViewToggleIcon" class="fas fa-columns mr-1.5"></i> <span id="kanbanViewToggleText">Board</span>
                        </button>
                         <button id="calendarViewToggleBtn" title="Switch to Calendar View" class="calendar-view-feature-element hidden sort-btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs sm:text-sm font-medium py-2 px-3 rounded-lg transition-colors duration-300 flex items-center">
                            <i id="calendarViewToggleIcon" class="fas fa-calendar-week mr-1.5"></i> <span id="calendarViewToggleText">Calendar</span>
                        </button>
                    </div>
                </div>
                <ul id="taskList" class="space-y-3 sm:space-y-3.5"></ul>
                <div id="kanbanBoard" class="kanban-board-container hidden kanban-board-feature-element">
                    </div>
                <div id="calendarView" class="hidden calendar-view-feature-element">
                    </div>
                <p id="emptyState" class="text-center text-slate-500 dark:text-slate-400 mt-8 py-5 hidden">No tasks yet. Add some!</p>
                <p id="noMatchingTasks" class="text-center text-slate-500 dark:text-slate-400 mt-8 py-5 hidden">No tasks match the current filter or search.</p>
            </main>
        </div>
    </div>

    <footer class="text-center text-slate-400 dark:text-slate-500 mt-10 sm:mt-12 mb-6 text-sm">
        <p>LockieMedia &copy; 2025</p>
    </footer>

    <script>
        // --- DOM Elements ---
        // Sidebar elements
        const taskSidebar = document.getElementById('taskSidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
        const sidebarTextElements = taskSidebar.querySelectorAll('.sidebar-text-content');
        const sidebarIconOnlyButtons = taskSidebar.querySelectorAll('.sidebar-button-icon-only');
        const iconTooltip = document.getElementById('iconTooltip');

        // Main content elements
        const mainContentTitle = document.getElementById('mainContentTitle'); // New
        const sortByDueDateBtn = document.getElementById('sortByDueDateBtn');
        const sortByPriorityBtn = document.getElementById('sortByPriorityBtn');
        const sortByLabelBtn = document.getElementById('sortByLabelBtn');
        const taskSearchInput = document.getElementById('taskSearchInput');
        const advancedSearchHelpText = document.getElementById('advancedSearchHelpText'); // New
        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const noMatchingTasks = document.getElementById('noMatchingTasks');
        const smartViewButtonsContainer = document.getElementById('smartViewButtonsContainer');
        const smartViewButtons = smartViewButtonsContainer.querySelectorAll('.smart-view-btn');
        const messageBox = document.getElementById('messageBox');

        // Add Task Modal elements
        const addTaskModal = document.getElementById('addTaskModal');
        const modalDialogAdd = document.getElementById('modalDialogAdd');
        const openAddModalButton = document.getElementById('openAddModalButton');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const modalTodoFormAdd = document.getElementById('modalTodoFormAdd');
        const modalTaskInputAdd = document.getElementById('modalTaskInputAdd');
        const modalDueDateInputAdd = document.getElementById('modalDueDateInputAdd');
        const modalTimeInputAdd = document.getElementById('modalTimeInputAdd');
        const modalEstHoursAdd = document.getElementById('modalEstHoursAdd');
        const modalEstMinutesAdd = document.getElementById('modalEstMinutesAdd');
        const modalPriorityInputAdd = document.getElementById('modalPriorityInputAdd');
        const modalLabelInputAdd = document.getElementById('modalLabelInputAdd');
        const existingLabelsDatalist = document.getElementById('existingLabels');
        const modalNotesInputAdd = document.getElementById('modalNotesInputAdd');
        const modalRemindMeAddContainer = document.getElementById('modalRemindMeAddContainer');
        const modalRemindMeAdd = document.getElementById('modalRemindMeAdd');
        const reminderOptionsAdd = document.getElementById('reminderOptionsAdd');
        const modalReminderDateAdd = document.getElementById('modalReminderDateAdd');
        const modalReminderTimeAdd = document.getElementById('modalReminderTimeAdd');
        const modalReminderEmailAdd = document.getElementById('modalReminderEmailAdd');
        // New for Subtasks in Add Modal
        const modalSubtasksAddContainer = document.getElementById('modalSubtasksAddContainer');
        const addModalSubtaskBtn = document.getElementById('addModalSubtaskBtn');
        const modalSubtaskListAdd = document.getElementById('modalSubtaskListAdd');
        // New for Projects in Add Modal
        const modalProjectSelectionAddContainer = document.getElementById('modalProjectSelectionAddContainer');
        const modalProjectInputAdd = document.getElementById('modalProjectInputAdd');
        // New for Dependencies in Add Modal
        const modalDependenciesAddContainer = document.getElementById('modalDependenciesAddContainer');
        const modalDependsOnSelectAdd = document.getElementById('modalDependsOnSelectAdd');


        // View/Edit Task Modal elements
        const viewEditTaskModal = document.getElementById('viewEditTaskModal');
        const modalDialogViewEdit = document.getElementById('modalDialogViewEdit');
        const closeViewEditModalBtn = document.getElementById('closeViewEditModalBtn');
        const cancelViewEditModalBtn = document.getElementById('cancelViewEditModalBtn');
        const modalTodoFormViewEdit = document.getElementById('modalTodoFormViewEdit');
        const modalViewEditTaskId = document.getElementById('modalViewEditTaskId');
        const modalTaskInputViewEdit = document.getElementById('modalTaskInputViewEdit');
        const modalDueDateInputViewEdit = document.getElementById('modalDueDateInputViewEdit');
        const modalTimeInputViewEdit = document.getElementById('modalTimeInputViewEdit');
        const modalEstHoursViewEdit = document.getElementById('modalEstHoursViewEdit');
        const modalEstMinutesViewEdit = document.getElementById('modalEstMinutesViewEdit');
        const modalPriorityInputViewEdit = document.getElementById('modalPriorityInputViewEdit');
        const modalLabelInputViewEdit = document.getElementById('modalLabelInputViewEdit');
        const existingLabelsEditDatalist = document.getElementById('existingLabelsEdit');
        const modalNotesInputViewEdit = document.getElementById('modalNotesInputViewEdit');
        const modalRemindMeViewEditContainer = document.getElementById('modalRemindMeViewEditContainer');
        const modalRemindMeViewEdit = document.getElementById('modalRemindMeViewEdit');
        const reminderOptionsViewEdit = document.getElementById('reminderOptionsViewEdit');
        const modalReminderDateViewEdit = document.getElementById('modalReminderDateViewEdit');
        const modalReminderTimeViewEdit = document.getElementById('modalReminderTimeViewEdit');
        const modalReminderEmailViewEdit = document.getElementById('modalReminderEmailViewEdit');
        const existingAttachmentsViewEdit = document.getElementById('existingAttachmentsViewEdit');
        // New for Subtasks in Edit Modal
        const modalSubtasksEditContainer = document.getElementById('modalSubtasksEditContainer');
        const editModalSubtaskBtn = document.getElementById('editModalSubtaskBtn');
        const modalSubtaskListEdit = document.getElementById('modalSubtaskListEdit');
        // New for Projects in Edit Modal
        const modalProjectSelectionEditContainer = document.getElementById('modalProjectSelectionEditContainer');
        const modalProjectInputEdit = document.getElementById('modalProjectInputEdit');
        // New for Dependencies in Edit Modal
        const modalDependenciesEditContainer = document.getElementById('modalDependenciesEditContainer');
        const modalDependsOnSelectEdit = document.getElementById('modalDependsOnSelectEdit');


        // View Task Details Modal elements
        const viewTaskDetailsModal = document.getElementById('viewTaskDetailsModal');
        const modalDialogViewDetails = document.getElementById('modalDialogViewDetails');
        const closeViewDetailsModalBtn = document.getElementById('closeViewDetailsModalBtn');
        const closeViewDetailsSecondaryBtn = document.getElementById('closeViewDetailsSecondaryBtn');
        const editFromViewModalBtn = document.getElementById('editFromViewModalBtn');
        const deleteFromViewModalBtn = document.getElementById('deleteFromViewModalBtn');
        const viewTaskText = document.getElementById('viewTaskText');
        const viewTaskDueDate = document.getElementById('viewTaskDueDate');
        const viewTaskTime = document.getElementById('viewTaskTime');
        const viewTaskEstDuration = document.getElementById('viewTaskEstDuration');
        const viewTaskPriority = document.getElementById('viewTaskPriority');
        const viewTaskStatus = document.getElementById('viewTaskStatus');
        const viewTaskProject = document.getElementById('viewTaskProject'); // New
        const viewTaskLabel = document.getElementById('viewTaskLabel');
        const viewTaskNotes = document.getElementById('viewTaskNotes');
        const viewTaskReminderSection = document.getElementById('viewTaskReminderSection');
        const viewTaskReminderStatus = document.getElementById('viewTaskReminderStatus');
        const viewTaskReminderDetails = document.getElementById('viewTaskReminderDetails');
        const viewTaskReminderDate = document.getElementById('viewTaskReminderDate');
        const viewTaskReminderTime = document.getElementById('viewTaskReminderTime');
        const viewTaskReminderEmail = document.getElementById('viewTaskReminderEmail');
        const viewTaskAttachmentsSection = document.getElementById('viewTaskAttachmentsSection');
        const viewTaskAttachmentsList = document.getElementById('viewTaskAttachmentsList');
        // New for Subtasks in View Details Modal
        const viewSubtasksSection = document.getElementById('viewSubtasksSection');
        const viewSubtasksList = document.getElementById('viewSubtasksList');
        // New for Dependencies in View Details Modal
        const viewTaskDependenciesSection = document.getElementById('viewTaskDependenciesSection');
        const viewTaskDependsOn = document.getElementById('viewTaskDependsOn');
        const viewTaskDependsOnList = document.getElementById('viewTaskDependsOnList');
        const viewTaskBlockedBy = document.getElementById('viewTaskBlockedBy');
        const viewTaskBlockedByList = document.getElementById('viewTaskBlockedByList');


        // Timer elements in View Task Details Modal
        const taskTimerSection = document.getElementById('taskTimerSection');
        const viewTaskTimerDisplay = document.getElementById('viewTaskTimerDisplay');
        const viewTaskStartTimerBtn = document.getElementById('viewTaskStartTimerBtn');
        const viewTaskPauseTimerBtn = document.getElementById('viewTaskPauseTimerBtn');
        const viewTaskStopTimerBtn = document.getElementById('viewTaskStopTimerBtn');
        const viewTaskActualDuration = document.getElementById('viewTaskActualDuration');
        const timerButtonsContainer = document.getElementById('timerButtonsContainer');


        // Manage Labels Modal elements
        const manageLabelsModal = document.getElementById('manageLabelsModal');
        const modalDialogManageLabels = document.getElementById('modalDialogManageLabels');
        const closeManageLabelsModalBtn = document.getElementById('closeManageLabelsModalBtn');
        const closeManageLabelsSecondaryBtn = document.getElementById('closeManageLabelsSecondaryBtn');
        const addNewLabelForm = document.getElementById('addNewLabelForm');
        const newLabelInput = document.getElementById('newLabelInput');
        const existingLabelsList = document.getElementById('existingLabelsList');

        // Manage Projects Modal elements (New)
        const manageProjectsModal = document.getElementById('manageProjectsModal');
        const modalDialogManageProjects = document.getElementById('modalDialogManageProjects');
        const closeManageProjectsModalBtn = document.getElementById('closeManageProjectsModalBtn');
        const closeManageProjectsSecondaryBtn = document.getElementById('closeManageProjectsSecondaryBtn');
        const addNewProjectForm = document.getElementById('addNewProjectForm');
        const newProjectInput = document.getElementById('newProjectInput');
        const existingProjectsList = document.getElementById('existingProjectsList');


        // Settings Modal elements
        const settingsModal = document.getElementById('settingsModal');
        const modalDialogSettings = document.getElementById('modalDialogSettings');
        const openSettingsModalButton = document.getElementById('openSettingsModalButton');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const closeSettingsSecondaryBtn = document.getElementById('closeSettingsSecondaryBtn');
        const settingsClearCompletedBtn = document.getElementById('settingsClearCompletedBtn');
        const settingsManageLabelsBtn = document.getElementById('settingsManageLabelsBtn');
        const settingsManageProjectsBtn = document.getElementById('settingsManageProjectsBtn'); // New
        const settingsManageRemindersBtn = document.getElementById('settingsManageRemindersBtn');
        const settingsTaskReviewBtn = document.getElementById('settingsTaskReviewBtn');
        const settingsTooltipsGuideBtn = document.getElementById('settingsTooltipsGuideBtn');
        const settingsFeatureFlagsBtn = document.getElementById('settingsFeatureFlagsBtn');
        const settingsIntegrationsBtn = document.getElementById('settingsIntegrationsBtn');
        const settingsUserAccountsBtn = document.getElementById('settingsUserAccountsBtn');
        const settingsCollaborationBtn = document.getElementById('settingsCollaborationBtn');
        const settingsSyncBackupBtn = document.getElementById('settingsSyncBackupBtn');
        // New for Export/Import
        const settingsExportDataBtn = document.getElementById('settingsExportDataBtn');
        const settingsImportDataBtn = document.getElementById('settingsImportDataBtn');
        const importFilePicker = document.getElementById('importFilePicker');


        // Task Review Modal elements
        const taskReviewModal = document.getElementById('taskReviewModal');
        const modalDialogTaskReview = document.getElementById('modalDialogTaskReview');
        const closeTaskReviewModalBtn = document.getElementById('closeTaskReviewModalBtn');
        const closeTaskReviewSecondaryBtn = document.getElementById('closeTaskReviewSecondaryBtn');
        const taskReviewContent = document.getElementById('taskReviewContent');

        // Tooltips Guide Modal elements
        const tooltipsGuideModal = document.getElementById('tooltipsGuideModal');
        const modalDialogTooltipsGuide = document.getElementById('modalDialogTooltipsGuide');
        const closeTooltipsGuideModalBtn = document.getElementById('closeTooltipsGuideModalBtn');
        const closeTooltipsGuideSecondaryBtn = document.getElementById('closeTooltipsGuideSecondaryBtn');
        const tooltipsGuideContent = document.getElementById('tooltipsGuideContent');


        // Feature Flags Modal elements
        const featureFlagsModal = document.getElementById('featureFlagsModal');
        const modalDialogFeatureFlags = document.getElementById('modalDialogFeatureFlags');
        const closeFeatureFlagsModalBtn = document.getElementById('closeFeatureFlagsModalBtn');
        const closeFeatureFlagsSecondaryBtn = document.getElementById('closeFeatureFlagsSecondaryBtn');
        const featureFlagsListContainer = document.getElementById('featureFlagsListContainer');

        // Test Feature Button elements
        const testFeatureButtonContainer = document.getElementById('testFeatureButtonContainer');
        const testFeatureButton = document.getElementById('testFeatureButton');

        // Kanban Board elements (New)
        const kanbanBoard = document.getElementById('kanbanBoard');
        const kanbanViewToggleBtn = document.getElementById('kanbanViewToggleBtn');
        const kanbanViewToggleIcon = document.getElementById('kanbanViewToggleIcon');
        const kanbanViewToggleText = document.getElementById('kanbanViewToggleText');

        // Calendar View elements (New)
        const calendarView = document.getElementById('calendarView');
        const calendarViewToggleBtn = document.getElementById('calendarViewToggleBtn');
        const calendarViewToggleIcon = document.getElementById('calendarViewToggleIcon');
        const calendarViewToggleText = document.getElementById('calendarViewToggleText');

        // Project Filter elements (New)
        const projectsFilterContainer = document.getElementById('projectsFilterContainer');
        const projectFilterButtonsContainer = document.getElementById('projectFilterButtonsContainer');


        // --- Application State ---
        let tasks = JSON.parse(localStorage.getItem('todos_v3')) || [];
        let projects = JSON.parse(localStorage.getItem('projects_v1')) || []; // New for Projects
        let kanbanBoardData = JSON.parse(localStorage.getItem('kanbanBoard_v1')) || { // New for Kanban
            columns: [
                { id: 'col1', title: 'To Do', taskIds: [] },
                { id: 'col2', title: 'In Progress', taskIds: [] },
                { id: 'col3', title: 'Done', taskIds: [] }
            ],
            columnOrder: ['col1', 'col2', 'col3'] // To maintain column order
        };
        let currentView = 'list'; // 'list', 'kanban', 'calendar' - New
        let currentFilter = 'inbox';
        let currentSort = 'default';
        let currentSearchTerm = '';
        let editingTaskId = null;
        let currentViewTaskId = null;
        let tooltipTimeout = null;
        let uniqueLabels = [];
        let featureFlags = JSON.parse(localStorage.getItem('featureFlags_v1')) || {
            testButtonFeature: false,
            reminderFeature: false,
            taskTimerSystem: false,
            advancedRecurrence: false,
            fileAttachments: false,
            integrationsServices: false,
            userAccounts: false,
            collaborationSharing: false,
            crossDeviceSync: false,
            tooltipsGuide: false,
            // New Feature Flags
            kanbanBoard: false,
            subtasksFeature: false,
            projectsFeature: false,
            advancedSearchFiltersFeature: false,
            keyboardShortcutsFeature: false,
            dataExportImportFeature: false,
            calendarViewFeature: false,
            taskDependenciesFeature: false
        };
        let currentTaskTimerInterval = null;
        let currentlyDraggingTask = null; // For Kanban drag-and-drop


        // --- Theme Management ---
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (localStorage.getItem('theme') !== 'system') { // Only if not system theme
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }
        });

        // --- Sidebar Toggle Functionality ---
        function setSidebarMinimized(minimize) {
            hideTooltip();
            if (minimize) {
                taskSidebar.classList.remove('md:w-72', 'lg:w-80', 'w-full', 'p-5', 'sm:p-6', 'md:p-5', 'sm:p-4');
                taskSidebar.classList.add('w-16', 'p-3', 'sidebar-minimized');
                sidebarToggleIcon.classList.remove('fa-chevron-left');
                sidebarToggleIcon.classList.add('fa-chevron-right');
                sidebarTextElements.forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar-section-title, #taskSearchInputContainer, #testFeatureButtonContainer .sidebar-text-content').forEach(el => el.classList.add('hidden'));
                if (featureFlags.projectsFeature) { // Hide project filter text when minimized
                    document.querySelector('#projectsFilterContainer .sidebar-section-title')?.classList.add('hidden');
                    projectFilterButtonsContainer.querySelectorAll('.sidebar-text-content').forEach(el => el.classList.add('hidden'));
                }
                sidebarIconOnlyButtons.forEach(btn => {
                    btn.classList.add('justify-center');
                    const icon = btn.querySelector('i');
                    if(icon) icon.classList.remove('md:mr-2', 'md:mr-2.5', 'ml-2');
                });
                if (testFeatureButton) testFeatureButton.querySelector('.sidebar-text-content')?.classList.add('hidden');
                localStorage.setItem('sidebarState', 'minimized');
            } else {
                taskSidebar.classList.remove('w-16', 'p-3', 'sidebar-minimized');
                taskSidebar.classList.add('w-full', 'md:w-72', 'lg:w-80', 'p-3', 'sm:p-4', 'md:p-5');
                sidebarToggleIcon.classList.remove('fa-chevron-right');
                sidebarToggleIcon.classList.add('fa-chevron-left');
                sidebarTextElements.forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.sidebar-section-title, #taskSearchInputContainer, #testFeatureButtonContainer .sidebar-text-content').forEach(el => el.classList.remove('hidden'));
                 if (featureFlags.projectsFeature) { // Show project filter text when expanded
                    document.querySelector('#projectsFilterContainer .sidebar-section-title')?.classList.remove('hidden');
                     projectFilterButtonsContainer.querySelectorAll('.sidebar-text-content').forEach(el => el.classList.remove('hidden'));
                }
                sidebarIconOnlyButtons.forEach(btn => {
                    btn.classList.remove('justify-center');
                    const icon = btn.querySelector('i');
                    const textSpan = btn.querySelector('.sidebar-text-content');
                    if(icon && textSpan && !textSpan.classList.contains('hidden')) {
                        if (btn.id === 'openAddModalButton' || btn.id === 'openSettingsModalButton' || btn.id === 'testFeatureButton' || btn.classList.contains('project-filter-btn')) {
                            icon.classList.add('md:mr-2');
                        } else {
                            icon.classList.add('md:mr-2.5');
                        }
                        textSpan.classList.add('ml-2');
                    }
                });
                if (testFeatureButton) testFeatureButton.querySelector('.sidebar-text-content')?.classList.remove('hidden');
                localStorage.setItem('sidebarState', 'expanded');
            }
            applyActiveFeatures(); // Re-apply features to adjust UI based on sidebar state and flags
        }
        // --- Tooltip Functions ---
        function showTooltip(element, text) {
            if (!taskSidebar.classList.contains('sidebar-minimized')) return;
            iconTooltip.textContent = text;
            const rect = element.getBoundingClientRect();
            iconTooltip.style.left = `${rect.right + 10}px`;
            iconTooltip.style.top = `${rect.top + (rect.height / 2) - (iconTooltip.offsetHeight / 2)}px`;
            iconTooltip.style.display = 'block';
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            iconTooltip.style.display = 'none';
        }

        sidebarIconOnlyButtons.forEach(button => {
            button.addEventListener('mouseenter', (event) => {
                if (!taskSidebar.classList.contains('sidebar-minimized')) return;
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    const tooltipText = button.title || button.querySelector('.sidebar-text-content')?.textContent.trim();
                    if (tooltipText) {
                        showTooltip(event.currentTarget, tooltipText);
                    }
                }, 500);
            });
            button.addEventListener('mouseleave', () => {
                hideTooltip();
            });
        });


        // --- Modal Functions (Add Task) ---
        function openAddModal() {
            if (!addTaskModal.classList.contains('hidden') ||
                document.activeElement.tagName === 'INPUT' ||
                document.activeElement.tagName === 'SELECT' ||
                document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            addTaskModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogAdd.classList.remove('scale-95', 'opacity-0');
                modalDialogAdd.classList.add('scale-100', 'opacity-100');
            }, 10);
            modalTaskInputAdd.focus();
            modalTodoFormAdd.reset();
            modalPriorityInputAdd.value = 'medium';
            populateDatalist(existingLabelsDatalist);

            modalEstHoursAdd.value = '';
            modalEstMinutesAdd.value = '';

            modalRemindMeAdd.checked = false;
            modalReminderDateAdd.value = '';
            modalReminderTimeAdd.value = '';
            modalReminderEmailAdd.value = '';
            reminderOptionsAdd.classList.add('hidden');

            if (featureFlags.projectsFeature) { // Populate projects dropdown
                populateProjectsDropdown(modalProjectInputAdd);
            }
            if (featureFlags.subtasksFeature) { // Reset subtasks
                modalSubtaskListAdd.innerHTML = '';
            }
             if (featureFlags.taskDependenciesFeature) { // Populate dependencies
                populateTaskDependenciesSelect(modalDependsOnSelectAdd);
            }


            const today = new Date();
            const year = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${mm}-${dd}`;
            modalDueDateInputAdd.min = todayStr;
            modalReminderDateAdd.min = todayStr;

            applyActiveFeatures(); // Ensure feature-specific UI is correctly shown/hidden
        }

        function closeAddModal() {
            modalDialogAdd.classList.add('scale-95', 'opacity-0');
            modalDialogAdd.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                addTaskModal.classList.add('hidden');
            }, 200);
        }

        // --- Modal Functions (View/Edit Task) ---
        function openViewEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            editingTaskId = taskId;

            modalViewEditTaskId.value = task.id;
            modalTaskInputViewEdit.value = task.text;
            modalDueDateInputViewEdit.value = task.dueDate || '';
            modalTimeInputViewEdit.value = task.time || '';
            modalEstHoursViewEdit.value = task.estimatedHours || '';
            modalEstMinutesViewEdit.value = task.estimatedMinutes || '';
            modalPriorityInputViewEdit.value = task.priority;
            modalLabelInputViewEdit.value = task.label || '';
            populateDatalist(existingLabelsEditDatalist);
            modalNotesInputViewEdit.value = task.notes || '';
             if (featureFlags.fileAttachments && existingAttachmentsViewEdit) {
                existingAttachmentsViewEdit.textContent = task.attachments && task.attachments.length > 0 ? `${task.attachments.length} file(s) attached (management UI coming soon)` : 'No files attached yet.';
            }


            if (featureFlags.reminderFeature) {
                modalRemindMeViewEdit.checked = task.isReminderSet || false;
                reminderOptionsViewEdit.classList.toggle('hidden', !modalRemindMeViewEdit.checked);
                if (modalRemindMeViewEdit.checked) {
                    modalReminderDateViewEdit.value = task.reminderDate || '';
                    modalReminderTimeViewEdit.value = task.reminderTime || '';
                    modalReminderEmailViewEdit.value = task.reminderEmail || '';
                } else {
                    modalReminderDateViewEdit.value = '';
                    modalReminderTimeViewEdit.value = '';
                    modalReminderEmailViewEdit.value = '';
                }
            } else {
                modalRemindMeViewEdit.checked = false;
                reminderOptionsViewEdit.classList.add('hidden');
            }

            if (featureFlags.projectsFeature) {
                populateProjectsDropdown(modalProjectInputEdit, task.projectId);
            }
            if (featureFlags.subtasksFeature) {
                renderSubtasksInModal(modalSubtaskListEdit, task.subtasks || [], 'edit');
            }
            if (featureFlags.taskDependenciesFeature) {
                populateTaskDependenciesSelect(modalDependsOnSelectEdit, task.id, task.dependsOn || []);
            }


            const today = new Date();
            const year = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${mm}-${dd}`;
            modalDueDateInputViewEdit.min = todayStr;
            modalReminderDateViewEdit.min = todayStr;

            viewEditTaskModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogViewEdit.classList.remove('scale-95', 'opacity-0');
                modalDialogViewEdit.classList.add('scale-100', 'opacity-100');
            }, 10);
            modalTaskInputViewEdit.focus();
            applyActiveFeatures();
        }

        function closeViewEditModal() {
            modalDialogViewEdit.classList.add('scale-95', 'opacity-0');
            modalDialogViewEdit.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                viewEditTaskModal.classList.add('hidden');
                editingTaskId = null;
            }, 200);
        }

        // --- Helper function to format duration (e.g., "1 hr 30 mins") ---
        function formatDuration(hours, minutes) {
            if ((!hours || hours === 0) && (!minutes || minutes === 0)) {
                return 'Not set';
            }
            let parts = [];
            if (hours && hours > 0) {
                parts.push(`${hours} hr${hours > 1 ? 's' : ''}`);
            }
            if (minutes && minutes > 0) {
                parts.push(`${minutes} min${minutes > 1 ? 's' : ''}`);
            }
            return parts.join(' ') || 'Not set';
        }

        // --- Milliseconds to HH:MM:SS formatter ---
        function formatMillisecondsToHMS(ms) {
            if (ms === null || typeof ms === 'undefined' || ms < 0) return "00:00:00";
            let totalSeconds = Math.floor(ms / 1000);
            let hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            let minutes = Math.floor(totalSeconds / 60);
            let seconds = totalSeconds % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }


        // --- Modal Functions (View Task Details) ---
        function openViewTaskDetailsModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentViewTaskId = taskId;

            viewTaskText.textContent = task.text;
            viewTaskDueDate.textContent = task.dueDate ? formatDate(task.dueDate) : 'Not set';
            viewTaskTime.textContent = task.time ? formatTime(task.time) : 'Not set';

            if (featureFlags.taskTimerSystem) {
                viewTaskEstDuration.textContent = formatDuration(task.estimatedHours, task.estimatedMinutes);
                updateTimerControlsUI(task);
                if (task.timerIsRunning && !task.completed) {
                    if (currentTaskTimerInterval) clearInterval(currentTaskTimerInterval);
                    currentTaskTimerInterval = setInterval(() => updateLiveTimerDisplay(task.id), 1000);
                    updateLiveTimerDisplay(task.id);
                } else if (task.timerIsPaused) {
                    viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.timerAccumulatedTime || 0);
                } else if (task.actualDurationMs > 0) {
                    viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.actualDurationMs);
                } else {
                    viewTaskTimerDisplay.textContent = "00:00:00";
                }
            }

            if (featureFlags.fileAttachments && viewTaskAttachmentsList) {
                 viewTaskAttachmentsList.textContent = task.attachments && task.attachments.length > 0 ? `Contains ${task.attachments.length} attachment(s) (viewing UI coming soon).` : 'No attachments.';
            }

            if (featureFlags.projectsFeature && viewTaskProject) {
                const project = projects.find(p => p.id === task.projectId);
                viewTaskProject.textContent = project ? project.name : 'None';
                viewTaskProject.closest('.projects-feature-element').classList.remove('hidden');
            } else if (viewTaskProject) {
                viewTaskProject.closest('.projects-feature-element').classList.add('hidden');
            }

            if (featureFlags.subtasksFeature && viewSubtasksSection && viewSubtasksList) {
                renderSubtasksInModal(viewSubtasksList, task.subtasks || [], 'view');
                viewSubtasksSection.classList.remove('hidden');
            } else if (viewSubtasksSection) {
                 viewSubtasksSection.classList.add('hidden');
            }

            if (featureFlags.taskDependenciesFeature && viewTaskDependenciesSection) {
                renderTaskDependenciesInView(task);
                viewTaskDependenciesSection.classList.remove('hidden');
            } else if (viewTaskDependenciesSection) {
                viewTaskDependenciesSection.classList.add('hidden');
            }


            viewTaskPriority.textContent = task.priority || 'Not set';
            viewTaskStatus.textContent = task.completed ? 'Completed' : (task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1) : 'Active'); // Show Kanban status if available
            viewTaskLabel.textContent = task.label || 'None';
            viewTaskNotes.textContent = task.notes || 'No notes added.';

            if (featureFlags.reminderFeature && task.isReminderSet) {
                viewTaskReminderStatus.textContent = 'Active';
                viewTaskReminderDate.textContent = task.reminderDate ? formatDate(task.reminderDate) : 'Not set';
                viewTaskReminderTime.textContent = task.reminderTime ? formatTime(task.reminderTime) : 'Not set';
                viewTaskReminderEmail.textContent = task.reminderEmail || 'Not set';
                viewTaskReminderDetails.classList.remove('hidden');
                viewTaskReminderSection.classList.remove('hidden');
            } else {
                viewTaskReminderStatus.textContent = 'Not set';
                viewTaskReminderDetails.classList.add('hidden');
                if (featureFlags.reminderFeature) {
                    viewTaskReminderSection.classList.remove('hidden');
                } else {
                    viewTaskReminderSection.classList.add('hidden');
                }
            }

            viewTaskDetailsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogViewDetails.classList.remove('scale-95', 'opacity-0');
                modalDialogViewDetails.classList.add('scale-100', 'opacity-100');
            }, 10);
            applyActiveFeatures(); // Ensure feature-specific UI elements are correctly shown/hidden
        }
        // Closes the "Task Information" modal
        function closeViewTaskDetailsModal() {
            // Animate modal disappearance
            modalDialogViewDetails.classList.add('scale-95', 'opacity-0');
            modalDialogViewDetails.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                viewTaskDetailsModal.classList.add('hidden'); // Hide the modal
                if (featureFlags.taskTimerSystem && currentTaskTimerInterval) { // Clear timer interval if it exists and feature is on
                    clearInterval(currentTaskTimerInterval);
                    currentTaskTimerInterval = null;
                }
                currentViewTaskId = null; // Clear the ID of the task being viewed
            }, 200);
        }

        // --- Timer Control Functions (conditionally active based on taskTimerSystem feature flag) ---
        function updateLiveTimerDisplay(taskId) {
            if (!featureFlags.taskTimerSystem) return;

            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.timerIsRunning || task.completed) {
                if (currentTaskTimerInterval) clearInterval(currentTaskTimerInterval);
                currentTaskTimerInterval = null;
                if (task && task.completed && task.actualDurationMs && viewTaskTimerDisplay) {
                    viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.actualDurationMs);
                }
                return;
            }
            const now = Date.now();
            const elapsedSinceStart = now - (task.timerStartTime || now);
            const currentDisplayTime = (task.timerAccumulatedTime || 0) + elapsedSinceStart;
            if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(currentDisplayTime);
        }

        function handleStartTimer() {
            if (!featureFlags.taskTimerSystem || !currentViewTaskId) return;
            const taskIndex = tasks.findIndex(t => t.id === currentViewTaskId);
            if (taskIndex === -1) return;
            const task = tasks[taskIndex];
            if (task.completed || (task.actualDurationMs && task.actualDurationMs > 0 && !task.timerIsPaused)) return;

            task.timerIsRunning = true;
            task.timerIsPaused = false;
            task.timerStartTime = Date.now();
            if (currentTaskTimerInterval) clearInterval(currentTaskTimerInterval);
            currentTaskTimerInterval = setInterval(() => updateLiveTimerDisplay(task.id), 1000);
            updateLiveTimerDisplay(task.id);
            saveTasks();
            updateTimerControlsUI(task);
        }

        function handlePauseTimer() {
            if (!featureFlags.taskTimerSystem || !currentViewTaskId) return;
            const taskIndex = tasks.findIndex(t => t.id === currentViewTaskId);
            if (taskIndex === -1 || !tasks[taskIndex].timerIsRunning) return;
            const task = tasks[taskIndex];
            if (currentTaskTimerInterval) clearInterval(currentTaskTimerInterval);
            currentTaskTimerInterval = null;
            const elapsed = Date.now() - (task.timerStartTime || Date.now());
            task.timerAccumulatedTime = (task.timerAccumulatedTime || 0) + elapsed;
            task.timerIsRunning = false;
            task.timerIsPaused = true;
            task.timerStartTime = null;
            if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.timerAccumulatedTime);
            saveTasks();
            updateTimerControlsUI(task);
        }

        function handleStopTimer(taskIdToStop) {
            if (!featureFlags.taskTimerSystem) return;
            const id = taskIdToStop || currentViewTaskId;
            if (!id) return;
            const taskIndex = tasks.findIndex(t => t.id === id);
            if (taskIndex === -1) return;
            const task = tasks[taskIndex];

            if (!task.timerIsRunning && !task.timerIsPaused && task.actualDurationMs > 0) {
                // Already stopped
            } else {
                if (currentTaskTimerInterval) clearInterval(currentTaskTimerInterval);
                currentTaskTimerInterval = null;
                if (task.timerIsRunning) {
                    const elapsed = Date.now() - (task.timerStartTime || Date.now());
                    task.timerAccumulatedTime = (task.timerAccumulatedTime || 0) + elapsed;
                }
                task.actualDurationMs = task.timerAccumulatedTime || 0;
            }
            task.timerIsRunning = false;
            task.timerIsPaused = false;
            task.timerStartTime = null;
            if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.actualDurationMs);
            saveTasks();
            if (currentViewTaskId === id && viewTaskDetailsModal && !viewTaskDetailsModal.classList.contains('hidden')) {
                updateTimerControlsUI(task);
            }
        }

        function updateTimerControlsUI(task) {
            if (!featureFlags.taskTimerSystem || !task || !viewTaskStartTimerBtn || !viewTaskPauseTimerBtn || !viewTaskStopTimerBtn || !viewTaskActualDuration || !timerButtonsContainer) return;

            if (task.completed) {
                timerButtonsContainer.classList.add('hidden');
                viewTaskActualDuration.textContent = task.actualDurationMs > 0 ? formatMillisecondsToHMS(task.actualDurationMs) : "Not recorded (completed).";
                if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = task.actualDurationMs > 0 ? formatMillisecondsToHMS(task.actualDurationMs) : "00:00:00";
                return;
            }
            timerButtonsContainer.classList.remove('hidden');

            if (task.actualDurationMs > 0 && !task.timerIsRunning && !task.timerIsPaused) {
                viewTaskStartTimerBtn.classList.add('hidden');
                viewTaskPauseTimerBtn.classList.add('hidden');
                viewTaskStopTimerBtn.classList.add('hidden');
                if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.actualDurationMs);
                viewTaskActualDuration.textContent = `Recorded: ${formatMillisecondsToHMS(task.actualDurationMs)}`;
            } else if (task.timerIsRunning) {
                viewTaskStartTimerBtn.classList.add('hidden');
                viewTaskPauseTimerBtn.classList.remove('hidden');
                viewTaskStopTimerBtn.classList.remove('hidden');
                viewTaskActualDuration.textContent = "Timer running...";
            } else if (task.timerIsPaused) {
                viewTaskStartTimerBtn.classList.remove('hidden');
                viewTaskStartTimerBtn.textContent = 'Resume';
                viewTaskPauseTimerBtn.classList.add('hidden');
                viewTaskStopTimerBtn.classList.remove('hidden');
                viewTaskActualDuration.textContent = "Timer paused.";
                 if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = formatMillisecondsToHMS(task.timerAccumulatedTime || 0);
            } else {
                viewTaskStartTimerBtn.classList.remove('hidden');
                viewTaskStartTimerBtn.textContent = 'Start';
                viewTaskPauseTimerBtn.classList.add('hidden');
                viewTaskStopTimerBtn.classList.add('hidden');
                viewTaskActualDuration.textContent = "Not yet recorded.";
                if (viewTaskTimerDisplay) viewTaskTimerDisplay.textContent = "00:00:00";
            }
        }


        // --- Modal Functions (Manage Labels) ---
        function openManageLabelsModal() {
            populateManageLabelsList();
            manageLabelsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogManageLabels.classList.remove('scale-95', 'opacity-0');
                modalDialogManageLabels.classList.add('scale-100', 'opacity-100');
            }, 10);
            newLabelInput.focus();
        }

        function closeManageLabelsModal() {
            modalDialogManageLabels.classList.add('scale-95', 'opacity-0');
            modalDialogManageLabels.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                manageLabelsModal.classList.add('hidden');
            }, 200);
        }

        function populateManageLabelsList() {
            existingLabelsList.innerHTML = '';
            uniqueLabels.forEach(label => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700 rounded-md';
                const span = document.createElement('span');
                span.textContent = label;
                span.className = 'text-slate-700 dark:text-slate-200 capitalize';
                li.appendChild(span);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                deleteBtn.className = 'p-1';
                deleteBtn.title = `Delete label "${label}"`;
                deleteBtn.addEventListener('click', () => handleDeleteLabel(label));
                li.appendChild(deleteBtn);
                existingLabelsList.appendChild(li);
            });
            if (uniqueLabels.length === 0) {
                existingLabelsList.innerHTML = '<li class="text-slate-500 dark:text-slate-400 text-center">No labels created yet.</li>';
            }
        }

        function handleAddNewLabel(event) {
            event.preventDefault();
            const labelName = newLabelInput.value.trim().toLowerCase();
            if (labelName === '') { showMessage('Label name cannot be empty.', 'error'); return; }
            if (uniqueLabels.includes(labelName)) { showMessage(`Label "${labelName}" already exists.`, 'error'); return; }
            uniqueLabels.push(labelName);
            uniqueLabels.sort();
            saveTasks(); // This updates labels in local storage via updateUniqueLabels indirectly
            populateManageLabelsList();
            newLabelInput.value = '';
            showMessage(`Label "${labelName}" added.`, 'success');
        }

        function handleDeleteLabel(labelToDelete) {
            const normalizedLabelToDelete = labelToDelete.toLowerCase();
            tasks = tasks.map(task => {
                if (task.label && task.label.toLowerCase() === normalizedLabelToDelete) {
                    return { ...task, label: '' };
                }
                return task;
            });
            saveTasks(); // This updates tasks and labels
            populateManageLabelsList();
            renderContent(); // Re-render main content (list or board)
            showMessage(`Label "${labelToDelete}" deleted and removed from tasks.`, 'success');
        }

        // --- Modal Functions (Manage Projects - New) ---
        function openManageProjectsModal() {
            if (!featureFlags.projectsFeature) return;
            populateManageProjectsList();
            manageProjectsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogManageProjects.classList.remove('scale-95', 'opacity-0');
                modalDialogManageProjects.classList.add('scale-100', 'opacity-100');
            }, 10);
            newProjectInput.focus();
        }

        function closeManageProjectsModal() {
            if (!featureFlags.projectsFeature) return;
            modalDialogManageProjects.classList.add('scale-95', 'opacity-0');
            modalDialogManageProjects.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                manageProjectsModal.classList.add('hidden');
            }, 200);
        }

        function populateManageProjectsList() {
            if (!featureFlags.projectsFeature || !existingProjectsList) return;
            existingProjectsList.innerHTML = '';
            projects.forEach(project => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700 rounded-md';
                const span = document.createElement('span');
                span.textContent = project.name;
                span.className = 'text-slate-700 dark:text-slate-200 capitalize';
                li.appendChild(span);

                const controlsDiv = document.createElement('div');
                // Edit button (placeholder for now)
                // const editBtn = document.createElement('button');
                // editBtn.innerHTML = '<i class="fas fa-pencil-alt text-sky-500 hover:text-sky-700"></i>';
                // editBtn.className = 'p-1 mr-1';
                // editBtn.title = `Edit project "${project.name}"`;
                // editBtn.addEventListener('click', () => handleEditProject(project.id)); // TODO: Implement handleEditProject
                // controlsDiv.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                deleteBtn.className = 'p-1';
                deleteBtn.title = `Delete project "${project.name}"`;
                deleteBtn.addEventListener('click', () => handleDeleteProject(project.id));
                controlsDiv.appendChild(deleteBtn);
                li.appendChild(controlsDiv);

                existingProjectsList.appendChild(li);
            });
            if (projects.length === 0) {
                existingProjectsList.innerHTML = '<li class="text-slate-500 dark:text-slate-400 text-center">No projects created yet.</li>';
            }
        }

        function handleAddNewProject(event) {
            event.preventDefault();
            if (!featureFlags.projectsFeature) return;
            const projectName = newProjectInput.value.trim();
            if (projectName === '') { showMessage('Project name cannot be empty.', 'error'); return; }
            if (projects.some(p => p.name.toLowerCase() === projectName.toLowerCase())) {
                showMessage(`Project "${projectName}" already exists.`, 'error'); return;
            }
            const newProject = { id: Date.now(), name: projectName };
            projects.push(newProject);
            projects.sort((a, b) => a.name.localeCompare(b.name));
            saveProjects();
            populateManageProjectsList();
            populateProjectFilterButtons(); // Update sidebar filters
            newProjectInput.value = '';
            showMessage(`Project "${projectName}" added.`, 'success');
        }

        function handleDeleteProject(projectId) {
            if (!featureFlags.projectsFeature) return;
            const projectToDelete = projects.find(p => p.id === projectId);
            if (!projectToDelete) return;

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete the project "${projectToDelete.name}"? Tasks in this project will be unassigned.`)) {
                return;
            }

            projects = projects.filter(p => p.id !== projectId);
            // Unassign tasks from this project
            tasks = tasks.map(task => {
                if (task.projectId === projectId) {
                    return { ...task, projectId: null };
                }
                return task;
            });
            saveProjects();
            saveTasks();
            populateManageProjectsList();
            populateProjectFilterButtons(); // Update sidebar filters
            renderContent(); // Re-render main content
            showMessage(`Project "${projectToDelete.name}" deleted and tasks unassigned.`, 'success');
        }

        function populateProjectsDropdown(selectElement, selectedProjectId = null) {
            if (!featureFlags.projectsFeature || !selectElement) return;
            selectElement.innerHTML = '<option value="">No Project</option>'; // Default option
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                if (selectedProjectId && project.id === selectedProjectId) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        function populateProjectFilterButtons() {
            if (!featureFlags.projectsFeature || !projectFilterButtonsContainer) return;
            projectFilterButtonsContainer.innerHTML = ''; // Clear existing

            // "All Projects" / "No Project" filter button (or similar)
            const allProjectsBtn = document.createElement('button');
            allProjectsBtn.title = "View All Tasks (No Project Filter)";
            allProjectsBtn.className = "smart-view-btn project-filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center";
            allProjectsBtn.dataset.projectId = "all"; // Special value for all projects
            allProjectsBtn.innerHTML = `<i class="fas fa-folder-open w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">All Projects</span>`;
            allProjectsBtn.addEventListener('click', () => setProjectFilter('all'));
            projectFilterButtonsContainer.appendChild(allProjectsBtn);


            projects.forEach(project => {
                const button = document.createElement('button');
                button.title = `Filter by ${project.name}`;
                button.className = "smart-view-btn project-filter-btn w-full text-left px-3 py-2 md:px-4 md:py-2.5 rounded-lg transition-colors duration-300 flex items-center sidebar-button-icon-only justify-center";
                button.dataset.projectId = project.id;
                button.innerHTML = `<i class="fas fa-folder w-5 mr-0"></i><span class="sidebar-text-content ml-2 md:ml-2.5">${project.name}</span>`;
                button.addEventListener('click', () => setProjectFilter(project.id));
                projectFilterButtonsContainer.appendChild(button);
            });
             // Re-apply sidebar minimized state to correctly hide/show text
            setSidebarMinimized(taskSidebar.classList.contains('sidebar-minimized'));
            updateProjectFilterButtonStates();
        }

        function setProjectFilter(projectId) {
            if (!featureFlags.projectsFeature) return;
            // Deselect smart views if a project filter is chosen, and vice-versa
            currentFilter = projectId; // Project ID or "all" for projects
            smartViewButtons.forEach(btn => btn.setAttribute('data-active', 'false'));
            updateSmartViewButtonStyles(); // Visually deselect smart views

            currentSort = 'default'; // Reset sort
            updateSortButtonStates();
            updateProjectFilterButtonStates();
            renderContent();
        }

        function updateProjectFilterButtonStates() {
            if (!featureFlags.projectsFeature) return;
            const projectButtons = projectFilterButtonsContainer.querySelectorAll('.project-filter-btn');
            projectButtons.forEach(button => {
                const isActive = button.dataset.projectId === currentFilter.toString(); // currentFilter could be a number or "all"
                button.setAttribute('data-active', isActive.toString());
                updateSmartViewButtonStyles(button, isActive); // Use the same styling logic
            });
        }


        // --- Modal Functions (Settings) ---
        function openSettingsModal() {
            settingsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogSettings.classList.remove('scale-95', 'opacity-0');
                modalDialogSettings.classList.add('scale-100', 'opacity-100');
            }, 10);
            applyActiveFeatures(); // Ensure feature-specific UI elements are correctly shown/hidden
        }

        function closeSettingsModal() {
            modalDialogSettings.classList.add('scale-95', 'opacity-0');
            modalDialogSettings.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                settingsModal.classList.add('hidden');
            }, 200);
        }

        // --- Modal Functions (Task Review) ---
        function openTaskReviewModal() {
            if (!featureFlags.taskTimerSystem) {
                showMessage("Task Timer System feature is currently disabled. Enable it in Feature Flags to use Task Review.", "error");
                return;
            }
            populateTaskReviewModal();
            taskReviewModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogTaskReview.classList.remove('scale-95', 'opacity-0');
                modalDialogTaskReview.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeTaskReviewModal() {
            modalDialogTaskReview.classList.add('scale-95', 'opacity-0');
            modalDialogTaskReview.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                taskReviewModal.classList.add('hidden');
            }, 200);
        }

        function populateTaskReviewModal() {
            taskReviewContent.innerHTML = '';
            const completedTasksWithTime = tasks.filter(task => task.completed && (task.actualDurationMs > 0 || task.estimatedHours > 0 || task.estimatedMinutes > 0));
            if (completedTasksWithTime.length === 0) {
                taskReviewContent.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center">No completed tasks with time estimates or recordings to review.</p>';
                return;
            }
            completedTasksWithTime.forEach(task => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 bg-slate-50 dark:bg-slate-700 rounded-lg shadow';
                const taskName = document.createElement('h4');
                taskName.className = 'text-md font-semibold text-slate-800 dark:text-slate-100 mb-1 truncate';
                taskName.textContent = task.text;
                itemDiv.appendChild(taskName);
                const estimatedTimeText = formatDuration(task.estimatedHours, task.estimatedMinutes);
                const estimatedP = document.createElement('p');
                estimatedP.className = 'text-sm text-slate-600 dark:text-slate-300';
                estimatedP.innerHTML = `<strong>Estimated:</strong> ${estimatedTimeText}`;
                itemDiv.appendChild(estimatedP);
                const actualTimeText = task.actualDurationMs > 0 ? formatMillisecondsToHMS(task.actualDurationMs) : 'Not recorded';
                const actualP = document.createElement('p');
                actualP.className = 'text-sm text-slate-600 dark:text-slate-300';
                actualP.innerHTML = `<strong>Actual:</strong> ${actualTimeText}`;
                itemDiv.appendChild(actualP);
                taskReviewContent.appendChild(itemDiv);
            });
        }

        // --- Modal Functions (Tooltips Guide - New) ---
        function openTooltipsGuideModal() {
            if (!featureFlags.tooltipsGuide) {
                 showMessage("Tooltips Guide feature is currently disabled. Enable it in Feature Flags.", "error");
                return;
            }
            // Content is static HTML, so just show/hide modal
            tooltipsGuideModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogTooltipsGuide.classList.remove('scale-95', 'opacity-0');
                modalDialogTooltipsGuide.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeTooltipsGuideModal() {
            modalDialogTooltipsGuide.classList.add('scale-95', 'opacity-0');
            modalDialogTooltipsGuide.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                tooltipsGuideModal.classList.add('hidden');
            }, 200);
        }


        // --- Modal Functions (Feature Flags) ---
        function openFeatureFlagsModal() {
            renderFeatureFlags();
            featureFlagsModal.classList.remove('hidden');
            setTimeout(() => {
                modalDialogFeatureFlags.classList.remove('scale-95', 'opacity-0');
                modalDialogFeatureFlags.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeFeatureFlagsModal() {
            modalDialogFeatureFlags.classList.add('scale-95', 'opacity-0');
            modalDialogFeatureFlags.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                featureFlagsModal.classList.add('hidden');
            }, 200);
        }

        const featureFlagDisplayNames = { // Expanded for new features
            testButtonFeature: "Test Button Feature",
            reminderFeature: "Reminder System",
            taskTimerSystem: "Task Timer & Review System",
            advancedRecurrence: "Advanced Recurring Tasks (Planned)",
            fileAttachments: "File Attachments to Tasks (Planned)",
            integrationsServices: "Integrations with Other Services (Planned)",
            userAccounts: "User Accounts & Authentication (Planned)",
            collaborationSharing: "Collaboration & Sharing Lists (Planned)",
            crossDeviceSync: "Cross-Device Sync & Cloud Backup (Planned)",
            tooltipsGuide: "Tooltips Guide Popup",
            kanbanBoard: "Kanban Board View",
            subtasksFeature: "Subtasks for Tasks",
            projectsFeature: "Projects & Project Filtering",
            advancedSearchFiltersFeature: "Advanced Search Filters",
            keyboardShortcutsFeature: "Additional Keyboard Shortcuts",
            dataExportImportFeature: "Data Export/Import (JSON)",
            calendarViewFeature: "Calendar View",
            taskDependenciesFeature: "Task Dependencies"
        };

        function renderFeatureFlags() {
            featureFlagsListContainer.innerHTML = ''; // Clear existing
            Object.keys(featureFlags).forEach(flagKey => {
                const flagItem = document.createElement('div');
                flagItem.className = 'feature-flag-item';
                const label = document.createElement('label');
                label.htmlFor = `flag-${flagKey}`;
                const displayName = featureFlagDisplayNames[flagKey] || flagKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                label.textContent = displayName;
                label.className = 'feature-flag-label mr-4';
                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'relative';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `flag-${flagKey}`;
                checkbox.name = flagKey;
                checkbox.checked = featureFlags[flagKey];
                checkbox.className = 'toggle-checkbox';
                const toggleTrack = document.createElement('label');
                toggleTrack.htmlFor = `flag-${flagKey}`;
                toggleTrack.className = 'toggle-label';
                toggleContainer.appendChild(checkbox);
                toggleContainer.appendChild(toggleTrack);
                checkbox.addEventListener('change', (event) => {
                    toggleFeatureFlag(flagKey, event.target.checked);
                });
                flagItem.appendChild(label);
                flagItem.appendChild(toggleContainer);
                featureFlagsListContainer.appendChild(flagItem);
            });
        }


        function toggleFeatureFlag(flagName, isEnabled) {
            featureFlags[flagName] = isEnabled;
            saveFeatureFlags();
            applyActiveFeatures(); // Re-apply UI changes based on new flag state

            // Special handling for Kanban board initialization
            if (flagName === 'kanbanBoard' && isEnabled) {
                initializeKanbanTasks(); // Ensure tasks have a status for Kanban
            }
             if (flagName === 'projectsFeature' && isEnabled) {
                populateProjectFilterButtons();
            }


            const displayName = featureFlagDisplayNames[flagName] || flagName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            showMessage(`Feature "${displayName}" ${isEnabled ? 'enabled' : 'disabled'}. Some changes may require a page refresh or re-opening modals.`, 'success');
        }

        function saveFeatureFlags() {
            localStorage.setItem('featureFlags_v1', JSON.stringify(featureFlags));
        }
        function saveKanbanBoardData() { // New for Kanban
            if(featureFlags.kanbanBoard) {
                localStorage.setItem('kanbanBoard_v1', JSON.stringify(kanbanBoardData));
            }
        }
        function loadKanbanBoardData() { // New for Kanban
            const storedData = localStorage.getItem('kanbanBoard_v1');
            if (storedData) {
                kanbanBoardData = JSON.parse(storedData);
            } else { // Default structure if nothing is stored
                kanbanBoardData = {
                    columns: [
                        { id: 'col1', title: 'To Do', taskIds: [] },
                        { id: 'col2', title: 'In Progress', taskIds: [] },
                        { id: 'col3', title: 'Done', taskIds: [] }
                    ],
                    columnOrder: ['col1', 'col2', 'col3']
                };
            }
        }
        function saveProjects() { // New for Projects
            if (featureFlags.projectsFeature) {
                localStorage.setItem('projects_v1', JSON.stringify(projects));
            }
        }
        function loadProjects() { // New for Projects
            const storedProjects = localStorage.getItem('projects_v1');
            if (storedProjects) {
                projects = JSON.parse(storedProjects);
            } else {
                projects = []; // Default to empty array
            }
        }


        function loadFeatureFlags() {
            const storedFlags = localStorage.getItem('featureFlags_v1');
            let updated = false;
            const defaultFlags = { // Ensure all flags have a default
                testButtonFeature: false,
                reminderFeature: false,
                taskTimerSystem: false,
                advancedRecurrence: false,
                fileAttachments: false,
                integrationsServices: false,
                userAccounts: false,
                collaborationSharing: false,
                crossDeviceSync: false,
                tooltipsGuide: false,
                kanbanBoard: false,
                subtasksFeature: false,
                projectsFeature: false,
                advancedSearchFiltersFeature: false,
                keyboardShortcutsFeature: false,
                dataExportImportFeature: false,
                calendarViewFeature: false,
                taskDependenciesFeature: false
            };

            if (storedFlags) {
                featureFlags = JSON.parse(storedFlags);
            } else {
                featureFlags = { ...defaultFlags }; // Start with defaults if no stored flags
                updated = true; // Mark as updated to save defaults
            }

            // Ensure all current default flags exist in the loaded flags
            for (const flagKey in defaultFlags) {
                if (typeof featureFlags[flagKey] === 'undefined') {
                    featureFlags[flagKey] = defaultFlags[flagKey];
                    updated = true;
                }
            }
            if (updated) {
                saveFeatureFlags();
            }
        }

        // Applies UI changes based on the current state of feature flags
        function applyActiveFeatures() {
            const toggleElementsDisplay = (selector, isEnabled) => { // Renamed to avoid conflict
                document.querySelectorAll(selector).forEach(el => {
                    // Keep 'block' for elements that should be block, handle others if needed
                    if (isEnabled) {
                        el.style.display = el.dataset.originalDisplay || 'block'; // Restore or default to block
                        el.classList.remove('hidden');
                    } else {
                        if (!el.dataset.originalDisplay) { // Store original display if not already stored
                           el.dataset.originalDisplay = window.getComputedStyle(el).display !== 'none' ? window.getComputedStyle(el).display : 'block';
                        }
                        el.style.display = 'none';
                        el.classList.add('hidden');
                    }
                });
            };


            if (testFeatureButtonContainer) testFeatureButtonContainer.classList.toggle('hidden', !featureFlags.testButtonFeature);

            // Toggle feature-specific class-based elements (more robust for complex show/hide)
            document.querySelectorAll('.reminder-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.reminderFeature));
            document.querySelectorAll('.task-timer-system-element').forEach(el => el.classList.toggle('hidden', !featureFlags.taskTimerSystem));
            document.querySelectorAll('.advanced-recurrence-element').forEach(el => el.classList.toggle('hidden', !featureFlags.advancedRecurrence));
            document.querySelectorAll('.file-attachments-element').forEach(el => el.classList.toggle('hidden', !featureFlags.fileAttachments));
            document.querySelectorAll('.integrations-services-element').forEach(el => el.classList.toggle('hidden', !featureFlags.integrationsServices));
            document.querySelectorAll('.user-accounts-element').forEach(el => el.classList.toggle('hidden', !featureFlags.userAccounts));
            document.querySelectorAll('.collaboration-sharing-element').forEach(el => el.classList.toggle('hidden', !featureFlags.collaborationSharing));
            document.querySelectorAll('.cross-device-sync-element').forEach(el => el.classList.toggle('hidden', !featureFlags.crossDeviceSync));
            document.querySelectorAll('.tooltips-guide-element').forEach(el => el.classList.toggle('hidden', !featureFlags.tooltipsGuide));
            document.querySelectorAll('.kanban-board-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.kanbanBoard));
            document.querySelectorAll('.subtasks-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.subtasksFeature));
            document.querySelectorAll('.projects-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.projectsFeature));
            document.querySelectorAll('.advanced-search-filters-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.advancedSearchFiltersFeature));
            document.querySelectorAll('.keyboard-shortcuts-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.keyboardShortcutsFeature));
            document.querySelectorAll('.data-export-import-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.dataExportImportFeature));
            document.querySelectorAll('.calendar-view-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.calendarViewFeature));
            document.querySelectorAll('.task-dependencies-feature-element').forEach(el => el.classList.toggle('hidden', !featureFlags.taskDependenciesFeature));


            if (featureFlags.reminderFeature) {
                if (modalRemindMeAdd && addTaskModal && !addTaskModal.classList.contains('hidden')) {
                    reminderOptionsAdd.classList.toggle('hidden', !modalRemindMeAdd.checked);
                }
                if (modalRemindMeViewEdit && viewEditTaskModal && !viewEditTaskModal.classList.contains('hidden')) {
                    reminderOptionsViewEdit.classList.toggle('hidden', !modalRemindMeViewEdit.checked);
                }
            } else {
                 if (reminderOptionsAdd) reminderOptionsAdd.classList.add('hidden');
                 if (reminderOptionsViewEdit) reminderOptionsViewEdit.classList.add('hidden');
            }

            if (settingsTaskReviewBtn) settingsTaskReviewBtn.classList.toggle('hidden', !featureFlags.taskTimerSystem);
            if (settingsTooltipsGuideBtn) settingsTooltipsGuideBtn.classList.toggle('hidden', !featureFlags.tooltipsGuide);
            if (kanbanViewToggleBtn) kanbanViewToggleBtn.classList.toggle('hidden', !featureFlags.kanbanBoard);
            if (calendarViewToggleBtn) calendarViewToggleBtn.classList.toggle('hidden', !featureFlags.calendarViewFeature);
            if (settingsManageProjectsBtn) settingsManageProjectsBtn.classList.toggle('hidden', !featureFlags.projectsFeature);
            if (projectsFilterContainer) projectsFilterContainer.classList.toggle('hidden', !featureFlags.projectsFeature);
            if (advancedSearchHelpText) advancedSearchHelpText.classList.toggle('hidden', !featureFlags.advancedSearchFiltersFeature);


            // Ensure view-specific elements are hidden/shown correctly
            if (currentView === 'list') {
                taskList.classList.remove('hidden');
                if (kanbanBoard) kanbanBoard.classList.add('hidden');
                if (calendarView) calendarView.classList.add('hidden');
                if (mainContentTitle) mainContentTitle.textContent = "Your Tasks";
            } else if (currentView === 'kanban' && featureFlags.kanbanBoard) {
                taskList.classList.add('hidden');
                if (kanbanBoard) kanbanBoard.classList.remove('hidden');
                if (calendarView) calendarView.classList.add('hidden');
                if (mainContentTitle) mainContentTitle.textContent = "Kanban Board";
            } else if (currentView === 'calendar' && featureFlags.calendarViewFeature) {
                taskList.classList.add('hidden');
                if (kanbanBoard) kanbanBoard.classList.add('hidden');
                if (calendarView) calendarView.classList.remove('hidden');
                if (mainContentTitle) mainContentTitle.textContent = "Calendar View";
            } else { // Default to list view if currentView is invalid or feature disabled
                 switchToListView();
            }


            renderContent(); // Re-render content based on the new view / flags
            if (currentViewTaskId && !viewTaskDetailsModal.classList.contains('hidden')) { // If task details modal is open, refresh it
                openViewTaskDetailsModal(currentViewTaskId);
            }
             if (featureFlags.projectsFeature) {
                populateProjectFilterButtons();
            }
        }


        // --- Date & Time Helper Functions ---
        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
        function getDateString(date) { return date.toISOString().split('T')[0]; }
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; const correctedDate = new Date(date.getTime() + userTimezoneOffset); return correctedDate.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatTime(timeString) { if (!timeString) return ''; const [hours, minutes] = timeString.split(':'); const h = parseInt(hours, 10); const ampm = h >= 12 ? 'PM' : 'AM'; const formattedHours = h % 12 || 12; return `${formattedHours}:${minutes} ${ampm}`; }

        // --- Core Functions ---
        function showMessage(message, type = 'success') { messageBox.textContent = message; messageBox.className = 'message-box'; if (type === 'success') { messageBox.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100'); } else { messageBox.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100'); } messageBox.style.display = 'block'; messageBox.style.zIndex = '200'; setTimeout(() => { messageBox.style.display = 'none'; }, 3000); }
        function saveTasks() {
            localStorage.setItem('todos_v3', JSON.stringify(tasks));
            updateUniqueLabels();
            // If Kanban is active, you might want to re-sync task statuses with Kanban columns here or implicitly
            if (featureFlags.kanbanBoard) {
                 // This might be complex. For now, Kanban rendering will read task status.
                 // Or, if a task is completed via list view, its status in Kanban data should update.
            }
        }
        function getPriorityClass(priority) { switch (priority) { case 'high': return 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100'; case 'medium': return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-600 dark:text-yellow-100'; case 'low': return 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100'; default: return 'bg-slate-100 text-slate-700 dark:bg-slate-600 dark:text-slate-200'; } }

        function updateUniqueLabels() {
            const labels = new Set();
            tasks.forEach(task => {
                if (task.label && task.label.trim() !== '') {
                    labels.add(task.label.trim().toLowerCase());
                }
            });
            uniqueLabels = Array.from(labels).sort();
            populateDatalist(existingLabelsDatalist);
            populateDatalist(existingLabelsEditDatalist);
        }

        function populateDatalist(datalistElement) {
            if (!datalistElement) return;
            datalistElement.innerHTML = '';
            uniqueLabels.forEach(label => {
                const option = document.createElement('option');
                option.value = label.charAt(0).toUpperCase() + label.slice(1);
                datalistElement.appendChild(option);
            });
        }


        // --- View Switching Logic (New) ---
        function switchToListView() {
            currentView = 'list';
            taskList.classList.remove('hidden');
            if (kanbanBoard) kanbanBoard.classList.add('hidden');
            if (calendarView) calendarView.classList.add('hidden');
            if (mainContentTitle) mainContentTitle.textContent = "Your Tasks";

            if (featureFlags.kanbanBoard && kanbanViewToggleIcon && kanbanViewToggleText) {
                kanbanViewToggleIcon.className = 'fas fa-columns mr-1.5';
                kanbanViewToggleText.textContent = 'Board';
                kanbanViewToggleBtn.title = "Switch to Board View";
            }
            if (featureFlags.calendarViewFeature && calendarViewToggleIcon && calendarViewToggleText) {
                calendarViewToggleIcon.className = 'fas fa-calendar-week mr-1.5';
                calendarViewToggleText.textContent = 'Calendar';
                calendarViewToggleBtn.title = "Switch to Calendar View";
            }
            // Show sort buttons in list view
            document.querySelectorAll('.sort-btn').forEach(btn => {
                if(btn.id !== 'kanbanViewToggleBtn' && btn.id !== 'calendarViewToggleBtn') {
                    btn.classList.remove('hidden');
                }
            });
            renderContent();
        }

        function switchToKanbanView() {
            if (!featureFlags.kanbanBoard) {
                showMessage("Kanban Board feature is disabled. Enable it in Feature Flags.", "error");
                switchToListView(); // Fallback to list view
                return;
            }
            currentView = 'kanban';
            taskList.classList.add('hidden');
            if (kanbanBoard) kanbanBoard.classList.remove('hidden');
            if (calendarView) calendarView.classList.add('hidden');
            if (mainContentTitle) mainContentTitle.textContent = "Kanban Board";

            if (kanbanViewToggleIcon && kanbanViewToggleText) {
                kanbanViewToggleIcon.className = 'fas fa-list mr-1.5';
                kanbanViewToggleText.textContent = 'List';
                kanbanViewToggleBtn.title = "Switch to List View";
            }
             if (featureFlags.calendarViewFeature && calendarViewToggleIcon && calendarViewToggleText) { // Reset calendar button
                calendarViewToggleIcon.className = 'fas fa-calendar-week mr-1.5';
                calendarViewToggleText.textContent = 'Calendar';
            }
            // Hide sort buttons in Kanban view as sorting is implicit by columns
            document.querySelectorAll('.sort-btn').forEach(btn => {
                 if(btn.id !== 'kanbanViewToggleBtn' && btn.id !== 'calendarViewToggleBtn') {
                    btn.classList.add('hidden');
                }
            });
            renderContent();
        }
        function switchToCalendarView() {
            if (!featureFlags.calendarViewFeature) {
                showMessage("Calendar View feature is disabled. Enable it in Feature Flags.", "error");
                switchToListView(); // Fallback
                return;
            }
            currentView = 'calendar';
            taskList.classList.add('hidden');
            if (kanbanBoard) kanbanBoard.classList.add('hidden');
            if (calendarView) calendarView.classList.remove('hidden');
            if (mainContentTitle) mainContentTitle.textContent = "Calendar View";

            if (calendarViewToggleIcon && calendarViewToggleText) {
                calendarViewToggleIcon.className = 'fas fa-list mr-1.5';
                calendarViewToggleText.textContent = 'List';
                calendarViewToggleBtn.title = "Switch to List View";
            }
            if (featureFlags.kanbanBoard && kanbanViewToggleIcon && kanbanViewToggleText) { // Reset kanban button
                kanbanViewToggleIcon.className = 'fas fa-columns mr-1.5';
                kanbanViewToggleText.textContent = 'Board';
            }
            // Hide sort buttons
             document.querySelectorAll('.sort-btn').forEach(btn => {
                 if(btn.id !== 'kanbanViewToggleBtn' && btn.id !== 'calendarViewToggleBtn') {
                    btn.classList.add('hidden');
                }
            });
            renderContent();
        }
        // --- Rendering Logic ---
        function renderContent() { // Master render function
            if (currentView === 'list') {
                renderTasksList();
            } else if (currentView === 'kanban' && featureFlags.kanbanBoard) {
                renderKanbanBoard();
            } else if (currentView === 'calendar' && featureFlags.calendarViewFeature) {
                renderCalendarView();
            } else { // Default or if feature disabled
                switchToListView();
            }
            updateClearCompletedButtonState(); // Update this after any render
        }


        function renderTasksList() {
            if (!taskList) return;
            taskList.innerHTML = '';
            let filteredTasks = getFilteredAndSortedTasks();

            emptyState.classList.toggle('hidden', tasks.length === 0 || (filteredTasks.length === 0 && currentView === 'list' && !currentSearchTerm && currentFilter === 'inbox'));
            noMatchingTasks.classList.toggle('hidden', !(tasks.length > 0 && filteredTasks.length === 0 && (currentSearchTerm || currentFilter !== 'inbox')));


            filteredTasks.forEach((task) => {
                const li = document.createElement('li');
                const isBlocked = featureFlags.taskDependenciesFeature && task.dependsOn && task.dependsOn.some(depId => {
                    const depTask = tasks.find(t => t.id === depId);
                    return depTask && !depTask.completed;
                });

                li.className = `task-item flex items-start justify-between bg-slate-100 dark:bg-slate-700 p-3 sm:p-3.5 rounded-lg shadow hover:shadow-md transition-shadow duration-300 ${task.completed ? 'opacity-60' : ''} ${isBlocked && !task.completed ? 'opacity-70 border-l-4 border-amber-500' : ''} overflow-hidden`;
                li.dataset.taskId = task.id;
                if (isBlocked && !task.completed) {
                    li.title = "This task is blocked by one or more incomplete dependencies.";
                }


                const mainContentClickableArea = document.createElement('div');
                mainContentClickableArea.className = 'task-item-clickable-area flex items-start flex-grow min-w-0 mr-2 rounded-l-lg';
                mainContentClickableArea.addEventListener('click', (event) => {
                    if (event.target.type === 'checkbox' || event.target.closest('.task-actions')) { return; }
                    openViewTaskDetailsModal(task.id);
                });
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.className = 'form-checkbox h-5 w-5 text-sky-500 rounded border-slate-400 dark:border-slate-500 focus:ring-sky-400 dark:focus:ring-sky-500 mt-0.5 mr-2 sm:mr-3 cursor-pointer flex-shrink-0';
                checkbox.disabled = isBlocked && !task.completed;
                if (isBlocked && !task.completed) {
                    checkbox.title = "This task is blocked by an incomplete dependency.";
                }
                checkbox.addEventListener('change', () => toggleComplete(task.id));

                const textDetailsDiv = document.createElement('div');
                textDetailsDiv.className = 'flex flex-col';
                const span = document.createElement('span');
                span.textContent = task.text;
                let textColorClass = task.completed ? 'text-slate-500 dark:text-slate-400' : 'text-slate-700 dark:text-slate-200';
                if (isBlocked && !task.completed) textColorClass = 'text-amber-700 dark:text-amber-400';
                span.className = `text-sm sm:text-base break-all ${textColorClass} ${task.completed ? 'completed-text' : ''}`;
                textDetailsDiv.appendChild(span);

                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'flex items-center flex-wrap gap-x-2 gap-y-1 mt-1 sm:mt-1.5 text-xs';
                if (task.priority) { const priorityBadge = document.createElement('span'); priorityBadge.textContent = task.priority; priorityBadge.className = `priority-badge ${getPriorityClass(task.priority)}`; detailsContainer.appendChild(priorityBadge); }
                if (task.label) { const labelBadge = document.createElement('span'); labelBadge.textContent = task.label; labelBadge.className = 'label-badge'; detailsContainer.appendChild(labelBadge); }
                if (task.dueDate) { const dueDateSpan = document.createElement('span'); dueDateSpan.className = 'text-slate-500 dark:text-slate-400 flex items-center'; let dateDisplay = formatDate(task.dueDate); if (task.time) { dateDisplay += ` ${formatTime(task.time)}`; } dueDateSpan.innerHTML = `<i class="far fa-calendar-alt mr-1"></i> ${dateDisplay}`; detailsContainer.appendChild(dueDateSpan); }
                if (featureFlags.fileAttachments && task.attachments && task.attachments.length > 0) {
                    const attachmentSpan = document.createElement('span');
                    attachmentSpan.className = 'text-slate-500 dark:text-slate-400 flex items-center file-attachments-element'; // Ensure class is present
                    attachmentSpan.innerHTML = `<i class="fas fa-paperclip mr-1"></i> ${task.attachments.length}`;
                    detailsContainer.appendChild(attachmentSpan);
                }
                if (featureFlags.projectsFeature && task.projectId) {
                    const project = projects.find(p => p.id === task.projectId);
                    if (project) {
                        const projectBadge = document.createElement('span');
                        projectBadge.className = 'bg-purple-100 text-purple-700 dark:bg-purple-700 dark:text-purple-100 priority-badge projects-feature-element'; // Ensure class
                        projectBadge.innerHTML = `<i class="fas fa-project-diagram mr-1"></i>${project.name}`;
                        detailsContainer.appendChild(projectBadge);
                    }
                }
                if (featureFlags.subtasksFeature && task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    const subtaskSpan = document.createElement('span');
                    subtaskSpan.className = 'text-slate-500 dark:text-slate-400 flex items-center subtasks-feature-element'; // Ensure class
                    subtaskSpan.innerHTML = `<i class="fas fa-stream mr-1"></i> ${completedSubtasks}/${task.subtasks.length}`;
                    detailsContainer.appendChild(subtaskSpan);
                }


                if (detailsContainer.hasChildNodes()) { textDetailsDiv.appendChild(detailsContainer); }
                mainContentClickableArea.appendChild(checkbox);
                mainContentClickableArea.appendChild(textDetailsDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions flex-shrink-0 self-start';
                const editButton = document.createElement('button');
                editButton.className = 'task-action-btn text-sky-500 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-500';
                editButton.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editButton.setAttribute('aria-label', 'Edit task');
                editButton.title = 'Edit task (E)';
                editButton.addEventListener('click', () => openViewEditModal(task.id));
                actionsDiv.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'task-action-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-500';
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteButton.setAttribute('aria-label', 'Delete task');
                deleteButton.title = 'Delete task (Del)';
                deleteButton.addEventListener('click', () => deleteTask(task.id));
                actionsDiv.appendChild(deleteButton);

                li.appendChild(mainContentClickableArea);
                li.appendChild(actionsDiv);
                taskList.appendChild(li);
            });
        }


        function getFilteredAndSortedTasks() {
            // ... (Function content from previous snippet - no changes here) ...
            let currentFilteredTasks = [];
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            const todayStr = getDateString(todayDate);

            if (currentFilter === 'inbox') {
                currentFilteredTasks = tasks.filter(task => !task.completed);
            } else if (currentFilter === 'today') {
                currentFilteredTasks = tasks.filter(task => task.dueDate === todayStr && !task.completed);
            } else if (currentFilter === 'upcoming') {
                currentFilteredTasks = tasks.filter(task => {
                    if (!task.dueDate || task.completed) return false;
                    const taskDueDate = new Date(task.dueDate);
                    const userTimezoneOffset = taskDueDate.getTimezoneOffset() * 60000;
                    const correctedTaskDueDate = new Date(taskDueDate.getTime() + userTimezoneOffset);
                    correctedTaskDueDate.setHours(0,0,0,0);
                    return correctedTaskDueDate > todayDate;
                });
            } else if (currentFilter === 'completed') {
                currentFilteredTasks = tasks.filter(task => task.completed);
            } else if (featureFlags.projectsFeature && currentFilter !== 'all' && projects.some(p => p.id === parseInt(currentFilter))) {
                currentFilteredTasks = tasks.filter(task => task.projectId === parseInt(currentFilter));
            } else if (featureFlags.projectsFeature && currentFilter === 'all') {
                 currentFilteredTasks = [...tasks];
            } else {
                currentFilteredTasks = tasks.filter(task => !task.completed);
            }

            if (currentSearchTerm) {
                if (featureFlags.advancedSearchFiltersFeature && currentSearchTerm.includes(':')) {
                    const parts = currentSearchTerm.toLowerCase().split(' ');
                    let searchTextParts = [];
                    let searchFilters = {};
                    parts.forEach(part => {
                        if(part.includes(':')) {
                            const [key, value] = part.split(':', 2);
                            if (key && value) searchFilters[key.trim()] = value.trim();
                        } else {
                            searchTextParts.push(part);
                        }
                    });
                    const finalSearchText = searchTextParts.join(' ');

                    currentFilteredTasks = currentFilteredTasks.filter(task => {
                        let matchesText = true;
                        if (finalSearchText) {
                            matchesText = task.text.toLowerCase().includes(finalSearchText) ||
                                          (task.notes && task.notes.toLowerCase().includes(finalSearchText));
                        }

                        let matchesFilters = true;
                        for (const key in searchFilters) {
                            const val = searchFilters[key];
                            if (key === 'priority' && task.priority !== val) matchesFilters = false;
                            if (key === 'label' && (!task.label || task.label.toLowerCase() !== val)) matchesFilters = false;
                            if (key === 'project') {
                                const project = projects.find(p => p.name.toLowerCase() === val);
                                if (!project || task.projectId !== project.id) matchesFilters = false;
                            }
                            if (key === 'due') {
                                if (val === 'today' && task.dueDate !== todayStr) matchesFilters = false;
                                else if (val === 'upcoming') {
                                    if (!task.dueDate) { matchesFilters = false; }
                                    else {
                                        const taskDueDate = new Date(task.dueDate);
                                        const userTimezoneOffset = taskDueDate.getTimezoneOffset() * 60000;
                                        const correctedTaskDueDate = new Date(taskDueDate.getTime() + userTimezoneOffset);
                                        correctedTaskDueDate.setHours(0,0,0,0);
                                        if (correctedTaskDueDate <= todayDate) matchesFilters = false;
                                    }
                                }
                                else if (val !== 'today' && val !== 'upcoming' && task.dueDate !== val) {
                                    matchesFilters = false;
                                }
                            }
                            if (key === 'is' && val === 'completed' && !task.completed) matchesFilters = false;
                            if (key === 'is' && val === 'active' && task.completed) matchesFilters = false;
                            if (key === 'is' && val === 'blocked' && featureFlags.taskDependenciesFeature) {
                                const isBlocked = task.dependsOn && task.dependsOn.some(depId => {
                                    const depTask = tasks.find(t => t.id === depId);
                                    return depTask && !depTask.completed;
                                });
                                if (!isBlocked) matchesFilters = false;
                            }
                        }
                        return matchesText && matchesFilters;
                    });

                } else {
                    currentFilteredTasks = currentFilteredTasks.filter(task =>
                        task.text.toLowerCase().includes(currentSearchTerm) ||
                        (task.notes && task.notes.toLowerCase().includes(currentSearchTerm)) ||
                        (task.label && task.label.toLowerCase().includes(currentSearchTerm))
                    );
                }
            }

            if (currentView === 'list') {
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                if (currentSort === 'dueDate') {
                    currentFilteredTasks.sort((a, b) => {
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                        const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                        return dateA - dateB;
                    });
                } else if (currentSort === 'priority') {
                    currentFilteredTasks.sort((a, b) => {
                        const priorityDiff = (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4);
                        if (priorityDiff !== 0) return priorityDiff;
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                        const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                        return dateA - dateB;
                    });
                } else if (currentSort === 'label') {
                    currentFilteredTasks.sort((a,b) => {
                        const labelA = (a.label || '').toLowerCase();
                        const labelB = (b.label || '').toLowerCase();
                        if (labelA < labelB) return -1;
                        if (labelA > labelB) return 1;
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        const dateA = new Date(a.dueDate + (a.time ? `T${a.time}` : 'T00:00:00'));
                        const dateB = new Date(b.dueDate + (b.time ? `T${b.time}` : 'T00:00:00'));
                        return dateA - dateB;
                    });
                }
            }
            return currentFilteredTasks;
        }

        function renderKanbanBoard() {
            // ... (Function content from previous snippet - no changes here) ...
             if (!featureFlags.kanbanBoard || !kanbanBoard) return;
            kanbanBoard.innerHTML = '';

            const globallyFilteredTaskIds = new Set(getFilteredAndSortedTasks().map(t => t.id));


            kanbanBoardData.columnOrder.forEach(columnId => {
                const columnData = kanbanBoardData.columns.find(col => col.id === columnId);
                if (!columnData) return;

                const columnDiv = document.createElement('div');
                columnDiv.className = 'kanban-column';
                columnDiv.dataset.columnId = columnData.id;

                const header = document.createElement('h3');
                header.className = 'kanban-column-header group relative';
                header.textContent = columnData.title;

                const editIcon = document.createElement('i');
                editIcon.className = 'fas fa-pencil-alt text-xs text-slate-400 dark:text-slate-500 absolute right-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer';
                editIcon.title = "Edit column name";
                editIcon.onclick = (e) => {
                    e.stopPropagation();
                    header.contentEditable = "true";
                    header.focus();
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(header);
                    selection.removeAllRanges();
                    selection.addRange(range);
                };
                header.appendChild(editIcon);


                header.addEventListener('focus', () => {
                     header.dataset.originalTitle = header.textContent.replace(editIcon.outerHTML, '').trim();
                });
                header.addEventListener('blur', (e) => {
                    header.contentEditable = "false";
                    const newTitle = header.textContent.replace(editIcon.outerHTML, '').trim();

                    if (newTitle && columnData.title !== newTitle) {
                        columnData.title = newTitle;
                        saveKanbanBoardData();
                        showMessage(`Column renamed to "${newTitle}"`, 'success');
                    } else {
                        header.textContent = columnData.title;
                        header.appendChild(editIcon);
                    }
                });
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    } else if (e.key === 'Escape') {
                        header.textContent = header.dataset.originalTitle || columnData.title;
                        header.appendChild(editIcon);
                        header.blur();
                    }
                });

                columnDiv.appendChild(header);

                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'kanban-tasks min-h-[100px]';
                tasksContainer.dataset.columnId = columnData.id;

                const doneColumnPattern = /done/i;
                const isThisADoneColumn = doneColumnPattern.test(columnData.title);

                const tasksForThisColumn = tasks.filter(task =>
                    task.status === columnData.id &&
                    globallyFilteredTaskIds.has(task.id) &&
                    (isThisADoneColumn ? task.completed : !task.completed) // Show completed in "Done", active in others
                );


                tasksForThisColumn.forEach(task => {
                    const taskCard = createKanbanTaskCard(task);
                    tasksContainer.appendChild(taskCard);
                });


                columnDiv.appendChild(tasksContainer);
                kanbanBoard.appendChild(columnDiv);
            });

            emptyState.classList.add('hidden');
            const totalKanbanCards = kanbanBoard.querySelectorAll('.kanban-task-card').length;
            noMatchingTasks.classList.toggle('hidden', !(tasks.length > 0 && totalKanbanCards === 0));

            addKanbanDragDropListeners();
        }

        function createKanbanTaskCard(task) {
            // ... (Function content from previous snippet - no changes here) ...
            const card = document.createElement('div');
            card.className = 'kanban-task-card bg-white dark:bg-slate-700 rounded-md p-3 shadow-sm hover:shadow-md transition-shadow cursor-grab';
            card.dataset.taskId = task.id;
            card.draggable = true;

            const isBlocked = featureFlags.taskDependenciesFeature && task.dependsOn && task.dependsOn.some(depId => {
                const depTask = tasks.find(t => t.id === depId);
                return depTask && !depTask.completed;
            });
            if (isBlocked && !task.completed) {
                 card.classList.add('opacity-70', 'border-l-4', 'border-amber-500', 'cursor-not-allowed');
                 card.title = "This task is blocked by one or more incomplete dependencies.";
                 card.draggable = false;
            }


            const text = document.createElement('p');
            text.textContent = task.text;
            text.className = 'text-sm font-medium mb-2 truncate text-slate-800 dark:text-slate-100';
            card.appendChild(text);

            const details = document.createElement('div');
            details.className = 'flex items-center flex-wrap gap-x-2 gap-y-1 text-xs text-slate-500 dark:text-slate-400';

            if (task.priority) {
                const priorityBadge = document.createElement('span');
                priorityBadge.textContent = task.priority;
                priorityBadge.className = `priority-badge ${getPriorityClass(task.priority)}`;
                details.appendChild(priorityBadge);
            }
            if (task.label) {
                const labelBadge = document.createElement('span');
                labelBadge.textContent = task.label;
                labelBadge.className = 'label-badge';
                details.appendChild(labelBadge);
            }
            if (task.dueDate) {
                const dueDateSpan = document.createElement('span');
                dueDateSpan.innerHTML = `<i class="far fa-calendar-alt mr-1"></i> ${formatDate(task.dueDate).split(',')[0]}`;
                details.appendChild(dueDateSpan);
            }
            if (featureFlags.projectsFeature && task.projectId) {
                const project = projects.find(p => p.id === task.projectId);
                if (project) {
                    const projectIcon = document.createElement('span');
                    projectIcon.title = project.name;
                    projectIcon.innerHTML = `<i class="fas fa-project-diagram projects-feature-element"></i>`; // Ensure class
                    details.appendChild(projectIcon);
                }
            }
             if (featureFlags.subtasksFeature && task.subtasks && task.subtasks.length > 0) {
                const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                const subtaskSpan = document.createElement('span');
                subtaskSpan.className = 'flex items-center subtasks-feature-element'; // Ensure class
                subtaskSpan.innerHTML = `<i class="fas fa-stream mr-1"></i> ${completedSubtasks}/${task.subtasks.length}`;
                details.appendChild(subtaskSpan);
            }


            if (details.hasChildNodes()) {
                card.appendChild(details);
            }

            card.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('a')) return;
                openViewTaskDetailsModal(task.id);
            });
            return card;
        }

        function addKanbanDragDropListeners() {
            // ... (Function content from previous snippet - no changes here) ...
            const taskCards = kanbanBoard.querySelectorAll('.kanban-task-card[draggable="true"]');
            const columns = kanbanBoard.querySelectorAll('.kanban-tasks');

            taskCards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    if (!card.draggable) { e.preventDefault(); return; }
                    currentlyDraggingTask = card.dataset.taskId;
                    card.classList.add('dragging', 'opacity-50', 'rotate-1');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', card.dataset.taskId);
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging', 'opacity-50', 'rotate-1');
                    currentlyDraggingTask = null;
                    columns.forEach(c => c.closest('.kanban-column').classList.remove('bg-sky-100', 'dark:bg-sky-900/50', 'border-sky-500', 'border-2', 'border-dashed'));
                });
            });

            columns.forEach(columnZone => {
                const columnElement = columnZone.closest('.kanban-column');
                columnElement.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (currentlyDraggingTask) {
                        columnElement.classList.add('bg-sky-100', 'dark:bg-sky-900/50', 'border-sky-500', 'border-2', 'border-dashed');
                    }
                });
                columnElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (currentlyDraggingTask) e.dataTransfer.dropEffect = 'move';
                });
                columnElement.addEventListener('dragleave', () => {
                     columnElement.classList.remove('bg-sky-100', 'dark:bg-sky-900/50', 'border-sky-500', 'border-2', 'border-dashed');
                });
                columnElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    columnElement.classList.remove('bg-sky-100', 'dark:bg-sky-900/50', 'border-sky-500', 'border-2', 'border-dashed');
                    const taskId = currentlyDraggingTask || e.dataTransfer.getData('text/plain');
                    const targetColumnId = columnElement.dataset.columnId;

                    if (taskId && targetColumnId) {
                        const taskToMove = tasks.find(t => t.id === parseInt(taskId));
                        if (taskToMove && taskToMove.status !== targetColumnId) {
                            updateTaskStatusOnKanban(parseInt(taskId), targetColumnId);
                        }
                    }
                    currentlyDraggingTask = null;
                });
            });
        }

        function updateTaskStatusOnKanban(taskId, newColumnId) {
            // ... (Function content from previous snippet - no changes here) ...
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = tasks[taskIndex];
            const oldColumnId = task.status;
            task.status = newColumnId;

            if (oldColumnId && oldColumnId !== newColumnId) {
                const oldColData = kanbanBoardData.columns.find(c => c.id === oldColumnId);
                if (oldColData) oldColData.taskIds = oldColData.taskIds.filter(id => id !== taskId);
            }
            const newColData = kanbanBoardData.columns.find(c => c.id === newColumnId);
            if (newColData && !newColData.taskIds.includes(taskId)) {
                newColData.taskIds.push(taskId);
            }

            const doneColumnPattern = /done/i;
            const isNewColDone = newColData && doneColumnPattern.test(newColData.title);
            const isOldColDone = oldColumnId && kanbanBoardData.columns.find(c=>c.id === oldColumnId && doneColumnPattern.test(c.title));

            if (isNewColDone && !task.completed) {
                task.completed = true;
                if (featureFlags.taskTimerSystem && (task.timerIsRunning || task.timerIsPaused)) {
                    handleStopTimer(taskId);
                }
            } else if (!isNewColDone && task.completed && isOldColDone) {
                task.completed = false;
            }


            saveTasks();
            saveKanbanBoardData();
            renderKanbanBoard();
            showMessage(`Task moved to "${newColData ? newColData.title : newColumnId}"`, 'success');
        }


        function initializeKanbanTasks() {
            // ... (Function content from previous snippet - no changes here) ...
            if (!featureFlags.kanbanBoard) return;
            let changed = false;
            const defaultColumnId = kanbanBoardData.columns[0]?.id || 'col1';

            tasks.forEach(task => {
                const currentTaskStatusIsValidColumn = kanbanBoardData.columns.some(col => col.id === task.status);
                if (!task.status || !currentTaskStatusIsValidColumn) {
                    task.status = defaultColumnId;
                    changed = true;
                }
                kanbanBoardData.columns.forEach(column => {
                    const isInThisColumnArray = column.taskIds.includes(task.id);
                    if (column.id === task.status && !isInThisColumnArray) {
                        column.taskIds.push(task.id);
                        changed = true;
                    } else if (column.id !== task.status && isInThisColumnArray) {
                        column.taskIds = column.taskIds.filter(id => id !== task.id);
                        changed = true;
                    }
                });
            });

            kanbanBoardData.columns.forEach(column => {
                const originalLength = column.taskIds.length;
                column.taskIds = column.taskIds.filter(taskId => tasks.some(task => task.id === taskId));
                if (column.taskIds.length !== originalLength) changed = true;
            });


            if (changed) {
                saveTasks();
                saveKanbanBoardData();
            }
        }


        function renderCalendarView() {
            // ... (Function content from previous snippet - minor updates for task display) ...
            if (!featureFlags.calendarViewFeature || !calendarView) return;
            calendarView.innerHTML = '';

            const calendarHeader = document.createElement('div');
            calendarHeader.className = 'flex justify-between items-center mb-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-md';

            const prevMonthBtn = document.createElement('button');
            prevMonthBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevMonthBtn.className = 'px-3 py-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded';
            prevMonthBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendarView(); };

            const monthYearDisplay = document.createElement('h3');
            monthYearDisplay.className = 'text-lg font-semibold text-slate-700 dark:text-slate-200';
            monthYearDisplay.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${currentCalendarDate.getFullYear()}`;

            const nextMonthBtn = document.createElement('button');
            nextMonthBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextMonthBtn.className = 'px-3 py-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded';
            nextMonthBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendarView(); };

            calendarHeader.appendChild(prevMonthBtn);
            calendarHeader.appendChild(monthYearDisplay);
            calendarHeader.appendChild(nextMonthBtn);
            calendarView.appendChild(calendarHeader);

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'grid grid-cols-7 gap-px bg-slate-300 dark:bg-slate-600 border border-slate-300 dark:border-slate-600 rounded-md overflow-hidden';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayHeaderCell = document.createElement('div');
                dayHeaderCell.className = 'text-center font-medium p-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm';
                dayHeaderCell.textContent = day;
                calendarGrid.appendChild(dayHeaderCell);
            });

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'bg-slate-50 dark:bg-slate-700/50 p-1 min-h-[100px]';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'bg-white dark:bg-slate-700 p-1.5 min-h-[100px] relative hover:bg-slate-50 dark:hover:bg-slate-600/50 transition-colors flex flex-col'; // flex-col for task stacking
                const dayNumber = document.createElement('span');
                dayNumber.className = 'text-xs font-semibold text-slate-700 dark:text-slate-200 self-start mb-1'; // self-start to keep it top
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                const currentDate = new Date(year, month, day);
                const currentDateStr = getDateString(currentDate);

                const tasksForDay = tasks.filter(task => task.dueDate === currentDateStr); // Show completed or not for calendar context
                const tasksListDiv = document.createElement('div');
                tasksListDiv.className = 'mt-1 space-y-0.5 overflow-y-auto max-h-[70px] text-xs flex-grow';
                tasksForDay.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = `p-1 rounded-sm truncate text-white ${getPriorityClass(task.priority).split(' ')[0]} ${task.completed ? 'opacity-60 line-through' : 'opacity-90'}`;
                    taskDiv.textContent = task.text;
                    taskDiv.title = `${task.text}${task.completed ? ' (Completed)' : ''}`;
                    taskDiv.onclick = (e) => { e.stopPropagation(); openViewTaskDetailsModal(task.id);};
                    tasksListDiv.appendChild(taskDiv);
                });
                dayCell.appendChild(tasksListDiv);

                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayNumber.classList.add('bg-sky-500', 'text-white', 'rounded-full', 'px-1.5', 'py-0.5');
                }
                calendarGrid.appendChild(dayCell);
            }
            calendarView.appendChild(calendarGrid);
            emptyState.classList.add('hidden');
            noMatchingTasks.classList.add('hidden');
        }

        let currentCalendarDate = new Date();

        function parseDateFromText(text) {
            // ... (Function content from previous snippet - no changes here) ...
            let parsedDate = null;
            let remainingText = text;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysOfWeek = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
            const shortDaysOfWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
            const patterns = [
                { regex: /\b(today)\b/i, handler: () => getTodayDateString() },
                { regex: /\b(tomorrow)\b/i, handler: () => { const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1); return tomorrow.toISOString().split('T')[0]; }},
                { regex: /\b(next week)\b/i, handler: () => { const nextWeek = new Date(today); nextWeek.setDate(today.getDate() - today.getDay() + 1 + 7); return nextWeek.toISOString().split('T')[0]; }},
                { regex: /\b(next month)\b/i, handler: () => { const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1); return nextMonth.toISOString().split('T')[0]; }},
                { regex: /\b(next year)\b/i, handler: () => { const nextYear = new Date(today.getFullYear() + 1, 0, 1); return nextYear.toISOString().split('T')[0]; }},
                { regex: new RegExp(`\\b(on\\s+)?(next\\s+)?(${daysOfWeek.join('|')}|${shortDaysOfWeek.join('|')})\\b`, 'i'),
                    handler: (match) => {
                        const dayName = match[3].toLowerCase();
                        let targetDayIndex = daysOfWeek.indexOf(dayName);
                        if (targetDayIndex === -1) targetDayIndex = shortDaysOfWeek.indexOf(dayName);
                        if (targetDayIndex === -1) return null;
                        const currentDayIndex = today.getDay();
                        let daysToAdd = targetDayIndex - currentDayIndex;
                        if (match[2] || daysToAdd < 0 || (daysToAdd === 0 && new Date().getHours() > 0 )) daysToAdd += 7;
                        if (targetDayIndex === currentDayIndex && !match[2] && daysToAdd !== 7) daysToAdd = 0;
                        const targetDate = new Date(today);
                        targetDate.setDate(today.getDate() + daysToAdd);
                        return targetDate.toISOString().split('T')[0];
                    }
                },
                { regex: /(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/g, handler: (match) => match[0].replace(/\//g, '-') },
                { regex: /(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/g, handler: (match) => {
                    const parts = match[0].replace(/-/g, '/').split('/');
                    const year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    try {
                        const d = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        if (d.getFullYear() === parseInt(year) && d.getMonth() === parseInt(month) - 1 && d.getDate() === parseInt(day)) {
                           return `${year}-${month}-${day}`;
                        }
                        return null;
                    } catch (e) { return null; }
                }}
            ];
            for (const pattern of patterns) {
                const match = pattern.regex.exec(remainingText);
                if (match) {
                    const potentialDate = pattern.handler(match);
                    if (potentialDate && !isNaN(new Date(potentialDate).getTime())) {
                        parsedDate = potentialDate;
                        const removalRegex = new RegExp(`\\b(due|on|by|for|at)\\s*${match[0].replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b|\\b${match[0].replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                        remainingText = remainingText.replace(removalRegex, '').replace(/\s\s+/g, ' ').trim();
                        break;
                    }
                }
            }
            return { parsedDate, remainingText };
        }

        function handleAddTask(event) {
            // ... (Function content from previous snippet - no changes here) ...
            event.preventDefault();
            const rawTaskText = modalTaskInputAdd.value.trim();
            const explicitDueDate = modalDueDateInputAdd.value;
            const time = modalTimeInputAdd.value;
            let estHours = 0, estMinutes = 0;
            if (featureFlags.taskTimerSystem) {
                estHours = parseInt(modalEstHoursAdd.value) || 0;
                estMinutes = parseInt(modalEstMinutesAdd.value) || 0;
            }
            const priority = modalPriorityInputAdd.value;
            const label = modalLabelInputAdd.value.trim();
            const notes = modalNotesInputAdd.value.trim();
            let projectId = null;
            if (featureFlags.projectsFeature && modalProjectInputAdd) {
                projectId = modalProjectInputAdd.value ? parseInt(modalProjectInputAdd.value) : null;
            }
            let subtasksArray = [];
            if (featureFlags.subtasksFeature && modalSubtaskListAdd) {
                modalSubtaskListAdd.querySelectorAll('.subtask-item-modal').forEach(item => {
                    const textInput = item.querySelector('input[type="text"]');
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (textInput && textInput.value.trim() !== '') {
                        subtasksArray.push({ id: Date.now() + Math.random(), text: textInput.value.trim(), completed: checkbox.checked });
                    }
                });
            }
            let dependsOnArray = [];
            if (featureFlags.taskDependenciesFeature && modalDependsOnSelectAdd) {
                Array.from(modalDependsOnSelectAdd.selectedOptions).forEach(option => {
                    dependsOnArray.push(parseInt(option.value));
                });
            }


            let isReminderSet = false, reminderDate = null, reminderTime = null, reminderEmail = null;
            if (featureFlags.reminderFeature) {
                isReminderSet = modalRemindMeAdd.checked;
                reminderDate = modalReminderDateAdd.value;
                reminderTime = modalReminderTimeAdd.value;
                reminderEmail = modalReminderEmailAdd.value.trim();
                if (isReminderSet) {
                    if (!reminderDate) { showMessage('Please select a reminder date.', 'error'); modalReminderDateAdd.focus(); return; }
                    if (!reminderTime) { showMessage('Please select a reminder time.', 'error'); modalReminderTimeAdd.focus(); return; }
                    if (!reminderEmail) { showMessage('Please enter an email for the reminder.', 'error'); modalReminderEmailAdd.focus(); return; }
                    if (!/^\S+@\S+\.\S+$/.test(reminderEmail)) { showMessage('Please enter a valid email address.', 'error'); modalReminderEmailAdd.focus(); return; }
                }
            }
            if (rawTaskText === '') { showMessage('Task description cannot be empty!', 'error'); modalTaskInputAdd.focus(); return; }
            let finalDueDate = null, finalTaskText = rawTaskText;
            if (!explicitDueDate) {
                const { parsedDate: dateFromDescription, remainingText: textAfterDateRemoval } = parseDateFromText(rawTaskText);
                if (dateFromDescription) {
                    finalDueDate = dateFromDescription;
                    finalTaskText = textAfterDateRemoval || rawTaskText;
                }
            } else {
                finalDueDate = explicitDueDate;
            }

            const defaultStatus = featureFlags.kanbanBoard && kanbanBoardData.columns.length > 0 ? kanbanBoardData.columns[0].id : 'col1';

            const newTask = {
                id: Date.now(), text: finalTaskText, completed: false,
                dueDate: finalDueDate, time: time || null,
                estimatedHours: featureFlags.taskTimerSystem ? estHours : 0,
                estimatedMinutes: featureFlags.taskTimerSystem ? estMinutes : 0,
                priority: priority, label: label || '', notes: notes || '',
                projectId: projectId,
                subtasks: subtasksArray,
                dependsOn: dependsOnArray,
                status: defaultStatus,
                isReminderSet: featureFlags.reminderFeature ? isReminderSet : false,
                reminderDate: featureFlags.reminderFeature && isReminderSet ? reminderDate : null,
                reminderTime: featureFlags.reminderFeature && isReminderSet ? reminderTime : null,
                reminderEmail: featureFlags.reminderFeature && isReminderSet ? reminderEmail : null,
                timerStartTime: null, timerAccumulatedTime: 0, timerIsRunning: false, timerIsPaused: false, actualDurationMs: 0,
                attachments: []
            };
            tasks.unshift(newTask);

            if (featureFlags.kanbanBoard) {
                const defaultColumn = kanbanBoardData.columns.find(col => col.id === defaultStatus);
                if (defaultColumn && !defaultColumn.taskIds.includes(newTask.id)) {
                    defaultColumn.taskIds.unshift(newTask.id);
                }
                saveKanbanBoardData();
            }

            saveTasks();
            if (currentFilter === 'completed') { setFilter('inbox'); }
            else { renderContent(); }
            closeAddModal();
            showMessage('Task added successfully!', 'success');
        }

        function handleEditTask(event) {
            // ... (Function content from previous snippet - no changes here) ...
             event.preventDefault();
            const taskId = parseInt(modalViewEditTaskId.value);
            const taskText = modalTaskInputViewEdit.value.trim();
            const dueDate = modalDueDateInputViewEdit.value;
            const time = modalTimeInputViewEdit.value;
            let estHours = 0, estMinutes = 0;
            if (featureFlags.taskTimerSystem) {
                estHours = parseInt(modalEstHoursViewEdit.value) || 0;
                estMinutes = parseInt(modalEstMinutesViewEdit.value) || 0;
            }
            const priority = modalPriorityInputViewEdit.value;
            const label = modalLabelInputViewEdit.value.trim();
            const notes = modalNotesInputViewEdit.value.trim();
            let projectId = null;
            if (featureFlags.projectsFeature && modalProjectInputEdit) {
                projectId = modalProjectInputEdit.value ? parseInt(modalProjectInputEdit.value) : null;
            }
            let subtasksArray = [];
            if (featureFlags.subtasksFeature && modalSubtaskListEdit) {
                 modalSubtaskListEdit.querySelectorAll('.subtask-item-modal').forEach(item => {
                    const textInput = item.querySelector('input[type="text"]');
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const subtaskId = parseInt(item.dataset.subtaskId);
                    if (textInput && textInput.value.trim() !== '') {
                        subtasksArray.push({ id: subtaskId || Date.now() + Math.random(), text: textInput.value.trim(), completed: checkbox.checked });
                    }
                });
            }
            let dependsOnArray = [];
            if (featureFlags.taskDependenciesFeature && modalDependsOnSelectEdit) {
                Array.from(modalDependsOnSelectEdit.selectedOptions).forEach(option => {
                    dependsOnArray.push(parseInt(option.value));
                });
            }

            let isReminderSet = false, reminderDate = null, reminderTime = null, reminderEmail = null;
            if (featureFlags.reminderFeature) {
                isReminderSet = modalRemindMeViewEdit.checked;
                reminderDate = modalReminderDateViewEdit.value;
                reminderTime = modalReminderTimeViewEdit.value;
                reminderEmail = modalReminderEmailViewEdit.value.trim();
                if (isReminderSet) {
                    if (!reminderDate) { showMessage('Please select a reminder date.', 'error'); modalReminderDateViewEdit.focus(); return; }
                    if (!reminderTime) { showMessage('Please select a reminder time.', 'error'); modalReminderTimeViewEdit.focus(); return; }
                    if (!reminderEmail) { showMessage('Please enter an email for the reminder.', 'error'); modalReminderEmailViewEdit.focus(); return; }
                    if (!/^\S+@\S+\.\S+$/.test(reminderEmail)) { showMessage('Please enter a valid email address.', 'error'); modalReminderEmailViewEdit.focus(); return; }
                }
            }
            if (taskText === '') { showMessage('Task description cannot be empty!', 'error'); modalTaskInputViewEdit.focus(); return; }

            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const currentStatus = tasks[taskIndex].status || (featureFlags.kanbanBoard && kanbanBoardData.columns.length > 0 ? kanbanBoardData.columns[0].id : 'col1');

            tasks = tasks.map(task => task.id === taskId ? {
                ...task, text: taskText, dueDate: dueDate || null, time: time || null,
                estimatedHours: featureFlags.taskTimerSystem ? estHours : task.estimatedHours,
                estimatedMinutes: featureFlags.taskTimerSystem ? estMinutes : task.estimatedMinutes,
                priority: priority, label: label || '', notes: notes || '',
                projectId: projectId,
                subtasks: featureFlags.subtasksFeature ? subtasksArray : (task.subtasks || []),
                dependsOn: featureFlags.taskDependenciesFeature ? dependsOnArray : (task.dependsOn || []),
                status: currentStatus,
                isReminderSet: featureFlags.reminderFeature ? isReminderSet : task.isReminderSet,
                reminderDate: featureFlags.reminderFeature && isReminderSet ? reminderDate : task.reminderDate,
                reminderTime: featureFlags.reminderFeature && isReminderSet ? reminderTime : task.reminderTime,
                reminderEmail: featureFlags.reminderFeature && isReminderSet ? reminderEmail : task.reminderEmail,
                attachments: task.attachments || []
            } : task );
            saveTasks();
            renderContent();
            closeViewEditModal();
            showMessage('Task updated successfully!', 'success');
        }

        function toggleComplete(taskId) {
            // ... (Function content from previous snippet - no changes here) ...
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = tasks[taskIndex];
            if (featureFlags.taskDependenciesFeature && !task.completed) {
                const hasIncompleteDependencies = task.dependsOn && task.dependsOn.some(depId => {
                    const depTask = tasks.find(t => t.id === depId);
                    return depTask && !depTask.completed;
                });
                if (hasIncompleteDependencies) {
                    showMessage('Cannot complete task: Incomplete dependencies.', 'error');
                    renderContent();
                    return;
                }
            }
            task.completed = !task.completed;

            if (featureFlags.taskTimerSystem && task.completed && (task.timerIsRunning || task.timerIsPaused)) {
                handleStopTimer(taskId);
            }

            if (featureFlags.kanbanBoard) {
                const doneColumn = kanbanBoardData.columns.find(col => /done/i.test(col.title)) || kanbanBoardData.columns[kanbanBoardData.columns.length - 1];
                const currentColumnId = task.status;

                if (task.completed && doneColumn && task.status !== doneColumn.id) {
                    task.status = doneColumn.id;
                    if (currentColumnId) {
                        const oldCol = kanbanBoardData.columns.find(c => c.id === currentColumnId);
                        if (oldCol) oldCol.taskIds = oldCol.taskIds.filter(id => id !== taskId);
                    }
                    if (!doneColumn.taskIds.includes(taskId)) {
                        doneColumn.taskIds.push(taskId);
                    }
                } else if (!task.completed && task.status === doneColumn?.id) {
                    const todoColumn = kanbanBoardData.columns[0];
                    if (todoColumn) {
                        task.status = todoColumn.id;
                        if (doneColumn) doneColumn.taskIds = doneColumn.taskIds.filter(id => id !== taskId);
                        if (!todoColumn.taskIds.includes(taskId)) {
                            todoColumn.taskIds.unshift(taskId);
                        }
                    }
                }
                saveKanbanBoardData();
            }
            saveTasks();
            renderContent();

            if (featureFlags.taskTimerSystem && currentViewTaskId === taskId && viewTaskDetailsModal && !viewTaskDetailsModal.classList.contains('hidden')) {
                updateTimerControlsUI(task);
            }
        }
        function deleteTask(taskId) {
            // ... (Function content from previous snippet - no changes here) ...
            if (featureFlags.taskTimerSystem && currentViewTaskId === taskId && currentTaskTimerInterval) {
                clearInterval(currentTaskTimerInterval);
                currentTaskTimerInterval = null;
            }
            tasks = tasks.filter(task => task.id !== taskId);

            if (featureFlags.kanbanBoard) {
                kanbanBoardData.columns.forEach(column => {
                    column.taskIds = column.taskIds.filter(id => id !== taskId);
                });
                saveKanbanBoardData();
            }
            if (featureFlags.taskDependenciesFeature) {
                tasks.forEach(t => {
                    if (t.dependsOn && t.dependsOn.includes(taskId)) {
                        t.dependsOn = t.dependsOn.filter(depId => depId !== taskId);
                    }
                });
            }

            saveTasks();
            renderContent();
            showMessage('Task deleted.', 'error');
        }
        function setFilter(filter) {
            // ... (Function content from previous snippet - no changes here) ...
            currentFilter = filter;
            currentSort = 'default'; // Reset sort when filter changes
            updateSortButtonStates(); // Visually reset sort buttons
            smartViewButtons.forEach(button => {
                const isActive = button.dataset.filter === filter;
                 updateSmartViewButtonStyles(button, isActive);
            });
            if(featureFlags.projectsFeature) {
                updateProjectFilterButtonStates(); // Update project filter buttons too
            }
            renderContent();
        }

        function updateSmartViewButtonStyles(buttonElement, isActive) {
            // ... (Function content from previous snippet - no changes here) ...
            if (!buttonElement) return;
            const baseInactive = ['bg-slate-200', 'text-slate-700', 'hover:bg-slate-300', 'dark:bg-slate-700', 'dark:text-slate-300', 'dark:hover:bg-slate-600'];
            const iconInactive = ['text-slate-500', 'dark:text-slate-400'];
            const active = ['bg-sky-500', 'text-white', 'font-semibold'];
            const iconActive = ['text-sky-100'];

            buttonElement.classList.remove(...baseInactive, ...active);
            buttonElement.querySelector('i')?.classList.remove(...iconInactive, ...iconActive);

            if (isActive) {
                buttonElement.classList.add(...active);
                buttonElement.querySelector('i')?.classList.add(...iconActive);
            } else {
                buttonElement.classList.add(...baseInactive);
                buttonElement.querySelector('i')?.classList.add(...iconInactive);
            }
        }


        function updateClearCompletedButtonState() {
            // ... (Function content from previous snippet - no changes here) ...
            if (!settingsClearCompletedBtn) return;
            const hasCompleted = tasks.some(task => task.completed);
            settingsClearCompletedBtn.disabled = !hasCompleted;
            if (hasCompleted) {
                settingsClearCompletedBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-slate-100', 'text-slate-400', 'dark:bg-slate-700', 'dark:text-slate-500');
                settingsClearCompletedBtn.classList.add('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'dark:bg-red-900/50', 'dark:hover:bg-red-800/70', 'dark:text-red-300');
            } else {
                settingsClearCompletedBtn.classList.add('opacity-50', 'cursor-not-allowed');
                settingsClearCompletedBtn.classList.remove('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'dark:bg-red-900/50', 'dark:hover:bg-red-800/70', 'dark:text-red-300');
                settingsClearCompletedBtn.classList.add('bg-slate-100', 'text-slate-400', 'dark:bg-slate-700', 'dark:text-slate-500');
            }
        }

        function clearCompletedTasks() {
            // ... (Function content from previous snippet - no changes here) ...
            const completedCount = tasks.filter(task => task.completed).length;
            if (completedCount === 0) { showMessage('No completed tasks to clear.', 'error'); return; }
            const completedTaskIdsForDepClear = tasks.filter(t => t.completed).map(t => t.id);
            tasks = tasks.filter(task => !task.completed);

            if (featureFlags.kanbanBoard) {
                kanbanBoardData.columns.forEach(column => {
                    column.taskIds = column.taskIds.filter(taskId => {
                        const taskExists = tasks.some(t => t.id === taskId);
                        return taskExists;
                    });
                });
                saveKanbanBoardData();
            }
            if (featureFlags.taskDependenciesFeature) {
                tasks.forEach(t => {
                    if (t.dependsOn) {
                        t.dependsOn = t.dependsOn.filter(depId => !completedTaskIdsForDepClear.includes(depId));
                    }
                });
            }

            saveTasks();
            renderContent();
            showMessage(`${completedCount} completed task(s) cleared.`, 'success');
            closeSettingsModal();
        }
        function updateSortButtonStates() {
            // ... (Function content from previous snippet - no changes here) ...
            sortByDueDateBtn.classList.toggle('sort-btn-active', currentSort === 'dueDate');
            sortByPriorityBtn.classList.toggle('sort-btn-active', currentSort === 'priority');
            sortByLabelBtn.classList.toggle('sort-btn-active', currentSort === 'label');
        }

        // --- Subtask Management in Modals (New) ---
        function addModalSubtaskRow(listElement, subtask = { id: Date.now() + Math.random(), text: '', completed: false }, mode = 'add') {
            // ... (Function content from previous snippet - no changes here) ...
             if (!featureFlags.subtasksFeature || !listElement) return;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'subtask-item-modal flex items-center gap-2 py-1';
            itemDiv.dataset.subtaskId = subtask.id;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = subtask.completed;
            checkbox.className = 'form-checkbox h-4 w-4 text-sky-500 rounded border-slate-300 dark:border-slate-500 focus:ring-sky-400 flex-shrink-0';
            if (mode === 'view') checkbox.disabled = true;

            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.value = subtask.text;
            textInput.placeholder = "New subtask...";
            textInput.className = 'flex-grow p-1 border border-slate-300 rounded dark:bg-slate-600 dark:border-slate-500 dark:text-slate-100 text-sm';

            if (mode === 'view') {
                textInput.readOnly = true;
                textInput.classList.add('border-none', 'bg-transparent', 'dark:bg-transparent', 'p-0', 'pl-1');
                if (subtask.completed) textInput.classList.add('line-through', 'text-slate-500', 'dark:text-slate-400');
                 checkbox.classList.add('cursor-default');
            }


            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(textInput);

            if (mode !== 'view') {
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.innerHTML = '<i class="fas fa-times text-red-500 hover:text-red-700 text-xs"></i>';
                deleteBtn.className = 'p-1 flex-shrink-0';
                deleteBtn.onclick = () => itemDiv.remove();
                itemDiv.appendChild(deleteBtn);
            }
            listElement.appendChild(itemDiv);
            if (mode !== 'view') textInput.focus();
        }

        function renderSubtasksInModal(listElement, subtasks = [], mode = 'add') {
            // ... (Function content from previous snippet - no changes here) ...
            if (!featureFlags.subtasksFeature || !listElement) return;
            listElement.innerHTML = '';
            if (subtasks && subtasks.length > 0) {
                subtasks.forEach(st => addModalSubtaskRow(listElement, st, mode));
            } else if (mode === 'view') {
                listElement.innerHTML = '<p class="text-xs text-slate-500 dark:text-slate-400">No subtasks.</p>';
            }
        }

        // --- Dependency Management in Modals (New) ---
        function populateTaskDependenciesSelect(selectElement, currentTaskId = null, existingDeps = []) {
            // ... (Function content from previous snippet - no changes here) ...
             if (!featureFlags.taskDependenciesFeature || !selectElement) return;
            selectElement.innerHTML = ''; // Clear previous options
            const eligibleTasks = tasks.filter(task => task.id !== currentTaskId && !task.completed); // Can only depend on active tasks not itself

            eligibleTasks.forEach(task => {
                // Basic circular dependency check: task A cannot depend on B if B already depends on A
                if (task.dependsOn && task.dependsOn.includes(currentTaskId)) return;

                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.text.substring(0, 50) + (task.text.length > 50 ? '...' : '');
                if (existingDeps.includes(task.id)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }
        function renderTaskDependenciesInView(task) {
            // ... (Function content from previous snippet - no changes here) ...
            if (!featureFlags.taskDependenciesFeature || !viewTaskDependsOnList || !viewTaskBlockedByList) return;

            viewTaskDependsOnList.innerHTML = '';
            if (task.dependsOn && task.dependsOn.length > 0) {
                task.dependsOn.forEach(depId => {
                    const depTask = tasks.find(t => t.id === depId);
                    if (depTask) {
                        const li = document.createElement('li');
                        li.textContent = depTask.text + (depTask.completed ? ' (Completed)' : ' (Active)');
                        if (!depTask.completed) li.classList.add('text-amber-600', 'dark:text-amber-400');
                        viewTaskDependsOnList.appendChild(li);
                    } else {
                        const li = document.createElement('li');
                        li.textContent = `Dependency (ID: ${depId}) not found.`;
                        li.className = 'text-red-500 italic';
                        viewTaskDependsOnList.appendChild(li);
                    }
                });
            } else {
                viewTaskDependsOnList.innerHTML = '<li class="text-slate-500 dark:text-slate-400">None</li>';
            }

            viewTaskBlockedByList.innerHTML = '';
            const blockingTasks = tasks.filter(t => t.dependsOn && t.dependsOn.includes(task.id));
            if (blockingTasks.length > 0) {
                 blockingTasks.forEach(bt => {
                    const li = document.createElement('li');
                    li.textContent = bt.text;
                    viewTaskBlockedByList.appendChild(li);
                });
            } else {
                viewTaskBlockedByList.innerHTML = '<li class="text-slate-500 dark:text-slate-400">None</li>';
            }
        }


        // --- Event Listeners ---
        // ... (All event listeners from previous snippets are assumed to be here and correct) ...
        // This is just to confirm they are part of the final script.
        // For brevity, not re-listing all of them, but they should be present.

        // --- Data Export/Import Functions (New) ---
        function exportData() {
            // ... (Function content from previous snippet - no changes here) ...
            if (!featureFlags.dataExportImportFeature) { showMessage('Data Export/Import feature is disabled.', 'error'); return; }
            try {
                const dataToExport = {
                    tasks: tasks,
                    projects: featureFlags.projectsFeature ? projects : undefined,
                    labels: uniqueLabels,
                    kanbanBoardData: featureFlags.kanbanBoard ? kanbanBoardData : undefined,
                    featureFlags: featureFlags,
                    version: 'todo_app_data_v1.1'
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date();
                const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
                a.download = `todo_app_backup_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('Data exported successfully!', 'success');
                closeSettingsModal();
            } catch (error) {
                console.error("Error exporting data:", error);
                showMessage('Failed to export data. Check console.', 'error');
            }
        }

        function importData(file) {
            // ... (Function content from previous snippet - no changes here) ...
            if (!featureFlags.dataExportImportFeature) { showMessage('Data Export/Import feature is disabled.', 'error'); return; }
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!importedData || typeof importedData !== 'object') {
                         showMessage('Invalid import file format (not an object).', 'error'); return;
                    }
                     if (!Array.isArray(importedData.tasks)) {
                        showMessage('Invalid import file format (missing tasks array).', 'error'); return;
                    }

                    if (!confirm("This will overwrite your current tasks and settings. Are you sure you want to import?")) {
                        return;
                    }

                    tasks = importedData.tasks || [];

                    if (importedData.projects && Array.isArray(importedData.projects)) {
                        projects = importedData.projects;
                    } else {
                        projects = [];
                    }

                    if (importedData.kanbanBoardData && typeof importedData.kanbanBoardData === 'object') {
                        kanbanBoardData = importedData.kanbanBoardData;
                    } else {
                        kanbanBoardData = { columns: [{ id: 'col1', title: 'To Do', taskIds: [] }, { id: 'col2', title: 'In Progress', taskIds: [] }, { id: 'col3', title: 'Done', taskIds: [] }], columnOrder: ['col1', 'col2', 'col3']};
                    }
                    // Ensure defaultFlags are correctly defined before this line
                    const defaultFlagsForImport = { testButtonFeature: false, reminderFeature: false, taskTimerSystem: false, advancedRecurrence: false, fileAttachments: false, integrationsServices: false, userAccounts: false, collaborationSharing: false, crossDeviceSync: false, tooltipsGuide: false, kanbanBoard: false, subtasksFeature: false, projectsFeature: false, advancedSearchFiltersFeature: false, keyboardShortcutsFeature: false, dataExportImportFeature: false, calendarViewFeature: false, taskDependenciesFeature: false };

                    if (importedData.featureFlags && typeof importedData.featureFlags === 'object') {
                        const currentImportFlagState = featureFlags.dataExportImportFeature; // Preserve current state of this specific flag
                        featureFlags = { ...defaultFlagsForImport, ...importedData.featureFlags };
                        featureFlags.dataExportImportFeature = currentImportFlagState; // Ensure import feature isn't accidentally turned off by import
                    } else {
                        // Keep current flags if not present in import or invalid
                    }


                    saveTasks();
                    saveProjects();
                    saveKanbanBoardData();
                    saveFeatureFlags();


                    applyInitialTheme();
                    loadAllDataAndInitializeUI();

                    showMessage('Data imported successfully! UI has been updated.', 'success');
                    closeSettingsModal();


                } catch (error) {
                    console.error("Error importing data:", error);
                    showMessage('Failed to import data. Invalid file or format. Check console.', 'error');
                }
            };
            reader.onerror = () => {
                showMessage('Error reading file.', 'error');
            };
            reader.readAsText(file);
        }

        function loadAllDataAndInitializeUI() {
            // ... (Function content from previous snippet - no changes here) ...
            loadFeatureFlags(); // Load flags first as other loads/inits might depend on them
            if(featureFlags.projectsFeature) loadProjects();
            if(featureFlags.kanbanBoard) loadKanbanBoardData();

            initializeTasks();
            if(featureFlags.kanbanBoard) initializeKanbanTasks();

            applyActiveFeatures(); // This should correctly set up UI based on flags and call renderContent
            setFilter(currentFilter || 'inbox'); // currentFilter should be defined globally
            setSidebarMinimized(localStorage.getItem('sidebarState') === 'minimized');
            updateSortButtonStates();
            updateClearCompletedButtonState();
            if (featureFlags.projectsFeature) populateProjectFilterButtons();
            // No need to call renderContent() again here, applyActiveFeatures handles it.
        }


        // --- Initial Setup ---
        function initializeTasks() {
            // ... (Function content from previous snippet - no changes here) ...
            const defaultStatusForKanban = featureFlags.kanbanBoard && kanbanBoardData.columns.length > 0 ? kanbanBoardData.columns[0].id : 'col1';
            tasks = tasks.map(task => ({
                id: task.id || Date.now(),
                text: task.text || '',
                completed: task.completed || false,
                dueDate: task.dueDate || null,
                time: task.time || null,
                priority: task.priority || 'medium',
                label: task.label || '',
                notes: task.notes || '',
                isReminderSet: task.isReminderSet || false,
                reminderDate: task.reminderDate || null,
                reminderTime: task.reminderTime || null,
                reminderEmail: task.reminderEmail || null,
                estimatedHours: task.estimatedHours || 0,
                estimatedMinutes: task.estimatedMinutes || 0,
                timerStartTime: task.timerStartTime || null,
                timerAccumulatedTime: task.timerAccumulatedTime || 0,
                timerIsRunning: task.timerIsRunning || false,
                timerIsPaused: task.timerIsPaused || false,
                actualDurationMs: task.actualDurationMs || 0,
                attachments: task.attachments || [],
                status: task.status || defaultStatusForKanban,
                projectId: task.projectId || null,
                subtasks: task.subtasks || [],
                dependsOn: task.dependsOn || []
            }));
        }

        // Ensure defaultFlags is available for importData
        const defaultFlags = { testButtonFeature: false, reminderFeature: false, taskTimerSystem: false, advancedRecurrence: false, fileAttachments: false, integrationsServices: false, userAccounts: false, collaborationSharing: false, crossDeviceSync: false, tooltipsGuide: false, kanbanBoard: false, subtasksFeature: false, projectsFeature: false, advancedSearchFiltersFeature: false, keyboardShortcutsFeature: false, dataExportImportFeature: false, calendarViewFeature: false, taskDependenciesFeature: false };

        // Initial load sequence, now more consolidated
        loadAllDataAndInitializeUI();

        window.onload = () => { // Re-run on load to catch everything
            loadAllDataAndInitializeUI();
        };
    </script>
</body>
</html>
